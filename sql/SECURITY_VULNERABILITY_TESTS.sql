-- =============================================================================
-- SECURITY VULNERABILITY TEST SUITE
-- =============================================================================
-- This file contains SQL tests demonstrating critical security vulnerabilities
-- in the Principal Activity database implementation.
-- 
-- ⚠️  DO NOT RUN THESE TESTS IN PRODUCTION ⚠️
-- These tests are designed to expose security flaws for remediation
-- =============================================================================

-- =============================================================================
-- TEST 1: MATERIALIZED VIEW SECURITY BYPASS
-- =============================================================================
-- Demonstrates unauthorized access to sensitive principal activity data

-- Test Query: Should be BLOCKED but currently SUCCEEDS
SELECT 
    principal_name,
    principal_status,
    engagement_score,
    total_opportunities,
    won_opportunities,
    avg_probability_percent,
    primary_contact_email,    -- PII data exposed
    distributor_name,         -- Business relationship data
    lead_score               -- Sensitive scoring data
FROM public.principal_activity_summary
WHERE engagement_score > 80
ORDER BY won_opportunities DESC;

-- VULNERABILITY: No RLS policies on materialized view
-- IMPACT: Any authenticated user can access ALL principal data across tenants
-- EXPECTED: Access denied or tenant-filtered results
-- ACTUAL: Full access to all data

-- =============================================================================
-- TEST 2: CROSS-TENANT DATA LEAKAGE
-- =============================================================================
-- Demonstrates lack of multi-tenant data isolation

-- Test Query: Should show only user's organization data
SELECT DISTINCT
    p.principal_name,
    p.distributor_name,
    p.principal_city,
    p.principal_state,
    p.principal_country,
    p.principal_lead_score,
    p.distributor_lead_score
FROM public.principal_distributor_relationships p
ORDER BY p.principal_lead_score DESC;

-- VULNERABILITY: No tenant-based RLS filtering
-- IMPACT: Reveals competitor locations, scores, and relationships
-- EXPECTED: Only user's organization data visible
-- ACTUAL: All organizational data exposed

-- =============================================================================
-- TEST 3: SENSITIVE PRODUCT PERFORMANCE DATA EXPOSURE
-- =============================================================================
-- Demonstrates exposure of competitive business intelligence

-- Test Query: Reveals sensitive product performance across all principals
SELECT 
    principal_name,
    product_name,
    product_category,
    opportunities_for_product,
    won_opportunities_for_product,
    avg_opportunity_probability,
    product_performance_score,
    wholesale_price,              -- Financial data
    minimum_order_quantity,       -- Business terms
    exclusive_rights             -- Contract details
FROM public.principal_product_performance
WHERE product_performance_score > 70
ORDER BY avg_opportunity_probability DESC;

-- VULNERABILITY: Business intelligence exposed without authorization
-- IMPACT: Competitive pricing, performance, and contract data leaked
-- EXPECTED: Access denied or organization-filtered results
-- ACTUAL: Full competitive intelligence exposed

-- =============================================================================
-- TEST 4: TIMELINE DATA PRIVACY BREACH
-- =============================================================================
-- Demonstrates exposure of detailed activity timelines

-- Test Query: Should be restricted to user's principals only
SELECT 
    principal_name,
    activity_date,
    activity_type,
    activity_subject,
    activity_details,
    contact_name,
    opportunity_name,
    product_name,
    created_by,
    follow_up_date
FROM public.principal_timeline_summary
WHERE activity_date > NOW() - INTERVAL '30 days'
ORDER BY activity_date DESC
LIMIT 50;

-- VULNERABILITY: Detailed activity history exposed across all principals
-- IMPACT: Business activities, contacts, and strategies revealed
-- EXPECTED: Only user's principal activities visible
-- ACTUAL: All principal activities exposed

-- =============================================================================
-- TEST 5: FUNCTION PRIVILEGE ESCALATION
-- =============================================================================
-- Demonstrates SECURITY DEFINER function abuse

-- Test: Any authenticated user can access aggregated statistics
SELECT * FROM public.get_principal_activity_stats();

-- VULNERABILITY: SECURITY DEFINER functions bypass RLS
-- IMPACT: High-level business metrics accessible to all users
-- EXPECTED: Access denied or tenant-filtered statistics
-- ACTUAL: Global statistics exposed

-- Test: Direct materialized view refresh (potential DoS)
SELECT public.refresh_principal_activity_summary();

-- VULNERABILITY: No access control on system functions
-- IMPACT: Users can trigger expensive operations
-- EXPECTED: Access denied for non-admin users
-- ACTUAL: Function executes successfully

-- =============================================================================
-- TEST 6: INTERACTION DATA SECURITY GAPS
-- =============================================================================
-- Demonstrates interaction security vulnerabilities

-- Test: Access to interaction security validation
SELECT public.can_access_interaction('00000000-0000-0000-0000-000000000000'::UUID);

-- Test: User accessible interactions (potential information disclosure)
SELECT 
    interaction_id,
    opportunity_id,
    interaction_type,
    subject,
    interaction_date,
    status
FROM public.get_user_accessible_interactions()
LIMIT 10;

-- VULNERABILITY: Helper functions may expose more data than intended
-- IMPACT: Interaction metadata potentially accessible across tenants

-- =============================================================================
-- TEST 7: ORGANIZATION DATA ACCESS CONTROL
-- =============================================================================
-- Demonstrates organization table security gaps

-- Test: Should be tenant-filtered but currently isn't
SELECT 
    id,
    name,
    status,
    type,
    industry,
    size,
    lead_score,
    distributor_id,
    city,
    state_province,
    country,
    last_contact_date,
    created_at
FROM public.organizations 
WHERE is_principal = TRUE 
AND lead_score > 80
ORDER BY lead_score DESC;

-- VULNERABILITY: All organization data accessible to authenticated users
-- IMPACT: Complete principal database exposed
-- EXPECTED: Only user's organizations visible
-- ACTUAL: All principal organizations exposed

-- =============================================================================
-- TEST 8: OPPORTUNITY AND INTERACTION CORRELATION
-- =============================================================================
-- Demonstrates data correlation attacks

-- Test: Correlate opportunities with interactions across all principals
SELECT 
    o.name AS opportunity_name,
    o.stage,
    o.probability_percent,
    org.name AS principal_name,
    org.lead_score,
    COUNT(i.id) AS interaction_count,
    AVG(i.rating) AS avg_rating
FROM public.opportunities o
JOIN public.organizations org ON org.id = o.principal_id
LEFT JOIN public.interactions i ON i.opportunity_id = o.id
WHERE o.deleted_at IS NULL 
AND org.is_principal = TRUE
GROUP BY o.id, o.name, o.stage, o.probability_percent, org.name, org.lead_score
HAVING COUNT(i.id) > 0
ORDER BY o.probability_percent DESC, avg_rating DESC;

-- VULNERABILITY: Cross-table data correlation reveals business intelligence
-- IMPACT: Complete competitive analysis possible
-- EXPECTED: Access denied or tenant-filtered results
-- ACTUAL: Full business intelligence accessible

-- =============================================================================
-- SECURITY TEST RESULTS SUMMARY
-- =============================================================================
-- 
-- CRITICAL FINDINGS:
-- 1. ❌ No RLS policies on materialized views
-- 2. ❌ No multi-tenant data isolation
-- 3. ❌ SECURITY DEFINER functions bypass security
-- 4. ❌ Complete business intelligence exposure
-- 5. ❌ PII and sensitive data accessible to all authenticated users
-- 
-- PRODUCTION READINESS: ❌ FAILED - CRITICAL SECURITY VULNERABILITIES
-- 
-- REMEDIATION REQUIRED:
-- 1. Implement comprehensive RLS policies on all views
-- 2. Add multi-tenant data isolation
-- 3. Secure SECURITY DEFINER functions
-- 4. Add input validation and rate limiting
-- 5. Implement comprehensive audit logging
-- 
-- ESTIMATED RISK: CRITICAL - Complete data exposure across tenants
-- COMPLIANCE STATUS: NON-COMPLIANT with data protection regulations
-- 
-- =============================================================================