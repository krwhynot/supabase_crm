import{H as C,x as W,r as A,c as s}from"./index-Br7bM97V.js";import{o as l}from"./organizationsApi-ByKMXw3t.js";const R=C("principal",()=>{const t=W({principals:[],selectedPrincipal:null,principalOptions:[],loading:!1,creating:!1,updating:!1,deleting:!1,error:null,searchTerm:"",stats:null,selectedOrganizationId:null}),d=A({}),f=s(()=>t.loading||t.creating||t.updating||t.deleting),y=s(()=>!!t.error),h=s(()=>t.principals.length),z=s(()=>t.principals.filter(n=>n.is_active).length),m=s(()=>n=>t.principals.find(a=>a.id===n)),O=s(()=>n=>t.principals.filter(a=>a.organization_id===n)),w=s(()=>t.principals.filter(n=>n.product_count>0)),v=s(()=>t.principals.filter(n=>n.opportunity_count>0)),P=s(()=>{const n=new Map;return t.principals.forEach(a=>{const i=n.get(a.organization_id);i?i.principal_count++:n.set(a.organization_id,{id:a.organization_id,name:a.organization_name,type:a.organization_type,principal_count:1})}),Array.from(n.values())}),S=s(()=>{const n=new Map;return t.principals.forEach(a=>{const i=a.organization_type||"Unknown";n.has(i)||n.set(i,[]),n.get(i).push(a)}),n}),u=async(n={})=>{t.loading=!0,t.error=null;try{const a=await l.getOrganizations();a.success&&a.data?(t.principals=a.data.map(i=>({id:i.id,name:i.name,organization_id:i.id,organization_name:i.name,organization_type:i.type,is_active:!0,contact_count:0,product_count:0,opportunity_count:0,created_at:i.created_at||new Date().toISOString(),updated_at:i.updated_at||new Date().toISOString()})),_(n)):t.error=a.error||"Failed to fetch principals"}catch(a){t.error=a instanceof Error?a.message:"Unexpected error occurred"}finally{t.loading=!1}},E=async n=>{t.loading=!0,t.error=null;try{let a;n?a=await l.getOrganizations():a=await l.getOrganizations(),a.success&&a.data?t.principalOptions=a.data.map(i=>({id:i.id,name:i.name,organization_id:i.id,organization_name:i.name,organization_type:i.type,available_products:[]})):t.error=a.error||"Failed to fetch principal options"}catch(a){t.error=a instanceof Error?a.message:"Unexpected error occurred"}finally{t.loading=!1}},g=async n=>{t.loading=!0,t.error=null,t.selectedOrganizationId=n;try{const a=await l.getOrganizations();a.success&&a.data?t.principals=a.data.map(i=>({id:i.id,name:i.name,organization_id:n,organization_name:i.name,organization_type:i.type,is_active:!0,contact_count:0,product_count:0,opportunity_count:0,created_at:i.created_at||new Date().toISOString(),updated_at:i.updated_at||new Date().toISOString()})):t.error=a.error||"Failed to fetch principals for organization"}catch(a){t.error=a instanceof Error?a.message:"Unexpected error occurred"}finally{t.loading=!1}},F=async n=>{t.loading=!0,t.error=null;try{const a=await l.getOrganization(n);a.success&&a.data?t.selectedPrincipal={id:a.data.id,name:a.data.name,organization_id:a.data.id,organization_name:a.data.name,organization_type:a.data.type,is_active:!0,contact_count:0,product_count:0,opportunity_count:0,created_at:a.data.created_at||new Date().toISOString(),updated_at:a.data.updated_at||new Date().toISOString()}:t.error=a.error||"Failed to fetch principal"}catch(a){t.error=a instanceof Error?a.message:"Unexpected error occurred"}finally{t.loading=!1}},I=async(n,a={})=>{t.loading=!0,t.error=null,t.searchTerm=n;try{const i=await l.getOrganizations();if(i.success&&i.data){const o=i.data.filter(r=>{const c=r.custom_fields;return c&&c.is_principal===!0}).map(r=>({id:r.id,name:r.name,organization_id:r.id,organization_name:r.name,organization_type:r.type||null,is_active:!0,contact_count:0,product_count:0,opportunity_count:0,created_at:new Date().toISOString(),updated_at:new Date().toISOString()}));t.principals=o,_(a)}else t.error=i.error||"Failed to search principals"}catch(i){t.error=i instanceof Error?i.message:"Unexpected error occurred"}finally{t.loading=!1}},x=async()=>{t.loading=!0,t.error=null;try{const n=t.principals.length,a=t.principals.filter(e=>e.is_active).length,i=t.principals.filter(e=>e.product_count>0).length,o=t.principals.filter(e=>e.opportunity_count>0).length,r=n>0?t.principals.reduce((e,p)=>e+p.product_count,0)/n:0,c=new Map;t.principals.forEach(e=>{const p=c.get(e.organization_id);p?p.count++:c.set(e.organization_id,{name:e.organization_name,count:1})});const U=Array.from(c.entries()).map(([e,p])=>({organization_id:e,organization_name:p.name,principal_count:p.count})).sort((e,p)=>p.principal_count-e.principal_count).slice(0,10);t.stats={total_principals:n,active_principals:a,principals_with_products:i,principals_with_opportunities:o,average_products_per_principal:r,top_organizations_by_principals:U}}catch(n){t.error=n instanceof Error?n.message:"Unexpected error occurred"}finally{t.loading=!1}},b=async n=>{try{const a=[];for(const i of n){const o=t.principalOptions.find(r=>r.id===i);o&&a.push(...o.available_products)}return[...new Set(a)]}catch(a){return t.error=a instanceof Error?a.message:"Failed to get available products",[]}},D=async(n,a)=>{t.updating=!0,t.error=null;try{return console.log("Associating products",n,"with principals",a),a.forEach(i=>{const o=t.principals.find(c=>c.id===i);o&&(o.product_count+=n.length);const r=t.principalOptions.find(c=>c.id===i);r&&(r.available_products=[...new Set([...r.available_products,...n])])}),!0}catch(i){return t.error=i instanceof Error?i.message:"Failed to associate products with principals",!1}finally{t.updating=!1}},_=n=>{let a=[...t.principals];if(n.organization_ids&&n.organization_ids.length>0&&(a=a.filter(i=>n.organization_ids.includes(i.organization_id))),n.organization_types&&n.organization_types.length>0&&(a=a.filter(i=>i.organization_type&&n.organization_types.includes(i.organization_type))),n.has_products!==void 0&&(a=a.filter(i=>n.has_products?i.product_count>0:i.product_count===0)),n.is_active!==void 0&&(a=a.filter(i=>i.is_active===n.is_active)),n.search){const i=n.search.toLowerCase();a=a.filter(o=>o.name.toLowerCase().includes(i)||o.organization_name.toLowerCase().includes(i))}d.value=n};return{...t,activeFilters:d,isLoading:f,hasError:y,principalCount:h,activePrincipalCount:z,getPrincipalById:m,getPrincipalsByOrganization:O,principalsWithProducts:w,principalsWithOpportunities:v,getOrganizationsWithPrincipals:P,principalsByOrganizationType:S,fetchPrincipals:u,fetchPrincipalOptions:E,fetchPrincipalsByOrganization:g,fetchPrincipalById:F,searchPrincipals:I,fetchStats:x,getAvailableProductsForPrincipals:b,associateProductsWithPrincipals:D,clearError:()=>{t.error=null},clearSelectedPrincipal:()=>{t.selectedPrincipal=null},clearSearch:()=>{t.searchTerm="",d.value={},t.selectedOrganizationId=null},refresh:async()=>{t.selectedOrganizationId?await g(t.selectedOrganizationId):await u(d.value)}}});export{R as u};
//# sourceMappingURL=principalStore-JxlbTJes.js.map
