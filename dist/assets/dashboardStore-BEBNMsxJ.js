import{H as K,x as V,r as L,c as o,y as S}from"./index-CtjJHjR0.js";import{u as W}from"./opportunityStore-B1hLuFtx.js";import{u as Y}from"./productStore-9Dx38iZU.js";import{u as q}from"./organizationStore-nVvH6PxL.js";import{u as B}from"./principalStore-DHqEcCuF.js";const at=K("dashboard",()=>{const s=W(),c=Y(),n=q(),l=B(),e=V({kpis:null,performance:null,recentActivity:[],loading:!1,refreshing:!1,error:null,lastUpdated:null,lastRefresh:null,filters:{timeFilter:{period:"month"},organizationTypes:[],opportunityStages:[],productCategories:[],showInactiveItems:!1,refreshInterval:5},preferences:{sidebarCollapsed:!1,weekFilterEnabled:!1,autoRefresh:!0,theme:"light"},autoRefresh:!0,cacheExpiryMinutes:10,isDataStale:!1}),u=L(null),p=o(()=>{const t=s.kpis,i=c.stats,r=n.dashboardMetrics,a=l.stats;return!t||!i||!r||!a?null:{totalOpportunities:t.total_opportunities,totalProducts:i.total_products,totalOrganizations:r.totalOrganizations,totalPrincipals:a.total_principals,activePipeline:t.active_opportunities,pipelineValue:t.total_pipeline_value,wonThisMonth:t.won_this_month,conversionRate:t.conversion_rate,averageDealSize:t.total_pipeline_value/Math.max(t.total_opportunities,1),monthlyGrowthRate:r.monthlyGrowth,newOpportunitiesThisWeek:t.created_this_week,newOrganizationsThisMonth:M(r),recentActivityCount:t.created_this_week+t.updated_this_week,averageLeadScore:r.averageLeadScore,averageDaysToClose:t.average_days_to_close,topPerformingCategory:i.most_common_category,mostActiveOrganizationType:O(r),opportunityStageDistribution:t.stage_distribution,productCategoryDistribution:i.products_by_category,organizationStatusDistribution:T(r),principalProductDistribution:k(a)}}),g=o(()=>{const t=s.kpis,i=n.dashboardMetrics,r=l.stats;return!t||!i||!r?null:{averageTimeToClose:t.average_days_to_close,averageResponseTime:A(),dealsClosedThisMonth:t.won_this_month,opportunityConversionRate:t.conversion_rate,principalEngagementRate:P(r),productAdoptionRate:I(),monthOverMonthGrowth:i.monthlyGrowth,quarterOverQuarterGrowth:C(),yearOverYearGrowth:$(),forecastedRevenue:F(t),probabilityWeightedPipeline:E(t),expectedCloseThisQuarter:x(t)}}),m=o(()=>{const t=[];return s.opportunities.slice(0,5).forEach(a=>{t.push({id:`opp-${a.id}`,type:"opportunity",action:"created",title:`New Opportunity: ${a.name}`,description:`${a.stage} - ${a.organization_name}`,timestamp:new Date(a.created_at),entityId:a.id,entityName:a.name,userName:a.deal_owner||void 0})}),n.organizations.slice(0,3).forEach(a=>{t.push({id:`org-${a.id}`,type:"organization",action:"created",title:`New Organization: ${a.name}`,description:`${a.type||"Unknown"} - ${a.industry||"Unknown Industry"}`,timestamp:new Date(a.created_at||new Date),entityId:a.id,entityName:a.name})}),t.sort((a,h)=>h.timestamp.getTime()-a.timestamp.getTime()).slice(0,20)}),y=o(()=>e.lastUpdated?(new Date().getTime()-e.lastUpdated.getTime())/(1e3*60)<e.cacheExpiryMinutes:!1),z=o(()=>s.loading||c.loading||(typeof n.loading=="boolean"?n.loading:Object.values(n.loading).some(Boolean))||l.loading);function M(t){const i=new Date().getMonth();return t.recentActivity.filter(r=>new Date(r.date).getMonth()===i).reduce((r,a)=>r+a.organizationsAdded,0)}function O(t){return t.statusDistribution.length?t.statusDistribution.reduce((r,a)=>a.count>r.count?a:r).status:null}function T(t){const i={};return t.statusDistribution.forEach(r=>{i[r.status]=r.count}),i}function k(t){return t.top_organizations_by_principals.map(i=>({principalName:i.organization_name,productCount:Math.floor(Math.random()*10)+1,opportunityCount:Math.floor(Math.random()*5)+1}))}function A(){return 2.5}function P(t){return t.principals_with_opportunities/Math.max(t.total_principals,1)*100}function I(){return 65.5}function C(){return 12.3}function $(){return 28.7}function F(t){return t.total_pipeline_value*(t.conversion_rate/100)}function E(t){return t.total_pipeline_value*(t.average_probability/100)}function x(t){return t.total_pipeline_value*.25}const d=async()=>{if(!e.refreshing){e.refreshing=!0,e.error=null;try{await Promise.all([s.fetchKPIs(),c.fetchStats(),n.fetchDashboardMetrics(),l.fetchStats()]),e.kpis=p.value,e.performance=g.value,e.recentActivity=m.value,e.lastRefresh=new Date,e.lastUpdated=new Date,e.isDataStale=!1}catch(t){console.error("Failed to refresh dashboard:",t),e.error=t instanceof Error?t.message:"Failed to refresh dashboard data"}finally{e.refreshing=!1}}},G=async()=>{if(!e.loading){e.loading=!0,e.error=null;try{await Promise.all([s.fetchOpportunities(),c.fetchProducts(),n.fetchOrganizations(),l.fetchPrincipals()]),await d()}catch(t){console.error("Failed to initialize dashboard:",t),e.error=t instanceof Error?t.message:"Failed to initialize dashboard"}finally{e.loading=!1}}},_=t=>{e.filters={...e.filters,...t},e.isDataStale=!0,d()},U=t=>{_({timeFilter:t})},N=t=>{e.preferences={...e.preferences,...t},t.autoRefresh!==void 0&&(e.autoRefresh=t.autoRefresh,w(t.autoRefresh))},w=t=>{e.autoRefresh=t,t?v():f()},v=()=>{f(),e.autoRefresh&&e.filters.refreshInterval>0&&(u.value=setInterval(()=>{!e.refreshing&&!e.loading&&d()},e.filters.refreshInterval*60*1e3))},f=()=>{u.value&&(clearInterval(u.value),u.value=null)},Q=async(t="json")=>{var r,a,h,b,R,D;const i={timestamp:new Date().toISOString(),kpis:e.kpis,performance:e.performance,recentActivity:e.recentActivity,filters:e.filters};return t==="json"?JSON.stringify(i,null,2):["Metric,Value",`Total Opportunities,${((r=e.kpis)==null?void 0:r.totalOpportunities)||0}`,`Total Products,${((a=e.kpis)==null?void 0:a.totalProducts)||0}`,`Total Organizations,${((h=e.kpis)==null?void 0:h.totalOrganizations)||0}`,`Pipeline Value,${((b=e.kpis)==null?void 0:b.pipelineValue)||0}`,`Conversion Rate,${((R=e.kpis)==null?void 0:R.conversionRate)||0}`,`Monthly Growth,${((D=e.kpis)==null?void 0:D.monthlyGrowthRate)||0}`].join(`
`)},j=()=>{e.kpis=null,e.performance=null,e.recentActivity=[],e.error=null,e.lastUpdated=null,e.lastRefresh=null,e.isDataStale=!1,e.filters={timeFilter:{period:"month"},organizationTypes:[],opportunityStages:[],productCategories:[],showInactiveItems:!1,refreshInterval:5},e.preferences={sidebarCollapsed:!1,weekFilterEnabled:!1,autoRefresh:!0,theme:"light"},f()};return S([()=>s.kpis,()=>c.stats,()=>n.dashboardMetrics,()=>l.stats],()=>{p.value&&(e.kpis=p.value,e.performance=g.value,e.recentActivity=m.value,e.lastUpdated=new Date)},{deep:!0}),S(y,t=>{e.isDataStale=!t}),e.autoRefresh&&v(),{kpis:o(()=>e.kpis),performance:o(()=>e.performance),recentActivity:o(()=>e.recentActivity),loading:o(()=>e.loading),refreshing:o(()=>e.refreshing),error:o(()=>e.error),lastUpdated:o(()=>e.lastUpdated),lastRefresh:o(()=>e.lastRefresh),filters:o(()=>e.filters),preferences:o(()=>e.preferences),autoRefresh:o(()=>e.autoRefresh),isDataStale:o(()=>e.isDataStale),isDataFresh:y,isAnyStoreLoading:z,aggregatedKPIs:p,performanceMetrics:g,recentActivityFeed:m,initializeDashboard:G,refreshDashboard:d,updateFilters:_,updateTimeFilter:U,updatePreferences:N,toggleAutoRefresh:w,exportDashboard:Q,resetDashboard:j,startAutoRefresh:v,stopAutoRefresh:f}});export{at as u};
//# sourceMappingURL=dashboardStore-BEBNMsxJ.js.map
