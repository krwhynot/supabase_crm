import{H as B,x as W,r as U,c as P}from"./index-Br7bM97V.js";import{s as x}from"./supabaseClient-CwaY5m9F.js";import{c as $,b as S,a as G,d as K,e as V}from"./index.esm-DHR-h0Sg.js";var D=(t=>(t.NEW_LEAD="New Lead",t.INITIAL_OUTREACH="Initial Outreach",t.SAMPLE_VISIT_OFFERED="Sample/Visit Offered",t.AWAITING_RESPONSE="Awaiting Response",t.FEEDBACK_LOGGED="Feedback Logged",t.DEMO_SCHEDULED="Demo Scheduled",t.CLOSED_WON="Closed - Won",t))(D||{}),k=(t=>(t.SITE_VISIT="Site Visit",t.FOOD_SHOW="Food Show",t.NEW_PRODUCT_INTEREST="New Product Interest",t.FOLLOW_UP="Follow-up",t.DEMO_REQUEST="Demo Request",t.SAMPLING="Sampling",t.CUSTOM="Custom",t))(k||{});$({name:S().required("Opportunity name is required").min(3,"Name must be at least 3 characters").max(255,"Name must be less than 255 characters"),organization_id:S().required("Organization is required").uuid("Invalid organization ID"),stage:S().required("Stage is required").oneOf(Object.values(D),"Invalid stage selected"),principal_ids:V(S().uuid("Invalid principal ID")).min(1,"At least one principal must be selected").required("Principal selection is required"),product_id:S().uuid("Invalid product ID").required("Product selection is required"),context:S().oneOf([...Object.values(k),""],"Invalid context selected").nullable(),probability_percent:K().min(0,"Probability cannot be negative").max(100,"Probability cannot exceed 100%").nullable(),expected_close_date:S().nullable().test("future-date","Close date should be in the future",function(t){if(!t)return!0;const e=new Date(t),r=new Date;return r.setHours(0,0,0,0),e>=r}),deal_owner:S().max(100,"Deal owner name must be less than 100 characters").nullable(),notes:S().max(2e3,"Notes must be less than 2000 characters").nullable(),auto_generate_name:G().default(!0),name_template:S().max(500,"Name template must be less than 500 characters").nullable()});const Z={"New Lead":10,"Initial Outreach":20,"Sample/Visit Offered":35,"Awaiting Response":40,"Feedback Logged":60,"Demo Scheduled":80,"Closed - Won":100},ee={"New Lead":"gray","Initial Outreach":"blue","Sample/Visit Offered":"yellow","Awaiting Response":"orange","Feedback Logged":"purple","Demo Scheduled":"green","Closed - Won":"emerald"};class H{generateOpportunityName(e){const{organization_name:r,principal_name:a,context:i,date:d=new Date,custom_context:p}=e,_=this.cleanName(r),c=this.cleanName(a),f=this.getContextString(i,p),l=this.formatDate(d);return[_,c,f,l].filter(Boolean).join(" - ")}generateBatchNamePreviews(e){const{organization_name:r,principal_data:a,context:i,custom_context:d,date:p=new Date}=e;return a.map(_=>{const c=this.generateOpportunityName({organization_name:r,principal_name:_.name,context:i,custom_context:d,date:p}),f=this.generateNameTemplate({organization_name:r,principal_name:_.name,context:i,custom_context:d,date:p});return{principal_id:_.id,principal_name:_.name,generated_name:c,name_template:f}})}generateNameTemplate(e){const{context:r,custom_context:a}=e,i={organization:"{{organization}}",principal:"{{principal}}",context:this.getContextString(r,a)||"{{context}}",month:"{{month}}",year:"{{year}}"};return[i.organization,i.principal,i.context,`${i.month} ${i.year}`].filter(p=>p!=="{{context}}"||r||a).join(" - ")}isAutoGeneratedName(e,r){if(!r)return!1;let a=r.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&");return a=a.replace(/\\\{\\\{organization\\\}\\\}/g,"([^-]+?)").replace(/\\\{\\\{principal\\\}\\\}/g,"([^-]+?)").replace(/\\\{\\\{context\\\}\\\}/g,"([^-]+?)").replace(/\\\{\\\{month\\\}\\\}/g,"([A-Za-z]+)").replace(/\\\{\\\{year\\\}\\\}/g,"(\\d{4})").replace(/\\\{\\\{date\\\}\\\}/g,"([A-Za-z]+ \\d{4})"),a=a.replace(/\\\s\*/g,"\\s*").replace(/\\-/g,"\\s*-\\s*"),new RegExp(`^${a}$`).test(e.trim())}parseAutoGeneratedName(e,r){try{if(!this.isAutoGeneratedName(e,r))return null;const a=e.split(" - ").map(m=>m.trim());if(a.length<3)return null;const i=r.includes("{{context}}");let d="",p="",_="",c="";if(i){if(a.length<4)return null;d=a[0]||"",p=a[1]||"",_=a[2]||"",c=a[3]||""}else if(r.split(" - ").length===4&&a.length===4)d=a[0]||"",p=a[1]||"",_=a[2]||"",c=a[3]||"";else{if(a.length<3)return null;d=a[0]||"",p=a[1]||"",_="",c=a[2]||""}const f=c.split(" "),l=f[0]||"",o=f[1]||"";return{organization:d,principal:p,context:_,month:l,year:o,date:c}}catch(a){return console.error("Error parsing auto-generated name:",a),null}}updateAutoGeneratedName(e,r,a){const i=this.parseAutoGeneratedName(e,r);if(!i)return this.generateOpportunityName(a);const d={organization_name:a.organization_name||i.organization,principal_name:a.principal_name||i.principal,context:a.context,custom_context:a.custom_context||(a.context?void 0:i.context),date:a.date||new Date};return this.generateOpportunityName(d)}async isNameUnique(e,r){return{data:!0,error:null,success:!0}}async generateUniqueName(e){try{const r=this.generateOpportunityName(e);let a=r,i=1;for(;!(await this.isNameUnique(a)).data;)if(a=`${r} (${i})`,i++,i>100)throw new Error("Could not generate unique name after 100 attempts");return{data:a,error:null,success:!0}}catch(r){return console.error("Error generating unique name:",r),{data:null,error:r instanceof Error?r.message:"Failed to generate unique opportunity name",success:!1}}}cleanName(e){return e.trim().replace(/\s+/g," ").replace(/[^\w\s&.\-\u00C0-\u017F]/g,"").trim()}getContextString(e,r){return r!=null&&r.trim()?this.cleanName(r):e||""}formatDate(e){const a=["January","February","March","April","May","June","July","August","September","October","November","December"][e.getMonth()],i=e.getFullYear();return`${a} ${i}`}}const J=new H,C=t=>J.generateBatchNamePreviews(t);class j{async getOpportunities(e={}){try{let r=x.from("opportunities").select(`
          *,
          organizations:organization_id(name, type),
          products:product_id(name, category)
        `);e.search&&(r=r.ilike("name",`%${e.search}%`)),e.stage&&(r=r.eq("stage",e.stage)),e.organization_id&&(r=r.eq("organization_id",e.organization_id)),e.deal_owner&&(r=r.eq("deal_owner",e.deal_owner)),e.is_won!==void 0&&(r=r.eq("is_won",e.is_won));const a=e.sortBy||"created_at",i=e.sortOrder||"desc";r=r.order(a,{ascending:i==="asc"}),e.limit&&(r=r.limit(e.limit)),e.offset&&(r=r.range(e.offset,e.offset+(e.limit||10)-1));const{data:d,error:p}=await r;return p?(console.error("Error fetching opportunities:",p),{data:null,error:p.message,success:!1}):{data:(d||[]).map(c=>{var h,w,b,O;const f=new Date(c.created_at||new Date),l=new Date,o=Math.floor((l.getTime()-f.getTime())/(1e3*60*60*24));let m=null;if(c.expected_close_date){const E=new Date(c.expected_close_date);m=Math.floor((E.getTime()-l.getTime())/(1e3*60*60*24))}return{id:c.id,name:c.name,stage:c.stage,probability_percent:c.probability_percent||0,expected_close_date:c.expected_close_date,deal_owner:c.deal_owner,is_won:c.is_won||!1,created_at:c.created_at||new Date().toISOString(),updated_at:c.updated_at||new Date().toISOString(),notes:c.notes||null,organization_name:((h=c.organizations)==null?void 0:h.name)||"",organization_type:((w=c.organizations)==null?void 0:w.type)||"",principal_name:null,principal_id:null,product_name:((b=c.products)==null?void 0:b.name)||null,product_category:((O=c.products)==null?void 0:O.category)||null,days_since_created:o,days_to_close:m,stage_duration_days:o}}),error:null,success:!0}}catch(r){return console.error("Unexpected error in getOpportunities:",r),{data:null,error:r instanceof Error?r.message:"Unknown error occurred",success:!1}}}async getOpportunitiesWithFilters(e,r){try{let a=x.from("opportunities").select(`
          *,
          organizations:organization_id(name, type),
          products:product_id(name, category)
        `,{count:"exact"});e.search&&(a=a.ilike("name",`%${e.search}%`)),e.stage&&e.stage.length>0&&(a=a.in("stage",e.stage)),e.organization_id&&(a=a.eq("organization_id",e.organization_id)),e.product_id&&(a=a.eq("product_id",e.product_id)),e.deal_owner&&(a=a.eq("deal_owner",e.deal_owner)),e.probability_min!==void 0&&(a=a.gte("probability_percent",e.probability_min)),e.probability_max!==void 0&&(a=a.lte("probability_percent",e.probability_max)),e.is_won!==void 0&&(a=a.eq("is_won",e.is_won)),a=a.order(r.sort_by,{ascending:r.sort_order==="asc"}).range((r.page-1)*r.limit,r.page*r.limit-1);const{data:i,error:d,count:p}=await a;if(d)return console.error("Error fetching filtered opportunities:",d),{data:null,error:d.message,success:!1};const _=(i||[]).map(l=>{var b,O,E,g;const o=new Date(l.created_at||new Date),m=new Date,h=Math.floor((m.getTime()-o.getTime())/(1e3*60*60*24));let w=null;if(l.expected_close_date){const I=new Date(l.expected_close_date);w=Math.floor((I.getTime()-m.getTime())/(1e3*60*60*24))}return{id:l.id,name:l.name,stage:l.stage,probability_percent:l.probability_percent||0,expected_close_date:l.expected_close_date,deal_owner:l.deal_owner,is_won:l.is_won||!1,created_at:l.created_at||new Date().toISOString(),updated_at:l.updated_at||new Date().toISOString(),notes:l.notes||null,organization_name:((b=l.organizations)==null?void 0:b.name)||"",organization_type:((O=l.organizations)==null?void 0:O.type)||"",principal_name:null,principal_id:null,product_name:((E=l.products)==null?void 0:E.name)||null,product_category:((g=l.products)==null?void 0:g.category)||null,days_since_created:h,days_to_close:w,stage_duration_days:h}}),c=p||0;return{data:{opportunities:_,total_count:c,page:r.page,limit:r.limit,has_next:r.page*r.limit<c,has_previous:r.page>1},error:null,success:!0}}catch(a){return console.error("Unexpected error in getOpportunitiesWithFilters:",a),{data:null,error:a instanceof Error?a.message:"Unknown error occurred",success:!1}}}async getOpportunityById(e){var r,a,i,d,p,_,c,f,l;try{const{data:o,error:m}=await x.from("opportunities").select(`
          *,
          organizations:organization_id(name, type, address, phone, email),
          products:product_id(name, description, category, suggested_retail_price)
        `).eq("id",e).single();if(m)return console.error("Error fetching opportunity:",m),{data:null,error:m.message,success:!1};if(!o)return{data:null,error:"Opportunity not found",success:!1};const h=new Date(o.created_at||new Date),w=new Date,b=Math.floor((w.getTime()-h.getTime())/(1e3*60*60*24));let O=null;if(o.expected_close_date){const g=new Date(o.expected_close_date);O=Math.floor((g.getTime()-w.getTime())/(1e3*60*60*24))}return{data:{id:o.id,name:o.name,organization_id:o.organization_id,stage:o.stage,product_id:o.product_id,context:o.context,probability_percent:o.probability_percent||0,expected_close_date:o.expected_close_date,deal_owner:o.deal_owner,notes:o.notes,is_won:o.is_won||!1,auto_generated_name:o.auto_generated_name||!1,name_template:o.name_template,created_at:o.created_at||new Date().toISOString(),updated_at:o.updated_at||new Date().toISOString(),created_by:o.created_by,deleted_at:o.deleted_at,organization_name:((r=o.organizations)==null?void 0:r.name)||"",organization_type:((a=o.organizations)==null?void 0:a.type)||"",organization_address:((i=o.organizations)==null?void 0:i.address)||null,organization_phone:((d=o.organizations)==null?void 0:d.phone)||null,organization_email:((p=o.organizations)==null?void 0:p.email)||null,principal_name:null,principal_id:null,principal_address:null,principal_phone:null,principal_email:null,product_name:((_=o.products)==null?void 0:_.name)||null,product_description:((c=o.products)==null?void 0:c.description)||null,product_category:((f=o.products)==null?void 0:f.category)||null,product_unit_price:((l=o.products)==null?void 0:l.suggested_retail_price)||null,days_since_created:b,days_to_close:O,stage_duration_days:b,has_recent_interactions:!1,last_interaction_date:null,total_interactions:0},error:null,success:!0}}catch(o){return console.error("Unexpected error in getOpportunityById:",o),{data:null,error:o instanceof Error?o.message:"Unknown error occurred",success:!1}}}async createOpportunity(e){try{const r={...e,probability_percent:e.probability_percent??void 0},{data:a,error:i}=await x.from("opportunities").insert(r).select().single();return i?(console.error("Error creating opportunity:",i),{data:null,error:i.message,success:!1}):{data:a,error:null,success:!0}}catch(r){return console.error("Unexpected error in createOpportunity:",r),{data:null,error:r instanceof Error?r.message:"Unknown error occurred",success:!1}}}async createBatchOpportunities(e){try{const{data:r}=await x.from("organizations").select("name").eq("id",e.organization_id).single(),a=(r==null?void 0:r.name)||"Unknown Organization",{data:i}=await x.from("organizations").select("id, name").in("id",e.principal_ids),d=(i||[]).map(l=>({id:l.id,name:l.name})),p=await C({organization_name:a,principal_data:d,context:e.context,custom_context:e.name_template||void 0}),_=[],c=[];for(const l of p)try{const o={name:e.auto_generate_name?l.generated_name:e.name,organization_id:e.organization_id,stage:e.stage,product_id:e.product_id||null,context:e.context,probability_percent:e.probability_percent||null,expected_close_date:e.expected_close_date,deal_owner:e.deal_owner,notes:e.notes,auto_generated_name:e.auto_generate_name,name_template:e.auto_generate_name?l.name_template:null},m=await this.createOpportunity(o);m.success&&m.data?_.push(m.data):c.push({principal_id:l.principal_id,principal_name:l.principal_name,error:m.error||"Unknown error"})}catch(o){c.push({principal_id:l.principal_id,principal_name:l.principal_name,error:o instanceof Error?o.message:"Unknown error"})}return{data:{success:_.length>0,created_opportunities:_,failed_creations:c,total_created:_.length,total_failed:c.length},error:null,success:!0}}catch(r){return console.error("Unexpected error in createBatchOpportunities:",r),{data:null,error:r instanceof Error?r.message:"Unknown error occurred",success:!1}}}async generateNamePreviews(e){try{const{data:r}=await x.from("organizations").select("name").eq("id",e.organization_id).single(),a=(r==null?void 0:r.name)||"Unknown Organization",{data:i}=await x.from("organizations").select("id, name").in("id",e.principal_ids),d=(i||[]).map(_=>({id:_.id,name:_.name}));return{data:await C({organization_name:a,principal_data:d,context:e.context,custom_context:e.name_template||void 0}),error:null,success:!0}}catch(r){return console.error("Unexpected error in generateNamePreviews:",r),{data:null,error:r instanceof Error?r.message:"Unknown error occurred",success:!1}}}async updateOpportunity(e,r){try{const a={...r,probability_percent:r.probability_percent??void 0},{data:i,error:d}=await x.from("opportunities").update(a).eq("id",e).select().single();return d?(console.error("Error updating opportunity:",d),{data:null,error:d.message,success:!1}):{data:i,error:null,success:!0}}catch(a){return console.error("Unexpected error in updateOpportunity:",a),{data:null,error:a instanceof Error?a.message:"Unknown error occurred",success:!1}}}async updateOpportunityStage(e,r){try{const a=Z[r],i={stage:r,probability_percent:a};return await this.updateOpportunity(e,i)}catch(a){return console.error("Unexpected error in updateOpportunityStage:",a),{data:null,error:a instanceof Error?a.message:"Unknown error occurred",success:!1}}}async deleteOpportunity(e){try{const{error:r}=await x.from("opportunities").update({deleted_at:new Date().toISOString()}).eq("id",e);return r?(console.error("Error deleting opportunity:",r),{data:!1,error:r.message,success:!1}):{data:!0,error:null,success:!0}}catch(r){return console.error("Unexpected error in deleteOpportunity:",r),{data:!1,error:r instanceof Error?r.message:"Unknown error occurred",success:!1}}}async getOpportunityKPIs(){try{const{data:e,error:r}=await x.from("opportunities").select("*").is("deleted_at",null);if(r)return console.error("Error fetching opportunities for KPIs:",r),{data:null,error:r.message,success:!1};const a=new Date,i=new Date(a.getFullYear(),a.getMonth(),1),d=new Date(a.getTime()-7*24*60*60*1e3),p=(e==null?void 0:e.length)||0,_=(e==null?void 0:e.filter(g=>!g.is_won&&g.stage!=="Closed - Won").length)||0,c=(e==null?void 0:e.filter(g=>g.is_won).length)||0,f=(e==null?void 0:e.reduce((g,I)=>g+(I.probability_percent||0),0))||0,l=p>0?f/p:0,o=(e==null?void 0:e.filter(g=>g.is_won&&g.updated_at&&new Date(g.updated_at)>=i).length)||0,m=p>0?c/p*100:0,h={"New Lead":0,"Initial Outreach":0,"Sample/Visit Offered":0,"Awaiting Response":0,"Feedback Logged":0,"Demo Scheduled":0,"Closed - Won":0};e==null||e.forEach(g=>{h[g.stage]++});const w=(e==null?void 0:e.filter(g=>g.created_at&&new Date(g.created_at)>=d).length)||0,b=(e==null?void 0:e.filter(g=>g.updated_at&&new Date(g.updated_at)>=d).length)||0,O=(e==null?void 0:e.filter(g=>g.is_won&&g.updated_at&&new Date(g.updated_at)>=d).length)||0;return{data:{total_opportunities:p,active_opportunities:_,won_opportunities:c,average_probability:Math.round(l),total_pipeline_value:0,won_this_month:o,conversion_rate:Math.round(m),average_days_to_close:0,win_rate:Math.round(m),stage_distribution:h,created_this_week:w,updated_this_week:b,closed_this_week:O},error:null,success:!0}}catch(e){return console.error("Unexpected error in getOpportunityKPIs:",e),{data:null,error:e instanceof Error?e.message:"Unknown error occurred",success:!1}}}async getOpportunitiesByStage(){try{const e=await this.getOpportunities({limit:1e3});if(!e.success||!e.data)return{data:null,error:e.error,success:!1};const r={"New Lead":[],"Initial Outreach":[],"Sample/Visit Offered":[],"Awaiting Response":[],"Feedback Logged":[],"Demo Scheduled":[],"Closed - Won":[]};return e.data.forEach(a=>{r[a.stage].push(a)}),{data:r,error:null,success:!0}}catch(e){return console.error("Unexpected error in getOpportunitiesByStage:",e),{data:null,error:e instanceof Error?e.message:"Unknown error occurred",success:!1}}}}const v=new j,te=B("opportunity",()=>{const t=W({opportunities:[],selectedOpportunity:null,loading:!1,creating:!1,updating:!1,deleting:!1,error:null,currentPage:1,totalCount:0,hasNextPage:!1,hasPreviousPage:!1,kpis:null,stageDistribution:null,batchCreationResult:null,namePreviewsCache:[]}),e=U({}),r=U({page:1,limit:20,sort_by:"created_at",sort_order:"desc"}),a=P(()=>t.loading||t.creating||t.updating||t.deleting),i=P(()=>!!t.error),d=P(()=>t.opportunities.length),p=P(()=>s=>t.opportunities.find(n=>n.id===s)),_=P(()=>s=>t.opportunities.filter(n=>n.stage===s)),c=P(()=>t.opportunities.reduce(s=>s+0,0)),f=P(()=>{if(t.opportunities.length===0)return 0;const s=t.opportunities.reduce((n,u)=>n+(u.probability_percent||0),0);return Math.round(s/t.opportunities.length)}),l=async(s={},n=r.value)=>{t.loading=!0,t.error=null;try{const u=await v.getOpportunitiesWithFilters(s,n);u.success&&u.data?(t.opportunities=u.data.opportunities,t.totalCount=u.data.total_count,t.currentPage=u.data.page,t.hasNextPage=u.data.has_next,t.hasPreviousPage=u.data.has_previous,e.value=s,r.value=n):(console.warn("API failed, using demo data:",u.error),t.opportunities=T(),t.totalCount=t.opportunities.length,t.currentPage=1,t.hasNextPage=!1,t.hasPreviousPage=!1,e.value=s,r.value=n)}catch(u){console.warn("API error, using demo data:",u),t.opportunities=T(),t.totalCount=t.opportunities.length,t.currentPage=1,t.hasNextPage=!1,t.hasPreviousPage=!1,e.value=s,r.value=n}finally{t.loading=!1}},o=async s=>{t.loading=!0,t.error=null;try{const n=await v.getOpportunityById(s);n.success&&n.data?t.selectedOpportunity=n.data:t.error=n.error||"Failed to fetch opportunity"}catch(n){t.error=n instanceof Error?n.message:"Unexpected error occurred"}finally{t.loading=!1}},m=async s=>{t.creating=!0,t.error=null;try{const n=await v.createOpportunity(s);if(n.success&&n.data){if(t.currentPage===1){const u={id:n.data.id,name:n.data.name,stage:n.data.stage,probability_percent:n.data.probability_percent,expected_close_date:n.data.expected_close_date,deal_owner:n.data.deal_owner,is_won:n.data.is_won,created_at:n.data.created_at,updated_at:n.data.updated_at,notes:n.data.notes||null,organization_name:"",organization_type:"",principal_name:null,principal_id:null,product_name:null,product_category:null,days_since_created:0,days_to_close:null,stage_duration_days:0};t.opportunities.unshift(u)}return!0}else return t.error=n.error||"Failed to create opportunity",!1}catch(n){return t.error=n instanceof Error?n.message:"Unexpected error occurred",!1}finally{t.creating=!1}},h=async s=>{t.creating=!0,t.error=null,t.batchCreationResult=null;try{const n=await v.createBatchOpportunities(s);return n.success&&n.data?(t.batchCreationResult=n.data,n.data.success&&n.data.created_opportunities.length>0&&await l(e.value,r.value),n.data.success):(t.error=n.error||"Failed to create batch opportunities",!1)}catch(n){return t.error=n instanceof Error?n.message:"Unexpected error occurred",!1}finally{t.creating=!1}},w=async s=>{t.loading=!0,t.error=null;try{const n=await v.generateNamePreviews(s);n.success&&n.data?t.namePreviewsCache=n.data:t.error=n.error||"Failed to generate name previews"}catch(n){t.error=n instanceof Error?n.message:"Unexpected error occurred"}finally{t.loading=!1}},b=async(s,n)=>{var u;t.updating=!0,t.error=null;try{const y=await v.updateOpportunity(s,n);if(y.success&&y.data){const z=t.opportunities.findIndex(M=>M.id===s);return z!==-1&&(t.opportunities[z]={...t.opportunities[z],name:y.data.name,stage:y.data.stage,probability_percent:y.data.probability_percent,expected_close_date:y.data.expected_close_date,deal_owner:y.data.deal_owner,is_won:y.data.is_won,updated_at:y.data.updated_at}),((u=t.selectedOpportunity)==null?void 0:u.id)===s&&await o(s),!0}else return t.error=y.error||"Failed to update opportunity",!1}catch(y){return t.error=y instanceof Error?y.message:"Unexpected error occurred",!1}finally{t.updating=!1}},O=async(s,n)=>{t.updating=!0,t.error=null;try{const u=await v.updateOpportunityStage(s,n);if(u.success&&u.data){const y=t.opportunities.findIndex(z=>z.id===s);return y!==-1&&(t.opportunities[y]={...t.opportunities[y],stage:u.data.stage,probability_percent:u.data.probability_percent,updated_at:u.data.updated_at}),!0}else return t.error=u.error||"Failed to update opportunity stage",!1}catch(u){return t.error=u instanceof Error?u.message:"Unexpected error occurred",!1}finally{t.updating=!1}},E=async s=>{var n;t.deleting=!0,t.error=null;try{const u=await v.deleteOpportunity(s);if(u.success){const y=t.opportunities.findIndex(z=>z.id===s);return y!==-1&&t.opportunities.splice(y,1),((n=t.selectedOpportunity)==null?void 0:n.id)===s&&(t.selectedOpportunity=null),!0}else return t.error=u.error||"Failed to delete opportunity",!1}catch(u){return t.error=u instanceof Error?u.message:"Unexpected error occurred",!1}finally{t.deleting=!1}},g=async()=>{t.loading=!0,t.error=null;try{const s=await v.getOpportunityKPIs();s.success&&s.data?t.kpis=s.data:(console.warn("KPI API failed, using demo data:",s.error),t.kpis=N())}catch(s){console.warn("KPI API error, using demo data:",s),t.kpis=N()}finally{t.loading=!1}},I=async()=>{t.loading=!0,t.error=null;try{const s=await v.getOpportunitiesByStage();s.success&&s.data?t.stageDistribution=s.data:t.error=s.error||"Failed to fetch stage distribution"}catch(s){t.error=s instanceof Error?s.message:"Unexpected error occurred"}finally{t.loading=!1}},A=()=>{t.error=null},F=()=>{t.selectedOpportunity=null},q=()=>{t.batchCreationResult=null,t.namePreviewsCache=[]},L=()=>{e.value={},r.value={page:1,limit:20,sort_by:"created_at",sort_order:"desc"}},R=async()=>{await l(e.value,r.value)},N=()=>({total_opportunities:15,active_opportunities:11,won_opportunities:4,won_this_month:3,average_probability:68,total_pipeline_value:215e4,win_rate:72,time_to_close_avg:45,conversion_rate:26.7,average_days_to_close:45,stage_distribution:{"New Lead":3,"Initial Outreach":2,"Sample/Visit Offered":3,"Awaiting Response":2,"Feedback Logged":2,"Demo Scheduled":2,"Closed - Won":4},created_this_week:2,updated_this_week:8,closed_this_week:1}),T=()=>[{id:"demo-1",name:"Enterprise Integration - TechCorp",stage:D.DEMO_SCHEDULED,probability_percent:75,expected_close_date:"2024-09-15",deal_owner:"Sarah Johnson",is_won:!1,notes:"Technical demo scheduled for next week. Strong interest in enterprise features and scalability.",created_at:"2024-08-01T10:00:00Z",updated_at:"2024-08-01T15:30:00Z",organization_name:"TechCorp Solutions",organization_type:"Technology",principal_name:"Mike Chen",principal_id:"principal-1",product_name:"Enterprise Suite",product_category:"Software",days_since_created:15,days_to_close:45,stage_duration_days:5},{id:"demo-2",name:"Cloud Migration - StartupCo",stage:D.SAMPLE_VISIT_OFFERED,probability_percent:60,expected_close_date:"2024-10-30",deal_owner:"Alex Rodriguez",is_won:!1,notes:"Startup looking to migrate legacy systems to cloud infrastructure. Cost-conscious but very interested in scalability features.",created_at:"2024-07-20T14:00:00Z",updated_at:"2024-08-01T09:15:00Z",organization_name:"StartupCo Inc",organization_type:"Startup",principal_name:"Lisa Wang",principal_id:"principal-2",product_name:"Cloud Platform",product_category:"Infrastructure",days_since_created:27,days_to_close:90,stage_duration_days:12},{id:"demo-3",name:"Data Analytics - RetailGiant",stage:D.FEEDBACK_LOGGED,probability_percent:85,expected_close_date:"2024-08-30",deal_owner:"Emma Thompson",is_won:!1,notes:"Large retail client with extensive data needs. Positive feedback from initial analytics review. Strong alignment with their digital transformation goals.",created_at:"2024-07-10T08:30:00Z",updated_at:"2024-08-01T16:45:00Z",organization_name:"RetailGiant Corp",organization_type:"Retail",principal_name:"David Kim",principal_id:"principal-3",product_name:"Analytics Suite",product_category:"Analytics",days_since_created:37,days_to_close:29,stage_duration_days:8},{id:"demo-4",name:"Security Upgrade - FinanceSecure",stage:D.CLOSED_WON,probability_percent:100,expected_close_date:"2024-07-25",deal_owner:"James Wilson",is_won:!0,notes:"Successfully closed security platform implementation. Client was impressed with compliance features and rapid deployment capabilities.",created_at:"2024-06-15T11:00:00Z",updated_at:"2024-07-25T17:00:00Z",organization_name:"Finance Secure Ltd",organization_type:"Financial Services",principal_name:"Rachel Green",principal_id:"principal-4",product_name:"Security Platform",product_category:"Security",days_since_created:55,days_to_close:-7,stage_duration_days:2}];return{...t,activeFilters:e,activePagination:r,isLoading:a,hasError:i,opportunityCount:d,getOpportunityById:p,getOpportunitiesByStage:_,totalPipelineValue:c,averageProbability:f,fetchOpportunities:l,fetchOpportunityById:o,createOpportunity:m,createBatchOpportunities:h,generateNamePreviews:w,updateOpportunity:b,updateOpportunityStage:O,deleteOpportunity:E,fetchKPIs:g,fetchStageDistribution:I,clearError:A,clearSelectedOpportunity:F,clearBatchResults:q,resetFilters:L,refresh:R}});export{k as O,Z as S,D as a,ee as b,J as o,te as u};
//# sourceMappingURL=opportunityStore-MF-7Z0oO.js.map
