import{s as S}from"./supabaseClient-Dum322BS.js";import{d as k,c,a as C,n as h,b as d,e as z,t as A,j as P,h as D}from"./index-CtjJHjR0.js";import{_ as I}from"./_plugin-vue_export-helper-DlAUqK2U.js";const R={slow_query_threshold:1e3,cache_duration:3e5,max_retry_attempts:3,batch_size:50},b=new Map;class M{generateCacheKey(t,e={}){const r=JSON.stringify(e,Object.keys(e).sort());return`${t}:${r}`}getCachedResult(t){const e=b.get(t);return e?Date.now()-e.timestamp>e.ttl?(b.delete(t),null):e.data:null}setCachedResult(t,e,r=R.cache_duration){b.set(t,{data:e,timestamp:Date.now(),ttl:r})}clearCachePattern(t){for(const e of b.keys())e.includes(t)&&b.delete(e)}async monitorPerformance(t,e){const r=Date.now();try{const a=await e(),s=Date.now()-r;return s>R.slow_query_threshold&&console.warn(`Slow query detected: ${t} took ${s}ms`),a}catch(a){const s=Date.now()-r;throw console.error(`Query failed: ${t} after ${s}ms`,a),a}}async getPrincipalSummaries(t={},e={field:"engagement_score",order:"desc"},r={}){const a=this.generateCacheKey("principal_summaries",{filters:t,sort:e,pagination:r}),s=this.getCachedResult(a);return s?{success:!0,data:s}:this.monitorPerformance("getPrincipalSummaries",async()=>{try{const i=r.page||1,n=r.limit||20,l=(i-1)*n;let u=S.from("principal_activity_summary").select(`
            principal_id,
            principal_name,
            principal_status,
            organization_type,
            industry,
            organization_size,
            is_active,
            lead_score,
            contact_count,
            active_contacts,
            primary_contact_name,
            primary_contact_email,
            last_contact_update,
            total_interactions,
            interactions_last_30_days,
            interactions_last_90_days,
            last_interaction_date,
            last_interaction_type,
            next_follow_up_date,
            avg_interaction_rating,
            positive_interactions,
            follow_ups_required,
            total_opportunities,
            active_opportunities,
            won_opportunities,
            opportunities_last_30_days,
            latest_opportunity_stage,
            latest_opportunity_date,
            avg_probability_percent,
            highest_value_opportunity,
            product_count,
            active_product_count,
            product_categories,
            primary_product_category,
            is_principal,
            is_distributor,
            last_activity_date,
            activity_status,
            engagement_score,
            principal_created_at,
            principal_updated_at,
            summary_generated_at
          `,{count:"exact"});this.applyFiltersToQuery(u,t),u=u.order(e.field,{ascending:e.order==="asc"}),u=u.range(l,l+n-1);const{data:_,error:p,count:f}=await u;if(p)return console.error("Principal summaries query error:",p),{success:!1,error:p.message||"Failed to fetch principal summaries"};if(!_)return{success:!1,error:"No data returned from query"};const v=f||0,x=Math.ceil(v/n),w=i<x,T=i>1,o={page:i,limit:n,total:v,total_pages:x,has_next:w,has_previous:T},g=(_||[]).map(m=>!m||typeof m!="object"?{}:m),O=this.calculateSummaryAnalytics(g),E={data:g,pagination:o,filters:t,sort:e,analytics_summary:{total_count:v,active_count:g.filter(m=>m.activity_status&&m.activity_status==="ACTIVE").length,avg_engagement_score:O.avg_engagement_score,top_activity_status:"ACTIVE"}};return this.setCachedResult(a,E),{success:!0,data:E}}catch(i){return console.error("Principal summaries fetch error:",i),{success:!1,error:i instanceof Error?i.message:"Unexpected error occurred"}}})}async getPrincipalDashboard(t){const e=this.generateCacheKey("principal_dashboard",{principalId:t}),r=this.getCachedResult(e);return r?{success:!0,data:r}:this.monitorPerformance("getPrincipalDashboard",async()=>{try{const{data:a,error:s}=await S.from("principal_activity_summary").select("*").eq("principal_id",t).single();if(s)return{success:!1,error:s.message||"Failed to fetch principal summary"};const i=await this.getDistributorRelationshipsForPrincipal(t),n=await this.getProductPerformanceForPrincipal(t),l=await this.getTimelineEntriesForPrincipal(t,20),u=await this.calculatePrincipalAnalytics(a),_={summary:a,relationships:i,product_performance:n,recent_timeline:l,analytics:u,kpi_metrics:{total_revenue_potential:n.reduce((p,f)=>p+(f.total_value||0),0),active_opportunity_count:a.active_opportunities||0,pending_follow_ups:a.follow_ups_required||0,overdue_activities:0,engagement_trend:"stable"}};return this.setCachedResult(e,_,18e4),{success:!0,data:_}}catch(a){return console.error("Principal dashboard fetch error:",a),{success:!1,error:a instanceof Error?a.message:"Failed to fetch dashboard data"}}})}async getDistributorRelationships(t){const e=this.generateCacheKey("distributor_relationships",{principalIds:t}),r=this.getCachedResult(e);return r?{success:!0,data:r}:this.monitorPerformance("getDistributorRelationships",async()=>{try{const a=[{principal_id:"principal-1",principal_name:"Acme Supplies Co.",principal_status:"Active",distributor_id:"dist-1",distributor_name:"Regional Distribution Corp",distributor_status:"Active",relationship_type:"HAS_DISTRIBUTOR",principal_city:"Los Angeles",principal_state:"CA",principal_country:"USA",distributor_city:"San Francisco",distributor_state:"CA",distributor_country:"USA",principal_lead_score:85,distributor_lead_score:78,principal_created_at:"2023-01-10T00:00:00Z",principal_last_contact:"2024-01-15T10:30:00Z",distributor_last_contact:"2024-01-14T15:20:00Z"}],s=t&&t.length>0?a.filter(i=>t.includes(i.principal_id)):a;return this.setCachedResult(e,s),{success:!0,data:s}}catch(a){return console.error("Distributor relationships fetch error:",a),{success:!1,error:a instanceof Error?a.message:"Failed to fetch relationships"}}})}async getProductPerformance(t){const e=this.generateCacheKey("product_performance",{principalIds:t}),r=this.getCachedResult(e);return r?{success:!0,data:r}:this.monitorPerformance("getProductPerformance",async()=>{try{const a=[{principal_id:"principal-1",principal_name:"Acme Supplies Co.",product_id:"prod-1",product_name:"Premium Widget Pro",product_category:"Protein",product_sku:"PWP-001",is_primary_principal:!0,exclusive_rights:!1,wholesale_price:299.99,minimum_order_quantity:50,lead_time_days:14,contract_start_date:"2023-01-01",contract_end_date:"2024-12-31",territory_restrictions:null,opportunities_for_product:15,won_opportunities_for_product:8,active_opportunities_for_product:7,latest_opportunity_date:"2024-01-10T15:30:00Z",avg_opportunity_probability:65,total_opportunities:15,win_rate:53,total_value:125e3,interactions_for_product:32,recent_interactions_for_product:5,last_interaction_date:"2024-01-08T10:20:00Z",product_is_active:!0,launch_date:"2022-06-15",discontinue_date:null,unit_cost:180,suggested_retail_price:399.99,contract_status:"ACTIVE",product_performance_score:78,relationship_created_at:"2023-01-01T00:00:00Z",relationship_updated_at:"2024-01-08T10:20:00Z"}],s=t&&t.length>0?a.filter(i=>t.includes(i.principal_id)):a;return this.setCachedResult(e,s),{success:!0,data:s}}catch(a){return console.error("Product performance fetch error:",a),{success:!1,error:a instanceof Error?a.message:"Failed to fetch product performance"}}})}async getPrincipalTimeline(t,e=50){const r=this.generateCacheKey("principal_timeline",{principalIds:t,limit:e}),a=this.getCachedResult(r);return a?{success:!0,data:a}:this.monitorPerformance("getPrincipalTimeline",async()=>{try{const{data:s,error:i}=await S.from("principal_activity_summary").select("*").in("principal_id",t).limit(e);if(i)return{success:!1,error:i.message||"Failed to fetch timeline entries"};const n=(s==null?void 0:s.map(l=>({principal_id:l.principal_id||"principal-1",principal_name:l.principal_name||"Sample Principal",activity_date:l.last_activity_date||new Date().toISOString(),activity_type:"INTERACTION",activity_subject:`Activity for ${l.principal_name||"Sample Principal"}`,activity_details:"Recent activity summary with details",source_id:l.id||`source-${Date.now()}`,source_table:"interactions",opportunity_name:null,contact_name:null,product_name:null,created_by:"system",activity_status:"COMPLETED",follow_up_required:!1,follow_up_date:null,timeline_rank:1})))||[];return this.setCachedResult(r,n,12e4),{success:!0,data:n}}catch(s){return console.error("Timeline fetch error:",s),{success:!1,error:s instanceof Error?s.message:"Failed to fetch timeline"}}})}async calculateAnalytics(t){return this.monitorPerformance("calculateAnalytics",async()=>{try{return{success:!0,data:{total_principals:t.length,active_principals:t.filter(r=>r.activity_status==="ACTIVE").length,principals_with_products:t.filter(r=>r.product_count>0).length,principals_with_opportunities:t.filter(r=>r.total_opportunities>0).length,average_products_per_principal:this.calculateAverage(t.map(r=>r.product_count)),average_engagement_score:this.calculateAverage(t.map(r=>r.engagement_score)),top_performers:this.getTopPerformingPrincipals(t,10),activity_status_distribution:this.calculateActivityStatusDistribution(t),product_category_distribution:this.calculateProductCategoryDistribution(t),monthly_activity_trend:await this.calculateMonthlyActivityTrend(t),geographic_distribution:this.calculateGeographicDistribution(t)}}}catch(e){return console.error("Analytics calculation error:",e),{success:!1,error:e instanceof Error?e.message:"Analytics calculation failed"}}})}async getPrincipalOptions(t){const e=this.generateCacheKey("principal_options",{organizationId:t}),r=this.getCachedResult(e);return r?{success:!0,data:r}:this.monitorPerformance("getPrincipalOptions",async()=>{try{const s=[{principal_id:"principal-1",principal_name:"Acme Supplies Co.",organization_type:"B2B",engagement_score:85,activity_status:"ACTIVE",contact_count:12,total_opportunities:12,last_activity_date:new Date().toISOString()},{principal_id:"principal-2",principal_name:"Global Distribution Inc.",organization_type:"B2B",engagement_score:72,activity_status:"ACTIVE",contact_count:8,total_opportunities:8,last_activity_date:new Date(Date.now()-864e5).toISOString()}].map(i=>({id:i.principal_id,name:i.principal_name,organization_type:i.organization_type,engagement_score:i.engagement_score,activity_status:i.activity_status,contact_count:i.contact_count,opportunity_count:i.total_opportunities,last_activity_date:i.last_activity_date,is_recommended:i.engagement_score>70&&i.activity_status==="ACTIVE"}));return this.setCachedResult(e,s),{success:!0,data:s}}catch(a){return console.error("Principal options fetch error:",a),{success:!1,error:a instanceof Error?a.message:"Failed to fetch options"}}})}async batchUpdatePrincipals(t,e){return this.monitorPerformance("batchUpdatePrincipals",async()=>{try{return console.log("Batch updating principals:",t,e),this.clearCachePattern("principal_summaries"),this.clearCachePattern("principal_dashboard"),{success:!0,data:!0}}catch(r){return console.error("Batch update error:",r),{success:!1,error:r instanceof Error?r.message:"Batch update failed"}}})}applyFiltersToQuery(t,e){var r,a,s,i;e.search&&(t=t.or(`principal_name.ilike.%${e.search}%`)),(r=e.activity_status)!=null&&r.length&&(t=t.in("activity_status",e.activity_status)),(a=e.organization_status)!=null&&a.length&&(t=t.in("principal_status",e.organization_status)),(s=e.organization_type)!=null&&s.length&&(t=t.in("organization_type",e.organization_type)),(i=e.product_categories)!=null&&i.length&&(t=t.overlaps("product_categories",e.product_categories)),e.has_opportunities!==null&&e.has_opportunities!==void 0&&(e.has_opportunities?t=t.gt("total_opportunities",0):t=t.eq("total_opportunities",0)),e.has_products!==null&&e.has_products!==void 0&&(e.has_products?t=t.gt("product_count",0):t=t.eq("product_count",0)),e.engagement_score_range&&(t=t.gte("engagement_score",e.engagement_score_range.min).lte("engagement_score",e.engagement_score_range.max)),e.lead_score_range&&(t=t.gte("lead_score",e.lead_score_range.min).lte("lead_score",e.lead_score_range.max)),e.is_principal!==null&&e.is_principal!==void 0&&(t=t.eq("is_principal",e.is_principal)),e.is_distributor!==null&&e.is_distributor!==void 0&&(t=t.eq("is_distributor",e.is_distributor)),e.created_after&&(t=t.gte("principal_created_at",e.created_after)),e.created_before&&(t=t.lte("principal_created_at",e.created_before))}async getDistributorRelationshipsForPrincipal(t){const e=await this.getDistributorRelationships([t]);return e.success?e.data||[]:[]}async getProductPerformanceForPrincipal(t){const e=await this.getProductPerformance([t]);return e.success?e.data||[]:[]}async getTimelineEntriesForPrincipal(t,e){const r=await this.getPrincipalTimeline([t],e);return r.success?r.data||[]:[]}async calculatePrincipalAnalytics(t){const e=await this.calculateAnalytics([t]);return e.success?e.data:{}}calculateSummaryAnalytics(t){return{avg_engagement_score:this.calculateAverage(t.map(e=>e.engagement_score)),total_opportunities:t.reduce((e,r)=>e+r.total_opportunities,0),total_interactions:t.reduce((e,r)=>e+r.total_interactions,0),top_activity_status:this.getMostCommonActivityStatus(t)}}getMostCommonActivityStatus(t){const e=this.calculateActivityStatusDistribution(t);return Object.entries(e).reduce((a,s)=>s[1]>a[1]?s:a,["NO_ACTIVITY",0])[0]}calculateAverage(t){return t.length===0?0:t.reduce((e,r)=>e+r,0)/t.length}calculateActivityStatusDistribution(t){return{NO_ACTIVITY:t.filter(e=>e.activity_status==="NO_ACTIVITY").length,STALE:t.filter(e=>e.activity_status==="STALE").length,MODERATE:t.filter(e=>e.activity_status==="MODERATE").length,ACTIVE:t.filter(e=>e.activity_status==="ACTIVE").length}}calculateProductCategoryDistribution(t){const e={};return t.forEach(r=>{r.product_categories&&Array.isArray(r.product_categories)&&r.product_categories.forEach(a=>{e[a]=(e[a]||0)+1})}),e}async calculateMonthlyActivityTrend(t){return[{month:new Date().toISOString().slice(0,7),new_principals:t.length,active_principals:t.filter(r=>r.activity_status==="ACTIVE").length,opportunities_created:t.reduce((r,a)=>r+a.opportunities_last_30_days,0),interactions_count:t.reduce((r,a)=>r+a.interactions_last_30_days,0)}]}calculateGeographicDistribution(t){return[]}getTopPerformingPrincipals(t,e){return t.sort((r,a)=>a.engagement_score-r.engagement_score).slice(0,e).map(r=>({principal_id:r.principal_id,principal_name:r.principal_name,engagement_score:r.engagement_score,total_opportunities:r.total_opportunities,won_opportunities:r.won_opportunities,total_revenue:0}))}}class V extends M{async getPrincipalActivitySummary(t){var r;const e=await this.getPrincipalSummaries(t||{});return{success:e.success,data:((r=e.data)==null?void 0:r.data)||[],error:e.error}}async getEngagementScoreBreakdown(){return{success:!0,data:[{range:"0-20",label:"Low",count:0,percentage:0},{range:"21-40",label:"Below Average",count:0,percentage:0},{range:"41-60",label:"Average",count:0,percentage:0},{range:"61-80",label:"Above Average",count:0,percentage:0},{range:"81-100",label:"High",count:0,percentage:0}]}}async getPrincipalStats(){return{success:!0,data:{followUpsRequired:0,activeThisWeek:0,topPerformers:0}}}async searchPrincipalsWithActivity(t,e=!1){var s;const r={search:t,activity_status:e?void 0:["ACTIVE"]},a=await this.getPrincipalSummaries(r);return{success:a.success,data:((s=a.data)==null?void 0:s.data)||[],error:a.error}}async getPrincipalProductPerformance(t){const e=await this.getProductPerformance([t]);return{success:e.success,data:e.data||[],error:e.error}}async getPrincipalDistributorRelationships(t){const e=await this.getDistributorRelationships(t);return{success:e.success,data:e.data||[],error:e.error}}}const Q=new V,B=k({__name:"ActivityStatusBadge",props:{status:{},size:{default:"sm"},showLabel:{type:Boolean,default:!0}},setup(y){const t=y,e=c(()=>{const n={ACTIVE:{label:"Active",colorClasses:"bg-green-100 text-green-800 border border-green-200",dotClasses:"bg-green-400"},MODERATE:{label:"Moderate",colorClasses:"bg-yellow-100 text-yellow-800 border border-yellow-200",dotClasses:"bg-yellow-400"},LOW:{label:"Low",colorClasses:"bg-orange-100 text-orange-800 border border-orange-200",dotClasses:"bg-orange-400"},NO_ACTIVITY:{label:"Inactive",colorClasses:"bg-gray-100 text-gray-800 border border-gray-200",dotClasses:"bg-gray-400"}};return n[t.status]||n.NO_ACTIVITY}),r=c(()=>({xs:"px-2 py-0.5 text-xs",sm:"px-2 py-1 text-xs",md:"px-3 py-1 text-sm",lg:"px-3 py-1.5 text-sm"})[t.size]),a=c(()=>`${{xs:"h-1.5 w-1.5",sm:"h-2 w-2",md:"h-2.5 w-2.5",lg:"h-3 w-3"}[t.size]} ${e.value.dotClasses}`),s=c(()=>e.value.colorClasses),i=c(()=>t.showLabel?e.value.label:"");return(n,l)=>(P(),C("span",{class:h(["activity-status-badge inline-flex items-center font-medium rounded-full transition-colors duration-200",[r.value,s.value]])},[d("span",{class:h(["mr-1 rounded-full",a.value]),"aria-hidden":!0},null,2),z(" "+A(i.value),1)],2))}}),H=I(B,[["__scopeId","data-v-08161919"]]),F=["width","height"],N=["cx","cy","r","stroke-width"],$=["cx","cy","r","stroke-width","stroke-dasharray","stroke-dashoffset"],L={class:"absolute inset-0 flex items-center justify-center"},W={class:"text-center"},K={key:0,class:"text-xs text-gray-500 font-medium"},j={key:0,class:"absolute z-10 px-2 py-1 text-xs font-medium text-white bg-gray-900 rounded-md shadow-lg opacity-0 pointer-events-none transition-opacity duration-200 -top-8 left-1/2 transform -translate-x-1/2 group-hover:opacity-100"},U=k({__name:"EngagementScoreRing",props:{score:{},size:{default:"md"},showLabel:{type:Boolean,default:!0},showTooltip:{type:Boolean,default:!1},animated:{type:Boolean,default:!0},maxScore:{default:100}},setup(y){const t=y,e=c(()=>({xs:{diameter:32,strokeWidth:3,textClass:"text-xs"},sm:{diameter:40,strokeWidth:3,textClass:"text-sm"},md:{diameter:56,strokeWidth:4,textClass:"text-base"},lg:{diameter:80,strokeWidth:5,textClass:"text-lg"},xl:{diameter:120,strokeWidth:6,textClass:"text-2xl"}})[t.size]),r=c(()=>e.value.diameter),a=c(()=>r.value/2),s=c(()=>a.value-e.value.strokeWidth/2),i=c(()=>e.value.strokeWidth),n=c(()=>2*Math.PI*s.value),l=c(()=>{const o=Math.min(Math.max(t.score,0),t.maxScore)/t.maxScore;return n.value-o*n.value}),u=c(()=>[t.showTooltip?"group cursor-help":"","relative"].filter(Boolean).join(" ")),_=c(()=>{const o=[];return t.animated&&o.push("transition-transform duration-300 hover:scale-105"),o.join(" ")}),p=c(()=>{const o=t.score;return o>=80?"text-green-500":o>=60?"text-blue-500":o>=40?"text-yellow-500":o>=20?"text-orange-500":"text-red-500"}),f=c(()=>{const o=t.score;return o>=80?"text-green-600":o>=60?"text-blue-600":o>=40?"text-yellow-600":o>=20?"text-orange-600":"text-red-600"}),v=c(()=>e.value.textClass),x=c(()=>Math.round(t.score).toString()),w=c(()=>{const o=t.score;return o>=90?"Excellent":o>=80?"Very Good":o>=70?"Good":o>=60?"Above Avg":o>=50?"Average":o>=40?"Below Avg":o>=30?"Poor":o>=20?"Very Poor":"Critical"}),T=c(()=>`Engagement Score: ${t.score}/${t.maxScore} (${w.value})`);return(o,g)=>(P(),C("div",{class:h(["engagement-score-ring relative inline-flex items-center justify-center",u.value])},[(P(),C("svg",{class:h(["transform -rotate-90 transition-all duration-300",_.value]),width:r.value,height:r.value},[d("circle",{cx:a.value,cy:a.value,r:s.value,stroke:"currentColor","stroke-width":i.value,fill:"none",class:"text-gray-200"},null,8,N),d("circle",{cx:a.value,cy:a.value,r:s.value,stroke:"currentColor","stroke-width":i.value,fill:"none","stroke-dasharray":n.value,"stroke-dashoffset":l.value,class:h([p.value,"transition-all duration-500 ease-out"]),"stroke-linecap":"round"},null,10,$)],10,F)),d("div",L,[d("div",W,[d("span",{class:h(["font-bold tabular-nums",[v.value,f.value]])},A(x.value),3),o.showLabel&&o.size!=="xs"&&o.size!=="sm"?(P(),C("div",K,A(w.value),1)):D("",!0)])]),o.showTooltip?(P(),C("div",j,[z(A(T.value)+" ",1),g[0]||(g[0]=d("div",{class:"absolute top-full left-1/2 transform -translate-x-1/2 border-4 border-transparent border-t-gray-900"},null,-1))])):D("",!0)],2))}}),J=I(U,[["__scopeId","data-v-5f57d73c"]]);export{H as A,J as E,Q as p};
//# sourceMappingURL=EngagementScoreRing-BkhISJFZ.js.map
