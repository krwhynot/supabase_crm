import{m as ze,r as m,y as J,j as D}from"./index-Dvtn0bXD.js";import{s as c}from"./supabaseClient-CM-h1Htk.js";const ke=ze("organization",()=>{const d=m([]),_=m(null),q=m([]),$=m([]),j=m([]),u=m(null),M=m([]),N=m([]),i=J({organizations:!1,currentOrganization:!1,analytics:!1,performance:!1,leadScoring:!1,metrics:!1,interactions:!1,documents:!1,creating:!1,updating:!1,deleting:!1,bulkOperations:!1}),O=J({organizations:"",currentOrganization:"",analytics:"",performance:"",leadScoring:"",metrics:"",interactions:"",documents:"",creating:"",updating:"",deleting:"",bulkOperations:""}),b=m(""),r=m({}),E=m({field:"name",order:"asc"}),o=m({page:1,limit:20,total:0,totalPages:0,hasNext:!1,hasPrevious:!1}),I=m(null),x=J({}),Z=D(()=>d.value.length>0),ee=D(()=>o.value.total),ae=D(()=>Object.values(i).some(e=>e)),te=D(()=>Object.values(O).some(e=>e!=="")),re=D(()=>{const t=Object.keys(O).find(a=>O[a]!=="");return t?O[t]:""}),ne=D(()=>u.value?{total:u.value.totalOrganizations,active:u.value.activeOrganizations,prospects:u.value.prospects,customers:u.value.customers,partners:u.value.partners,totalRevenue:u.value.totalRevenue,averageLeadScore:u.value.averageLeadScore,thisMonth:u.value.monthlyGrowth>0?Math.round(u.value.totalOrganizations*u.value.monthlyGrowth/100):0,thisWeek:Math.round((u.value.monthlyGrowth>0?u.value.totalOrganizations*u.value.monthlyGrowth/100:0)/4)}:null),se=D(()=>d.value.filter(e=>e.lead_score!==null).sort((e,t)=>(t.lead_score||0)-(e.lead_score||0)).slice(0,10)),oe=D(()=>d.value.reduce((e,t)=>{const a=t.status||"Unknown";return e[a]=(e[a]||0)+1,e},{})),ie=D(()=>{const e=new Date;return e.setDate(e.getDate()-30),d.value.filter(t=>t.created_at?new Date(t.created_at)>=e:!1)}),Q=()=>{Object.keys(O).forEach(e=>{O[e]=""})},v=e=>{O[e]=""},g=(e,t)=>{O[e]=t,console.error(`Organization Store Error (${e}):`,t)},le=e=>{const t=x[e];return t?Date.now()-t.timestamp<t.ttl:!1},A=e=>le(e)?x[e].data:null,B=(e,t,a=3e5)=>{x[e]={data:t,timestamp:Date.now(),ttl:a}},k=e=>{e?delete x[e]:Object.keys(x).forEach(t=>delete x[t])},p=async(e={})=>{try{i.organizations=!0,v("organizations"),e.page!==void 0&&(o.value.page=e.page),e.limit!==void 0&&(o.value.limit=e.limit),e.filters&&(r.value={...r.value,...e.filters}),e.sort&&(E.value={...E.value,...e.sort}),e.search!==void 0&&(b.value=e.search);const t=`organizations_${JSON.stringify({page:o.value.page,limit:o.value.limit,filters:r.value,sort:E.value,search:b.value})}`;if(e.useCache!==!1){const s=A(t);if(s)return d.value=e.resetList?s.data:[...d.value,...s.data],o.value=s.pagination,s}let a=c.from("organizations").select("*",{count:"exact"});if(b.value.trim()){const s=b.value.trim();a=a.or(`name.ilike.%${s}%,legal_name.ilike.%${s}%,industry.ilike.%${s}%`)}r.value.industry&&r.value.industry.length>0&&(a=a.in("industry",r.value.industry)),r.value.status&&r.value.status.length>0&&(a=a.in("status",r.value.status)),r.value.type&&r.value.type.length>0&&(a=a.in("type",r.value.type)),r.value.size&&r.value.size.length>0&&(a=a.in("size",r.value.size)),r.value.country&&r.value.country.length>0&&(a=a.in("country",r.value.country)),r.value.leadScoreRange&&(r.value.leadScoreRange.min!==void 0&&(a=a.gte("lead_score",r.value.leadScoreRange.min)),r.value.leadScoreRange.max!==void 0&&(a=a.lte("lead_score",r.value.leadScoreRange.max))),r.value.employeeRange&&(r.value.employeeRange.min!==void 0&&(a=a.gte("employees_count",r.value.employeeRange.min)),r.value.employeeRange.max!==void 0&&(a=a.lte("employees_count",r.value.employeeRange.max))),r.value.revenueRange&&(r.value.revenueRange.min!==void 0&&(a=a.gte("annual_revenue",r.value.revenueRange.min)),r.value.revenueRange.max!==void 0&&(a=a.lte("annual_revenue",r.value.revenueRange.max))),r.value.lastContactDateRange&&(r.value.lastContactDateRange.start&&(a=a.gte("last_contact_date",r.value.lastContactDateRange.start.toISOString())),r.value.lastContactDateRange.end&&(a=a.lte("last_contact_date",r.value.lastContactDateRange.end.toISOString())));const n=E.value.order==="asc";a=a.order(E.value.field,{ascending:n});const l=(o.value.page-1)*o.value.limit;a=a.range(l,l+o.value.limit-1);const{data:f,error:h,count:z}=await a;if(h)throw new Error(h.message);const y=(f||[]).map(s=>({id:s.id||"",name:s.name||"",legal_name:s.legal_name,industry:s.industry,type:s.type,size:s.size,status:s.status,website:s.website,email:s.email,primary_phone:s.primary_phone,city:s.city,country:s.country,employees_count:s.employees_count,annual_revenue:s.annual_revenue,lead_score:s.lead_score,contact_count:void 0,last_interaction_date:s.last_contact_date,next_follow_up_date:s.next_follow_up_date,created_at:s.created_at,updated_at:s.updated_at}));o.value.total=z||0,o.value.totalPages=Math.ceil(o.value.total/o.value.limit),o.value.hasNext=o.value.page<o.value.totalPages,o.value.hasPrevious=o.value.page>1,e.resetList!==!1?d.value=y:d.value=[...d.value,...y];const w={data:y,pagination:{...o.value},filters:{...r.value},sort:{...E.value}};return B(t,w),I.value=new Date,w}catch(t){const a=t instanceof Error?t.message:"Failed to fetch organizations";return g("organizations",a),console.error(`Failed to fetch organizations: ${a}`,{operation:"fetch_organizations",options:e}),null}finally{i.organizations=!1}},T=async e=>{var t,a,n;try{i.currentOrganization=!0,v("currentOrganization");const l=`organization_${e}`,f=A(l);if(f)return _.value=f,f;const{data:h,error:z}=await c.from("organizations").select("*").eq("id",e).single();if(z)throw new Error(z.message);const[y,w,s]=await Promise.all([c.from("contacts").select("id, first_name, last_name, email, position").eq("organization_id",e),c.from("organization_interactions").select("id, type, subject, interaction_date, contact_id, direction").eq("organization_id",e).order("interaction_date",{ascending:!1}).limit(10),c.from("organization_documents").select("id, name, category, size, created_at").eq("organization_id",e)]),P={...h,contact_count:((t=y.data)==null?void 0:t.length)||0,interaction_count:((a=w.data)==null?void 0:a.length)||0,document_count:((n=s.data)==null?void 0:n.length)||0,recent_interactions:(w.data||[]).map(R=>{var C,L,F;return{id:R.id,type:R.type,subject:R.subject,interaction_date:R.interaction_date,contact_name:(C=y.data)!=null&&C.find(S=>S.id===R.contact_id)?`${(L=y.data.find(S=>S.id===R.contact_id))==null?void 0:L.first_name} ${(F=y.data.find(S=>S.id===R.contact_id))==null?void 0:F.last_name}`:void 0}})};return _.value=P,B(l,P),P}catch(l){const f=l instanceof Error?l.message:"Failed to fetch organization";return g("currentOrganization",f),_.value=null,null}finally{i.currentOrganization=!1}},ce=async e=>{try{i.creating=!0,v("creating");const{data:t,error:a}=await c.from("organizations").insert(e).select().single();if(a)throw console.error(`Failed to create organization: ${a.message}`,{operation:"create_organization",data:e}),new Error(a.message);return k(),await p({resetList:!0}),console.log("Organization created successfully",{organizationName:e.name,organizationIndustry:e.industry}),t}catch(t){const a=t instanceof Error?t.message:"Failed to create organization";return g("creating",a),console.error("Failed to create organization",a,{organizationData:e}),null}finally{i.creating=!1}},G=async(e,t)=>{var a;try{i.updating=!0,v("updating");const{data:n,error:l}=await c.from("organizations").update(t).eq("id",e).select().single();if(l)throw new Error(l.message);return((a=_.value)==null?void 0:a.id)===e&&await T(e),k(),await p({resetList:!0}),n}catch(n){const l=n instanceof Error?n.message:"Failed to update organization";return g("updating",l),null}finally{i.updating=!1}},V=async e=>{var t;try{i.deleting=!0,v("deleting");const{error:a}=await c.from("organizations").delete().eq("id",e);if(a)throw new Error(a.message);return d.value=d.value.filter(n=>n.id!==e),((t=_.value)==null?void 0:t.id)===e&&(_.value=null),k(),!0}catch(a){const n=a instanceof Error?a.message:"Failed to delete organization";return g("deleting",n),!1}finally{i.deleting=!1}},ue=async e=>{b.value=e,o.value.page=1,await p({search:e,resetList:!0})},de=async()=>{b.value="",o.value.page=1,await p({resetList:!0})},ge=async e=>{r.value={...r.value,...e},o.value.page=1,await p({resetList:!0})},fe=async()=>{r.value={},o.value.page=1,await p({resetList:!0})},ve=async(e,t)=>{E.value={field:e,order:t},o.value.page=1,await p({resetList:!0})},K=async e=>{e>=1&&e<=o.value.totalPages&&(o.value.page=e,await p())},me=async()=>{o.value.hasNext&&await K(o.value.page+1)},he=async()=>{o.value.hasPrevious&&await K(o.value.page-1)},W=async()=>{var e,t;try{i.metrics=!0,v("metrics");const a="dashboard_metrics",n=A(a);if(n)return u.value=n,n;const[l,f,h,z,y,w]=await Promise.all([c.from("organizations").select("id",{count:"exact",head:!0}),c.from("organizations").select("id",{count:"exact",head:!0}).eq("status","Active"),c.from("organizations").select("id",{count:"exact",head:!0}).eq("status","Prospect"),c.from("organizations").select("id",{count:"exact",head:!0}).eq("status","Customer"),c.from("organizations").select("id",{count:"exact",head:!0}).eq("status","Partner"),c.from("organizations").select("annual_revenue, lead_score",{count:"exact"}).not("annual_revenue","is",null)]),s=new Date,P=new Date(s.getFullYear(),s.getMonth(),1),R=await c.from("organizations").select("id",{count:"exact",head:!0}).gte("created_at",P.toISOString()),C=((e=w.data)==null?void 0:e.reduce((S,U)=>S+(U.annual_revenue||0),0))||0,L=(t=w.data)!=null&&t.length?w.data.reduce((S,U)=>S+(U.lead_score||0),0)/w.data.length:0,F={totalOrganizations:l.count||0,activeOrganizations:f.count||0,prospects:h.count||0,customers:z.count||0,partners:y.count||0,totalRevenue:C,averageLeadScore:L,monthlyGrowth:R.count||0,industryDistribution:[],statusDistribution:[],recentActivity:[]};return u.value=F,B(a,F,6e5),F}catch(a){const n=a instanceof Error?a.message:"Failed to fetch dashboard metrics";return g("metrics",n),null}finally{i.metrics=!1}},Y=async()=>{try{i.analytics=!0,v("analytics");const{data:e,error:t}=await c.from("organization_summary_analytics").select("*").order("lead_score",{ascending:!1}).limit(50);if(t)throw new Error(t.message);return q.value=e||[],e}catch(e){const t=e instanceof Error?e.message:"Failed to fetch analytics";return g("analytics",t),null}finally{i.analytics=!1}},ye=async()=>{try{i.performance=!0,v("performance");const{data:e,error:t}=await c.from("monthly_organization_performance").select("*").order("performance_month",{ascending:!1}).limit(12);if(t)throw new Error(t.message);return $.value=e||[],e}catch(e){const t=e instanceof Error?e.message:"Failed to fetch performance data";return g("performance",t),null}finally{i.performance=!1}},_e=async()=>{try{i.leadScoring=!0,v("leadScoring");const{data:e,error:t}=await c.from("organization_lead_scoring").select("*").order("lead_score",{ascending:!1}).limit(100);if(t)throw new Error(t.message);return j.value=e||[],e}catch(e){const t=e instanceof Error?e.message:"Failed to fetch lead scoring data";return g("leadScoring",t),null}finally{i.leadScoring=!1}},H=async e=>{var t;try{i.interactions=!0,v("interactions");const a=e||((t=_.value)==null?void 0:t.id);if(!a)throw new Error("No organization ID provided");const{data:n,error:l}=await c.from("organization_interactions").select("*").eq("organization_id",a).order("interaction_date",{ascending:!1});if(l)throw new Error(l.message);return M.value=n||[],n}catch(a){const n=a instanceof Error?a.message:"Failed to fetch interactions";return g("interactions",n),null}finally{i.interactions=!1}},pe=async e=>{try{const{data:t,error:a}=await c.from("organization_interactions").insert(e).select().single();if(a)throw new Error(a.message);return await H(e.organization_id),t}catch(t){const a=t instanceof Error?t.message:"Failed to create interaction";return g("interactions",a),null}},X=async e=>{var t;try{i.documents=!0,v("documents");const a=e||((t=_.value)==null?void 0:t.id);if(!a)throw new Error("No organization ID provided");const{data:n,error:l}=await c.from("organization_documents").select("*").eq("organization_id",a).order("created_at",{ascending:!1});if(l)throw new Error(l.message);return N.value=n||[],n}catch(a){const n=a instanceof Error?a.message:"Failed to fetch documents";return g("documents",n),null}finally{i.documents=!1}};return{organizations:d,currentOrganization:_,analyticsData:q,performanceData:$,leadScoringData:j,dashboardMetrics:u,interactions:M,documents:N,searchQuery:b,appliedFilters:r,sortConfig:E,pagination:o,lastRefreshed:I,loading:i,isLoading:ae,errors:O,hasErrors:te,currentError:re,hasOrganizations:Z,totalOrganizations:ee,organizationStats:ne,topPerformingOrganizations:se,organizationsByStatus:oe,recentOrganizations:ie,fetchOrganizations:p,fetchOrganization:T,createOrganization:ce,updateOrganization:G,deleteOrganization:V,searchOrganizations:ue,clearSearch:de,applyFilters:ge,clearFilters:fe,setSorting:ve,setPage:K,nextPage:me,previousPage:he,fetchDashboardMetrics:W,fetchAnalytics:Y,fetchPerformanceData:ye,fetchLeadScoringData:_e,fetchInteractions:H,createInteraction:pe,fetchDocuments:X,createDocument:async e=>{try{const{data:t,error:a}=await c.from("organization_documents").insert(e).select().single();if(a)throw new Error(a.message);return await X(e.organization_id),t}catch(t){const a=t instanceof Error?t.message:"Failed to create document";return g("documents",a),null}},performBulkOperation:async e=>{var t,a;try{i.bulkOperations=!0,v("bulkOperations");let n=0,l=0;const f=[];for(const h of e.organizationIds)try{switch(e.type){case"update_status":(t=e.data)!=null&&t.status&&(await G(h,{status:e.data.status}),n++);break;case"delete":await V(h),n++;break;case"add_tags":(a=e.data)!=null&&a.tags&&d.value.find(y=>y.id===h)&&(await G(h,{tags:e.data.tags}),n++);break;default:throw new Error(`Unsupported bulk operation: ${e.type}`)}}catch(z){l++,f.push({id:h,error:z instanceof Error?z.message:"Unknown error"})}return{operation:e,success:l===0,total:e.organizationIds.length,successful:n,failed:l,errors:f}}catch(n){const l=n instanceof Error?n.message:"Failed to perform bulk operation";return g("bulkOperations",l),{operation:e,success:!1,total:e.organizationIds.length,successful:0,failed:e.organizationIds.length,errors:e.organizationIds.map(f=>({id:f,error:l}))}}finally{i.bulkOperations=!1}},getOrganizationById:e=>d.value.find(t=>t.id===e),organizationExists:e=>d.value.some(t=>t.id===e),refreshAllData:async()=>{k(),await Promise.all([p({resetList:!0}),W(),Y()]),I.value=new Date},resetStore:()=>{d.value=[],_.value=null,q.value=[],$.value=[],j.value=[],u.value=null,M.value=[],N.value=[],b.value="",r.value={},E.value={field:"name",order:"asc"},o.value={page:1,limit:20,total:0,totalPages:0,hasNext:!1,hasPrevious:!1},Object.keys(i).forEach(e=>{i[e]=!1}),Q(),k(),I.value=null},clearErrors:Q,clearError:v,clearCache:k}});export{ke as u};
//# sourceMappingURL=organizationStore-3FIIkymA.js.map
