import{H as Ve,r as S,x as te,c as E}from"./index-Br7bM97V.js";import{s as f}from"./supabaseClient-CwaY5m9F.js";import{c as U,b as u,a as N,f as j,e as T,d as h,g as I}from"./index.esm-DHR-h0Sg.js";const de=U({name:u().required("Organization name is required").trim().min(1,"Organization name cannot be empty").max(255,"Organization name must be less than 255 characters"),legal_name:u().nullable().max(255,"Legal name must be less than 255 characters"),description:u().nullable(),industry:u().nullable().max(255,"Industry must be less than 255 characters"),type:I().oneOf(["B2B","B2C","B2B2C","Non-Profit","Government","Other"]).nullable(),size:I().oneOf(["Startup","Small","Medium","Large","Enterprise"]).nullable(),status:I().oneOf(["Active","Inactive","Prospect","Customer","Partner","Vendor"]).nullable(),website:u().nullable().matches(/^https?:\/\/[^\s]+$/,"Website must be a valid URL starting with http:// or https://"),email:u().nullable().email("Email must be a valid email address"),primary_phone:u().nullable().max(50,"Primary phone must be less than 50 characters"),secondary_phone:u().nullable().max(50,"Secondary phone must be less than 50 characters"),address_line_1:u().nullable().max(255,"Address line 1 must be less than 255 characters"),address_line_2:u().nullable().max(255,"Address line 2 must be less than 255 characters"),city:u().nullable().max(100,"City must be less than 100 characters"),state_province:u().nullable().max(100,"State/Province must be less than 100 characters"),postal_code:u().nullable().max(20,"Postal code must be less than 20 characters"),country:u().nullable().max(100,"Country must be less than 100 characters"),founded_year:h().nullable().integer("Founded year must be a whole number").min(1800,"Founded year must be 1800 or later").max(new Date().getFullYear()+1,"Founded year cannot be in the future"),employees_count:h().nullable().integer("Employee count must be a whole number").min(0,"Employee count cannot be negative"),annual_revenue:h().nullable().min(0,"Annual revenue cannot be negative"),currency_code:u().nullable().matches(/^[A-Z]{3}$/,"Currency code must be 3 uppercase letters (e.g., USD)"),lead_source:u().nullable().max(255,"Lead source must be less than 255 characters"),lead_score:h().nullable().integer("Lead score must be a whole number").min(0,"Lead score cannot be negative").max(100,"Lead score cannot exceed 100"),tags:T().of(u()).nullable(),custom_fields:U().nullable(),parent_org_id:u().nullable().uuid("Parent organization ID must be a valid UUID"),assigned_user_id:u().nullable().uuid("Assigned user ID must be a valid UUID"),last_contact_date:j().nullable(),next_follow_up_date:j().nullable(),is_principal:N().nullable(),is_distributor:N().nullable(),distributor_id:u().nullable().uuid("Distributor ID must be a valid UUID"),account_manager_id:u().nullable().uuid("Account Manager ID must be a valid UUID")}),Ye=de;de.partial();const Qe=U({organization_id:u().required("Organization ID is required").uuid("Organization ID must be a valid UUID"),contact_id:u().nullable().uuid("Contact ID must be a valid UUID"),type:I().oneOf(["Email","Phone","Meeting","Demo","Proposal","Contract","Note","Task","Event","Social","Website","Other"]).required("Interaction type is required"),direction:I().oneOf(["Inbound","Outbound"]).nullable(),subject:u().nullable().max(500,"Subject must be less than 500 characters").test("not-empty","Subject cannot be empty if provided",function(d){return d==null||d.trim().length>0}),description:u().nullable(),interaction_date:j().required("Interaction date is required"),duration_minutes:h().nullable().integer("Duration must be a whole number of minutes").min(0,"Duration cannot be negative"),tags:T().of(u()).nullable(),metadata:U().nullable(),created_by_user_id:u().nullable().uuid("Created by user ID must be a valid UUID")});Qe.partial().shape({organization_id:u().uuid("Organization ID must be a valid UUID")});const Ze=U({organization_id:u().required("Organization ID is required").uuid("Organization ID must be a valid UUID"),name:u().required("Document name is required").trim().min(1,"Document name cannot be empty").max(500,"Document name must be less than 500 characters"),description:u().nullable(),file_type:u().nullable().max(50,"File type must be less than 50 characters"),file_size_bytes:h().nullable().integer("File size must be a whole number").min(0,"File size cannot be negative"),storage_path:u().nullable().max(1e3,"Storage path must be less than 1000 characters"),external_url:u().nullable().matches(/^https?:\/\/[^\s]+$/,"External URL must be a valid URL starting with http:// or https://").max(1e3,"External URL must be less than 1000 characters"),category:u().nullable().max(255,"Category must be less than 255 characters"),tags:T().of(u()).nullable(),is_public:N().nullable(),access_level:u().nullable().max(50,"Access level must be less than 50 characters"),version:u().nullable().max(50,"Version must be less than 50 characters"),parent_document_id:u().nullable().uuid("Parent document ID must be a valid UUID"),uploaded_by_user_id:u().nullable().uuid("Uploaded by user ID must be a valid UUID")}).test("has-location","Document must have either a storage path or external URL",function(d){return!!(d.storage_path||d.external_url)});Ze.partial().shape({organization_id:u().uuid("Organization ID must be a valid UUID")});const Xe=U({organization_id:u().required("Organization ID is required").uuid("Organization ID must be a valid UUID"),period_start:j().required("Period start date is required"),period_end:j().required("Period end date is required").test("after-start","Period end must be after period start",function(d){const{period_start:O}=this.parent;return!O||!d?!0:d>O}),period_type:u().required("Period type is required").oneOf(["daily","weekly","monthly","quarterly","yearly"],"Period type must be one of: daily, weekly, monthly, quarterly, yearly"),total_interactions:h().nullable().integer("Total interactions must be a whole number").min(0,"Total interactions cannot be negative"),email_interactions:h().nullable().integer("Email interactions must be a whole number").min(0,"Email interactions cannot be negative"),phone_interactions:h().nullable().integer("Phone interactions must be a whole number").min(0,"Phone interactions cannot be negative"),meeting_interactions:h().nullable().integer("Meeting interactions must be a whole number").min(0,"Meeting interactions cannot be negative"),revenue_generated:h().nullable().min(0,"Revenue generated cannot be negative"),deals_closed:h().nullable().integer("Deals closed must be a whole number").min(0,"Deals closed cannot be negative"),deals_in_progress:h().nullable().integer("Deals in progress must be a whole number").min(0,"Deals in progress cannot be negative"),lead_score_change:h().nullable().integer("Lead score change must be a whole number"),conversion_events:h().nullable().integer("Conversion events must be a whole number").min(0,"Conversion events cannot be negative"),documents_added:h().nullable().integer("Documents added must be a whole number").min(0,"Documents added cannot be negative"),documents_accessed:h().nullable().integer("Documents accessed must be a whole number").min(0,"Documents accessed cannot be negative"),new_contacts_added:h().nullable().integer("New contacts added must be a whole number").min(0,"New contacts added cannot be negative"),active_contacts:h().nullable().integer("Active contacts must be a whole number").min(0,"Active contacts cannot be negative"),custom_metrics:U().nullable()});Xe.partial().shape({organization_id:u().uuid("Organization ID must be a valid UUID")});const et=Ye;et.shape({status:I().oneOf(["Prospect","Active Customer","Inactive Customer","Other","Principal","Distributor"]).required("Organization status is required"),custom_fields:U({is_principal:N().nullable(),is_distributor:N().nullable(),distributor_id:u().nullable().uuid("Distributor ID must be valid UUID"),account_manager_id:u().nullable().uuid("Account Manager ID must be valid UUID"),food_beverage_segment:u().nullable().max(255)}).test("principal-distributor-exclusive","Cannot be both Principal and Distributor",function(d){return!(d!=null&&d.is_principal&&(d!=null&&d.is_distributor))}),priority_letter:I().oneOf(["A","B","C","D"]).required("Priority is required"),assigned_contacts:T().of(u().uuid()).nullable()});U({search:u().nullable().optional(),industry:u().nullable().optional(),type:I().oneOf(["B2B","B2C","B2B2C","Non-Profit","Government","Other"]).nullable().optional(),size:I().oneOf(["Startup","Small","Medium","Large","Enterprise"]).nullable().optional(),status:I().oneOf(["Active","Inactive","Prospect","Customer","Partner","Vendor"]).nullable().optional(),country:u().nullable().optional(),min_employees:h().min(0).nullable().optional(),max_employees:h().min(0).nullable().optional(),min_revenue:h().min(0).nullable().optional(),max_revenue:h().min(0).nullable().optional(),min_lead_score:h().min(0).max(100).nullable().optional(),max_lead_score:h().min(0).max(100).nullable().optional(),tags:T().of(u()).nullable().optional(),limit:h().min(1).max(100).optional().default(20),offset:h().min(0).optional().default(0),sortBy:I().oneOf(["name","legal_name","industry","type","size","status","lead_score","employees_count","annual_revenue","founded_year","created_at","updated_at","last_contact_date","next_follow_up_date"]).optional().default("name"),sortOrder:I().oneOf(["asc","desc"]).optional().default("asc")});const tt=[{value:90,label:"A",description:"Highest priority - Strategic accounts"},{value:70,label:"B",description:"High priority - Major opportunities"},{value:50,label:"C",description:"Medium priority - Qualified prospects"},{value:30,label:"D",description:"Lower priority - New prospects"}],ue=d=>({A:90,B:70,C:50,D:30})[d],at=d=>d?d>=90?"A":d>=70?"B":d>=50?"C":"D":"D",gt=Ve("organization",()=>{const d=S([]),O=S(null),G=S([]),W=S([]),H=S([]),z=S(null),J=S([]),V=S([]),g=te({organizations:!1,currentOrganization:!1,analytics:!1,performance:!1,leadScoring:!1,metrics:!1,interactions:!1,documents:!1,creating:!1,updating:!1,deleting:!1,bulkOperations:!1}),P=te({organizations:"",currentOrganization:"",analytics:"",performance:"",leadScoring:"",metrics:"",interactions:"",documents:"",creating:"",updating:"",deleting:"",bulkOperations:""}),L=S(""),m=S({}),R=S({field:"name",order:"asc"}),p=S({page:1,limit:20,total:0,totalPages:0,hasNext:!1,hasPrevious:!1}),K=S(null),A=te({}),ge=E(()=>d.value.length>0),me=E(()=>p.value.total),_e=E(()=>Object.values(g).some(e=>e)),fe=E(()=>Object.values(P).some(e=>e!=="")),pe=E(()=>{const a=Object.keys(P).find(t=>P[t]!=="");return a?P[a]:""}),he=E(()=>z.value?{total:z.value.totalOrganizations,active:z.value.activeOrganizations,prospects:z.value.prospects,customers:z.value.customers,partners:z.value.partners,totalRevenue:z.value.totalRevenue,averageLeadScore:z.value.averageLeadScore,thisMonth:z.value.monthlyGrowth>0?Math.round(z.value.totalOrganizations*z.value.monthlyGrowth/100):0,thisWeek:Math.round((z.value.monthlyGrowth>0?z.value.totalOrganizations*z.value.monthlyGrowth/100:0)/4)}:null),ye=E(()=>d.value.filter(e=>e.lead_score!==null).sort((e,a)=>(a.lead_score||0)-(e.lead_score||0)).slice(0,10)),ve=E(()=>d.value.reduce((e,a)=>{const t=a.status||"Unknown";return e[t]=(e[t]||0)+1,e},{})),be=E(()=>{const e=new Date;return e.setDate(e.getDate()-30),d.value.filter(a=>a.created_at?new Date(a.created_at)>=e:!1)}),ze=E(()=>tt),we=E(()=>[{value:"Food & Beverage - Restaurants",label:"Food & Beverage - Restaurants",priority:!0},{value:"Food & Beverage - Manufacturing",label:"Food & Beverage - Manufacturing",priority:!0},{value:"Food & Beverage - Distribution",label:"Food & Beverage - Distribution",priority:!0},{value:"Food & Beverage - Retail",label:"Food & Beverage - Retail",priority:!0},{value:"Food & Beverage - Service",label:"Food & Beverage - Service",priority:!0},{value:"Technology",label:"Technology",priority:!1},{value:"Healthcare",label:"Healthcare",priority:!1},{value:"Manufacturing",label:"Manufacturing",priority:!1},{value:"Retail",label:"Retail",priority:!1},{value:"Financial Services",label:"Financial Services",priority:!1},{value:"Real Estate",label:"Real Estate",priority:!1},{value:"Education",label:"Education",priority:!1},{value:"Government",label:"Government",priority:!1},{value:"Non-Profit",label:"Non-Profit",priority:!1},{value:"Other",label:"Other",priority:!1}]),Oe=E(()=>d.value.filter(e=>{const a=e;return a.custom_fields&&typeof a.custom_fields=="object"&&"is_distributor"in a.custom_fields&&a.custom_fields.is_distributor===!0})),Ee=E(()=>d.value.filter(e=>{const a=e;return a.custom_fields&&typeof a.custom_fields=="object"&&"is_principal"in a.custom_fields&&a.custom_fields.is_principal===!0})),De=E(()=>e=>d.value.filter(a=>{var t;return e.includes(a.id)||((t=a.assigned_principals)==null?void 0:t.some(r=>e.includes(r)))})),Se=E(()=>d.value.filter(e=>{var t,r;const a=e;return((t=a.custom_fields)==null?void 0:t.is_principal)===!0||((r=a.custom_fields)==null?void 0:r.is_distributor)===!0||a.assigned_principals&&a.assigned_principals.length>0})),ae=()=>{Object.keys(P).forEach(e=>{P[e]=""})},v=e=>{P[e]=""},y=(e,a)=>{P[e]=a,console.error(`Organization Store Error (${e}):`,a)},Ie=e=>{const a=A[e];return a?Date.now()-a.timestamp<a.ttl:!1},B=e=>Ie(e)?A[e].data:null,$=(e,a,t=3e5)=>{A[e]={data:a,timestamp:Date.now(),ttl:t}},q=e=>{e?delete A[e]:Object.keys(A).forEach(a=>delete A[a])},xe=async(e,a={})=>{try{g.organizations=!0,v("organizations");const t=`organizations_by_principal_${e}_${JSON.stringify(a)}`;if(a.useCache!==!1){const n=B(t);if(n)return n}let r=[],o=[];if(a.includeDirectRelationships!==!1){const{data:n,error:s}=await f.from("organizations").select("*").eq("id",e);s?console.warn("Failed to fetch direct principal organizations:",s.message):r=n||[]}if(a.includeContactRelationships!==!1){const{data:n,error:s}=await f.from("contact_principals").select(`
            contact_id,
            contacts!inner(
              organization_id,
              organizations!inner(*)
            )
          `).eq("principal_id",e);s?console.warn("Failed to fetch contact-principal organizations:",s.message):o=(n||[]).map(l=>{var w;return(w=l.contacts)==null?void 0:w.organizations}).filter(l=>l)}const _=[...r,...o].reduce((n,s)=>(n.find(l=>l.id===s.id)||n.push(s),n),[]).map(n=>({id:n.id||"",name:n.name||"",legal_name:n.legal_name,industry:n.industry,type:n.type,size:n.size,status:n.status,website:n.website,email:n.email,primary_phone:n.primary_phone,city:n.city,country:n.country,employees_count:n.employees_count,annual_revenue:n.annual_revenue,lead_score:n.lead_score,contact_count:void 0,last_interaction_date:n.last_contact_date,next_follow_up_date:n.next_follow_up_date,created_at:n.created_at,updated_at:n.updated_at}));return $(t,_),_}catch(t){const r=t instanceof Error?t.message:"Failed to fetch organizations by principal";return y("organizations",r),console.error(`Failed to fetch organizations by principal: ${r}`,{operation:"fetch_organizations_by_principal",principalId:e,options:a}),null}finally{g.organizations=!1}},D=async(e={})=>{try{g.organizations=!0,v("organizations"),e.page!==void 0&&(p.value.page=e.page),e.limit!==void 0&&(p.value.limit=e.limit),e.filters&&(m.value={...m.value,...e.filters}),e.sort&&(R.value={...R.value,...e.sort}),e.search!==void 0&&(L.value=e.search);const a=`organizations_${JSON.stringify({page:p.value.page,limit:p.value.limit,filters:m.value,sort:R.value,search:L.value})}`;if(e.useCache!==!1){const l=B(a);if(l)return d.value=e.resetList?l.data:[...d.value,...l.data],p.value=l.pagination,l}let t=f.from("organizations").select("*",{count:"exact"});if(L.value.trim()){const l=L.value.trim();t=t.or(`name.ilike.%${l}%,legal_name.ilike.%${l}%,industry.ilike.%${l}%`)}m.value.industry&&m.value.industry.length>0&&(t=t.in("industry",m.value.industry)),m.value.status&&m.value.status.length>0&&(t=t.in("status",m.value.status)),m.value.type&&m.value.type.length>0&&(t=t.in("type",m.value.type)),m.value.size&&m.value.size.length>0&&(t=t.in("size",m.value.size)),m.value.country&&m.value.country.length>0&&(t=t.in("country",m.value.country)),m.value.leadScoreRange&&(m.value.leadScoreRange.min!==void 0&&(t=t.gte("lead_score",m.value.leadScoreRange.min)),m.value.leadScoreRange.max!==void 0&&(t=t.lte("lead_score",m.value.leadScoreRange.max))),m.value.employeeRange&&(m.value.employeeRange.min!==void 0&&(t=t.gte("employees_count",m.value.employeeRange.min)),m.value.employeeRange.max!==void 0&&(t=t.lte("employees_count",m.value.employeeRange.max))),m.value.revenueRange&&(m.value.revenueRange.min!==void 0&&(t=t.gte("annual_revenue",m.value.revenueRange.min)),m.value.revenueRange.max!==void 0&&(t=t.lte("annual_revenue",m.value.revenueRange.max))),m.value.lastContactDateRange&&(m.value.lastContactDateRange.start&&(t=t.gte("last_contact_date",m.value.lastContactDateRange.start.toISOString())),m.value.lastContactDateRange.end&&(t=t.lte("last_contact_date",m.value.lastContactDateRange.end.toISOString())));const r=R.value.order==="asc";t=t.order(R.value.field,{ascending:r});const o=(p.value.page-1)*p.value.limit;t=t.range(o,o+p.value.limit-1);const{data:c,error:i,count:_}=await t;if(i)throw new Error(i.message);const n=(c||[]).map(l=>({id:l.id||"",name:l.name||"",legal_name:l.legal_name,industry:l.industry,type:l.type,size:l.size,status:l.status,website:l.website,email:l.email,primary_phone:l.primary_phone,city:l.city,country:l.country,employees_count:l.employees_count,annual_revenue:l.annual_revenue,lead_score:l.lead_score,contact_count:void 0,last_interaction_date:l.last_contact_date,next_follow_up_date:l.next_follow_up_date,created_at:l.created_at,updated_at:l.updated_at}));p.value.total=_||0,p.value.totalPages=Math.ceil(p.value.total/p.value.limit),p.value.hasNext=p.value.page<p.value.totalPages,p.value.hasPrevious=p.value.page>1,e.resetList!==!1?d.value=n:d.value=[...d.value,...n];const s={data:n,pagination:{...p.value},filters:{...m.value},sort:{...R.value}};return $(a,s),K.value=new Date,s}catch(a){const t=a instanceof Error?a.message:"Failed to fetch organizations";return y("organizations",t),console.error(`Failed to fetch organizations: ${t}`,{operation:"fetch_organizations",options:e}),null}finally{g.organizations=!1}},Y=async e=>{var a,t,r;try{g.currentOrganization=!0,v("currentOrganization");const o=`organization_${e}`,c=B(o);if(c)return O.value=c,c;const{data:i,error:_}=await f.from("organizations").select("*").eq("id",e).single();if(_)throw new Error(_.message);const[n,s,l]=await Promise.all([f.from("contacts").select("id, first_name, last_name, email, position").eq("organization_id",e),f.from("organization_interactions").select("id, type, subject, interaction_date, contact_id, direction").eq("organization_id",e).order("interaction_date",{ascending:!1}).limit(10),f.from("organization_documents").select("id, name, category, size, created_at").eq("organization_id",e)]),w={...i,contact_count:((a=n.data)==null?void 0:a.length)||0,interaction_count:((t=s.data)==null?void 0:t.length)||0,document_count:((r=l.data)==null?void 0:r.length)||0,recent_interactions:(s.data||[]).map(b=>{var k,F,x;return{id:b.id,type:b.type,subject:b.subject,interaction_date:b.interaction_date,contact_name:(k=n.data)!=null&&k.find(C=>C.id===b.contact_id)?`${(F=n.data.find(C=>C.id===b.contact_id))==null?void 0:F.first_name} ${(x=n.data.find(C=>C.id===b.contact_id))==null?void 0:x.last_name}`:void 0}})};return O.value=w,$(o,w),w}catch(o){const c=o instanceof Error?o.message:"Failed to fetch organization";return y("currentOrganization",c),O.value=null,null}finally{g.currentOrganization=!1}},Ce=async e=>{try{g.creating=!0,v("creating");const{data:a,error:t}=await f.from("organizations").insert(e).select().single();if(t)throw console.error(`Failed to create organization: ${t.message}`,{operation:"create_organization",data:e}),new Error(t.message);return q(),await D({resetList:!0}),console.log("Organization created successfully",{organizationName:e.name,organizationIndustry:e.industry}),a}catch(a){const t=a instanceof Error?a.message:"Failed to create organization";return y("creating",t),console.error("Failed to create organization",t,{organizationData:e}),null}finally{g.creating=!1}},Fe=async(e,a)=>{try{g.creating=!0,v("creating");const{data:t,error:r}=await f.from("organizations").insert(e).select().single();if(r)throw new Error(r.message);if(a.mode==="create"&&a.newContacts.length>0){const o=a.newContacts.map(i=>({organization_id:t.id,first_name:i.first_name,last_name:i.last_name,email:i.email,phone:i.phone||null,position:i.title||"Unknown"})),{error:c}=await f.from("contacts").insert(o);c&&console.warn("Failed to create some contacts:",c.message)}else if(a.mode==="select"&&a.selectedContactIds.length>0){const{error:o}=await f.from("contacts").update({organization_id:t.id}).in("id",a.selectedContactIds);o&&console.warn("Failed to associate some contacts:",o.message)}return q(),await D({resetList:!0}),console.log("Organization with contacts created successfully",{organizationName:e.name,organizationIndustry:e.industry,contactMode:a.mode,contactCount:a.mode==="create"?a.newContacts.length:a.selectedContactIds.length}),t}catch(t){const r=t instanceof Error?t.message:"Failed to create organization with contacts";return y("creating",r),console.error("Failed to create organization with contacts",r,{organizationData:e,contactData:a}),null}finally{g.creating=!1}},Pe=async e=>{var a,t,r,o;try{g.creating=!0,v("creating");const{priority_letter:c,...i}=e,_={...i,lead_score:ue(c),status:ne(e),tags:i.tags?i.tags.filter(l=>l!==void 0):null,custom_fields:i.custom_fields,last_contact_date:i.last_contact_date instanceof Date?i.last_contact_date.toISOString():i.last_contact_date,next_follow_up_date:i.next_follow_up_date instanceof Date?i.next_follow_up_date.toISOString():i.next_follow_up_date,is_distributor:i.is_distributor===null?void 0:i.is_distributor,is_principal:i.is_principal===null?void 0:i.is_principal},{data:n,error:s}=await f.from("organizations").insert(_).select().single();if(s)throw s;return(a=e.assigned_contacts)!=null&&a.length&&n&&await re(n.id,e.assigned_contacts),q(),await D({resetList:!0}),console.log("Enhanced organization created successfully",{organizationName:e.name,priority:e.priority_letter,leadScore:_.lead_score,isPrincipal:(t=e.custom_fields)==null?void 0:t.is_principal,isDistributor:(r=e.custom_fields)==null?void 0:r.is_distributor,contactCount:((o=e.assigned_contacts)==null?void 0:o.length)||0}),{success:!0,data:n}}catch(c){const i=c instanceof Error?c.message:"Failed to create organization";return y("creating",i),{success:!1,error:i}}finally{g.creating=!1}},ne=e=>{var a,t;return(a=e.custom_fields)!=null&&a.is_principal?"Principal":(t=e.custom_fields)!=null&&t.is_distributor?"Distributor":e.status},re=async(e,a)=>{try{const{error:t}=await f.from("contacts").update({organization_id:e}).in("id",a);if(t)throw t}catch(t){throw console.warn("Failed to create contact relationships:",t),t}},Re=e=>ue(e),qe=e=>at(e),Q=async(e,a)=>{var t;try{g.updating=!0,v("updating");const{data:r,error:o}=await f.from("organizations").update(a).eq("id",e).select().single();if(o)throw new Error(o.message);return((t=O.value)==null?void 0:t.id)===e&&await Y(e),q(),await D({resetList:!0}),r}catch(r){const o=r instanceof Error?r.message:"Failed to update organization";return y("updating",o),null}finally{g.updating=!1}},Ue=async(e,a,t)=>{var r;try{g.updating=!0,v("updating");const{data:o,error:c}=await f.from("organizations").update(a).eq("id",e).select().single();if(c)throw new Error(c.message);if(t.mode==="create"&&t.newContacts.length>0){const i=t.newContacts.map(n=>({organization_id:e,first_name:n.first_name,last_name:n.last_name,email:n.email,phone:n.phone||null,position:n.title||"Unknown"})),{error:_}=await f.from("contacts").insert(i);_&&console.warn("Failed to create some contacts:",_.message)}else if(t.mode==="select"&&t.selectedContactIds.length>0){const{error:i}=await f.from("contacts").update({organization_id:e}).in("id",t.selectedContactIds);i&&console.warn("Failed to associate some contacts:",i.message)}return((r=O.value)==null?void 0:r.id)===e&&await Y(e),q(),await D({resetList:!0}),console.log("Organization with contacts updated successfully",{organizationId:e,contactMode:t.mode,contactCount:t.mode==="create"?t.newContacts.length:t.selectedContactIds.length}),o}catch(o){const c=o instanceof Error?o.message:"Failed to update organization with contacts";return y("updating",c),null}finally{g.updating=!1}},ie=async e=>{var a;try{g.deleting=!0,v("deleting");const{error:t}=await f.from("organizations").delete().eq("id",e);if(t)throw new Error(t.message);return d.value=d.value.filter(r=>r.id!==e),((a=O.value)==null?void 0:a.id)===e&&(O.value=null),q(),!0}catch(t){const r=t instanceof Error?t.message:"Failed to delete organization";return y("deleting",r),!1}finally{g.deleting=!1}},Le=async e=>{L.value=e,p.value.page=1,await D({search:e,resetList:!0})},Be=async()=>{L.value="",p.value.page=1,await D({resetList:!0})},$e=async e=>{m.value={...m.value,...e},p.value.page=1,await D({resetList:!0})},Ae=async()=>{m.value={},p.value.page=1,await D({resetList:!0})},ke=async(e,a)=>{R.value={field:e,order:a},p.value.page=1,await D({resetList:!0})},Z=async e=>{e>=1&&e<=p.value.totalPages&&(p.value.page=e,await D())},Me=async()=>{p.value.hasNext&&await Z(p.value.page+1)},Ne=async()=>{p.value.hasPrevious&&await Z(p.value.page-1)},oe=async()=>{var e,a;try{g.metrics=!0,v("metrics");const t="dashboard_metrics",r=B(t);if(r)return z.value=r,r;const[o,c,i,_,n,s,l,w]=await Promise.all([f.from("organizations").select("id",{count:"exact",head:!0}),f.from("organizations").select("id",{count:"exact",head:!0}).eq("status","Active"),f.from("organizations").select("id",{count:"exact",head:!0}).eq("status","Prospect"),f.from("organizations").select("id",{count:"exact",head:!0}).eq("status","Customer"),f.from("organizations").select("id",{count:"exact",head:!0}).eq("status","Partner"),f.from("organizations").select("annual_revenue, lead_score",{count:"exact"}).not("annual_revenue","is",null),f.from("organizations").select("id",{count:"exact",head:!0}).contains("custom_fields",{is_principal:!0}),f.from("organizations").select("id",{count:"exact",head:!0}).contains("custom_fields",{is_distributor:!0})]),b=new Date,k=new Date(b.getFullYear(),b.getMonth(),1),F=await f.from("organizations").select("id",{count:"exact",head:!0}).gte("created_at",k.toISOString()),x=((e=s.data)==null?void 0:e.reduce((X,ee)=>X+(ee.annual_revenue||0),0))||0,C=(a=s.data)!=null&&a.length?s.data.reduce((X,ee)=>X+(ee.lead_score||0),0)/s.data.length:0,M={totalOrganizations:o.count||0,activeOrganizations:c.count||0,prospects:i.count||0,customers:_.count||0,partners:n.count||0,totalRevenue:x,averageLeadScore:C,monthlyGrowth:F.count||0,industryDistribution:[],statusDistribution:[],recentActivity:[],principalCount:l.count||0,distributorCount:w.count||0};return z.value=M,$(t,M,6e5),M}catch(t){const r=t instanceof Error?t.message:"Failed to fetch dashboard metrics";return y("metrics",r),null}finally{g.metrics=!1}},je=async(e={})=>{try{g.organizations=!0,v("organizations");const a=`available_principals_${JSON.stringify(e)}`;if(e.useCache!==!1){const c=B(a);if(c)return c}const{data:t,error:r}=await f.from("organizations").select("id, name, type, custom_fields").contains("custom_fields",{is_principal:!0}).order("name");if(r)throw new Error(r.message);const o=await Promise.all((t||[]).map(async c=>{let i=0,_=null;if(e.includeContactCount){const{data:n,error:s}=await f.from("contacts").select("id, first_name, last_name, email, phone, is_primary").eq("organization_id",c.id).order("is_primary",{ascending:!1}).limit(1);if(!s&&(n!=null&&n.length)){i=n.length;const l=n[0];_={id:l.id,name:`${l.first_name} ${l.last_name}`,email:l.email,phone:l.phone}}}return{id:c.id,name:c.name,type:c.type,...e.includeContactCount&&{contact_count:i,primary_contact:_}}}));return $(a,o,3e5),o}catch(a){const t=a instanceof Error?a.message:"Failed to fetch available principals";return y("organizations",t),null}finally{g.organizations=!1}},Te=async(e={})=>{try{g.organizations=!0,v("organizations");const a=e.minimumPrincipalCount||2,t=`multi_principal_orgs_${a}`;if(e.useCache!==!1){const _=B(t);if(_)return _}const{data:r,error:o}=await f.from("contact_principals").select(`
          contacts!inner(
            organization_id,
            organizations!inner(id, name, type)
          ),
          organizations!principal_id!inner(id, name)
        `);if(o)throw new Error(o.message);const c=new Map;r==null||r.forEach(_=>{var l;const n=(l=_.contacts)==null?void 0:l.organizations,s=_.organizations;if(n&&s){const w=n.id;c.has(w)||c.set(w,{org:n,principals:new Set,principalNames:[]});const b=c.get(w);b.principals.has(s.id)||(b.principals.add(s.id),b.principalNames.push(s.name))}});const i=Array.from(c.values()).filter(_=>_.principals.size>=a).map(_=>({id:_.org.id,name:_.org.name,type:_.org.type,principal_count:_.principals.size,principal_names:_.principalNames})).sort((_,n)=>n.principal_count-_.principal_count);return $(t,i,3e5),i}catch(a){const t=a instanceof Error?a.message:"Failed to fetch multi-principal organizations";return y("organizations",t),null}finally{g.organizations=!1}},Ke=async()=>{try{g.analytics=!0,v("analytics");const e="principal_analytics",a=B(e);if(a)return a;const{data:t,error:r}=await f.from("organizations").select("id, name, type, custom_fields, annual_revenue, lead_score").or("custom_fields->>is_principal.eq.true,custom_fields->>is_distributor.eq.true");if(r)throw new Error(r.message);const{data:o,error:c}=await f.from("contact_principals").select("principal_id, contact_id");if(c)throw new Error(c.message);const i=new Map;o==null||o.forEach(n=>{const s=i.get(n.principal_id)||0;i.set(n.principal_id,s+1)});const _={principalDistribution:(t==null?void 0:t.filter(n=>{var s;return((s=n.custom_fields)==null?void 0:s.is_principal)===!0}).length)||0,distributorDistribution:(t==null?void 0:t.filter(n=>{var s;return((s=n.custom_fields)==null?void 0:s.is_distributor)===!0}).length)||0,totalPrincipalRevenue:(t==null?void 0:t.filter(n=>{var s;return((s=n.custom_fields)==null?void 0:s.is_principal)===!0}).reduce((n,s)=>n+(s.annual_revenue||0),0))||0,averagePrincipalLeadScore:(()=>{const n=(t==null?void 0:t.filter(s=>{var l;return((l=s.custom_fields)==null?void 0:l.is_principal)===!0&&s.lead_score}))||[];return n.length>0?n.reduce((s,l)=>s+(l.lead_score||0),0)/n.length:0})(),totalContactRelationships:(o==null?void 0:o.length)||0,averageRelationshipsPerPrincipal:i.size>0?Array.from(i.values()).reduce((n,s)=>n+s,0)/i.size:0,topPrincipalsByRelationships:Array.from(i.entries()).sort(([,n],[,s])=>s-n).slice(0,10).map(([n,s])=>{const l=t==null?void 0:t.find(w=>w.id===n);return{id:n,name:(l==null?void 0:l.name)||"Unknown",relationship_count:s}})};return $(e,_,3e5),_}catch(e){const a=e instanceof Error?e.message:"Failed to fetch principal analytics";return y("analytics",a),null}finally{g.analytics=!1}},Ge=async(e={})=>{try{g.organizations=!0,v("organizations");const a=`principals_for_opportunities_${JSON.stringify(e)}`;if(e.useCache!==!1){const n=B(a);if(n)return n}const{data:t,error:r}=await f.from("organizations").select("id, name, type, custom_fields").contains("custom_fields",{is_principal:!0});if(r)throw new Error(r.message);const{data:o,error:c}=await f.from("contact_principals").select("principal_id, contact_id, contacts!inner(organization_id)");if(c)throw new Error(c.message);let i=[];if(e.includeExistingOpportunities){const{data:n,error:s}=await f.from("opportunities").select("organization_id, created_at").order("created_at",{ascending:!1});s||(i=n||[])}const _=(t||[]).map(n=>{const s=(o==null?void 0:o.filter(F=>F.principal_id===n.id))||[],l=e.organizationId?s.filter(F=>{var x;return((x=F.contacts)==null?void 0:x.organization_id)===e.organizationId}):s;let w=0,b=null;if(e.includeExistingOpportunities){const F=s.map(C=>{var M;return(M=C.contacts)==null?void 0:M.organization_id}).filter(Boolean),x=i.filter(C=>F.includes(C.organization_id));w=x.length,x.length>0&&(b=x[0].created_at)}const k=!!(l.length>0&&(w===0||b&&new Date(b)<new Date(Date.now()-30*24*60*60*1e3)));return{id:n.id,name:n.name,organization_type:n.type,contact_relationships:l.length,...e.includeExistingOpportunities&&{existing_opportunities:w,last_opportunity_date:b},recommended_for_batch:k}}).filter(n=>n.contact_relationships>0).sort((n,s)=>n.recommended_for_batch!==s.recommended_for_batch?n.recommended_for_batch?-1:1:s.contact_relationships-n.contact_relationships);return $(a,_,3e5),_}catch(a){const t=a instanceof Error?a.message:"Failed to get principals for opportunity creation";return y("organizations",t),null}finally{g.organizations=!1}},se=async()=>{try{g.analytics=!0,v("analytics");const{data:e,error:a}=await f.from("organizations").select("id, name, lead_score, status, industry, type, annual_revenue").order("lead_score",{ascending:!1}).limit(50);if(a)throw new Error(a.message);const t=(e||[]).map(r=>({id:`analytics-${r.id}`,organization_id:r.id,total_opportunities:0,active_opportunities:0,won_opportunities:0,total_interactions:0,last_activity_date:null,lead_score:r.lead_score||0,conversion_rate:null,average_deal_size:r.annual_revenue}));return G.value=t,t}catch(e){const a=e instanceof Error?e.message:"Failed to fetch analytics";return y("analytics",a),null}finally{g.analytics=!1}},We=async()=>{try{g.performance=!0,v("performance");const{data:e,error:a}=await f.from("organizations").select("id, name, lead_score, created_at, updated_at").order("updated_at",{ascending:!1}).limit(12);if(a)throw new Error(a.message);const t=(e||[]).map((r,o)=>({id:`perf-${o}-${Date.now()}`,organization_id:r.id,month:new Date(r.updated_at||new Date).toISOString().substring(0,7),year:new Date(r.updated_at||new Date).getFullYear(),opportunities_created:0,opportunities_won:0,total_revenue:null,interaction_count:0,lead_score_change:null}));return W.value=t,t}catch(e){const a=e instanceof Error?e.message:"Failed to fetch performance data";return y("performance",a),null}finally{g.performance=!1}},He=async()=>{try{g.leadScoring=!0,v("leadScoring");const{data:e,error:a}=await f.from("organizations").select("id, name, lead_score, updated_at").order("lead_score",{ascending:!1}).limit(100);if(a)throw new Error(a.message);const t=(e||[]).map((r,o)=>({id:`lead-${o}-${Date.now()}`,organization_id:r.id||`org-${o}`,lead_score:r.lead_score||0,scoring_factors:null,last_updated:new Date().toISOString(),score_trend:null}));return H.value=t,t}catch(e){const a=e instanceof Error?e.message:"Failed to fetch lead scoring data";return y("leadScoring",a),null}finally{g.leadScoring=!1}},le=async e=>{var a;try{g.interactions=!0,v("interactions");const t=e||((a=O.value)==null?void 0:a.id);if(!t)throw new Error("No organization ID provided");const{data:r,error:o}=await f.from("organization_interactions").select("*").eq("organization_id",t).order("interaction_date",{ascending:!1});if(o)throw new Error(o.message);const c=(r||[]).map(i=>({id:i.id,organization_id:i.organization_id,interaction_type:"Other",subject:i.subject||"Interaction",description:i.description||"",interaction_date:i.interaction_date,duration_minutes:i.duration_minutes,outcome:"Scheduled",notes:i.description||"",contact_id:i.contact_id,direction:i.direction||"Outbound",follow_up_date:null,created_at:i.created_at||new Date().toISOString(),updated_at:i.updated_at||new Date().toISOString(),created_by_user_id:i.created_by_user_id}));return J.value=c,c}catch(t){const r=t instanceof Error?t.message:"Failed to fetch interactions";return y("interactions",r),null}finally{g.interactions=!1}},Je=async e=>{try{const{data:a,error:t}=await f.from("organization_interactions").insert({organization_id:e.organization_id,contact_id:e.contact_id||null,subject:e.subject||"Interaction",description:e.description||null,direction:e.direction||null,duration_minutes:e.duration_minutes||null,created_by_user_id:e.created_by_user_id||null}).select().single();if(t)throw new Error(t.message);return await le(e.organization_id),{id:a.id,organization_id:a.organization_id,interaction_type:"Other",subject:a.subject||"Interaction",interaction_date:a.created_at||new Date().toISOString(),notes:"",outcome:null,created_at:a.created_at||new Date().toISOString(),updated_at:a.updated_at||new Date().toISOString()}}catch(a){const t=a instanceof Error?a.message:"Failed to create interaction";return y("interactions",t),null}},ce=async e=>{var a;try{g.documents=!0,v("documents");const t=e||((a=O.value)==null?void 0:a.id);if(!t)throw new Error("No organization ID provided");const{data:r,error:o}=await f.from("organization_documents").select("*").eq("organization_id",t).order("created_at",{ascending:!1});if(o)throw new Error(o.message);const c=(r||[]).map(i=>({id:i.id,organization_id:i.organization_id,document_name:i.title||"Unnamed Document",document_type:i.file_type||"Other",file_path:i.external_url||"",file_size:i.file_size_bytes||null,uploaded_at:i.created_at||new Date().toISOString(),uploaded_by:i.created_by_user_id||null}));return V.value=c,c}catch(t){const r=t instanceof Error?t.message:"Failed to fetch documents";return y("documents",r),null}finally{g.documents=!1}};return{organizations:d,currentOrganization:O,analyticsData:G,performanceData:W,leadScoringData:H,dashboardMetrics:z,interactions:J,documents:V,searchQuery:L,appliedFilters:m,sortConfig:R,pagination:p,lastRefreshed:K,loading:g,isLoading:_e,errors:P,hasErrors:fe,currentError:pe,hasOrganizations:ge,totalOrganizations:me,organizationStats:he,topPerformingOrganizations:ye,organizationsByStatus:ve,recentOrganizations:be,priorityOptions:ze,foodBeverageSegments:we,distributorOrganizations:Oe,principalOrganizations:Ee,getOrganizationsForPrincipals:De,principalRelatedOrganizations:Se,fetchOrganizations:D,fetchOrganization:Y,fetchOrganizationsByPrincipal:xe,createOrganization:Ce,createOrganizationWithContacts:Fe,createOrganizationWithEnhancedForm:Pe,updateOrganization:Q,updateOrganizationWithContacts:Ue,deleteOrganization:ie,searchOrganizations:Le,clearSearch:Be,applyFilters:$e,clearFilters:Ae,setSorting:ke,setPage:Z,nextPage:Me,previousPage:Ne,fetchDashboardMetrics:oe,fetchAnalytics:se,fetchPerformanceData:We,fetchLeadScoringData:He,fetchPrincipalAnalytics:Ke,fetchAvailablePrincipals:je,fetchMultiPrincipalOrganizations:Te,getPrincipalsForOpportunityCreation:Ge,fetchInteractions:le,createInteraction:Je,fetchDocuments:ce,createDocument:async e=>{try{const{data:a,error:t}=await f.from("organization_documents").insert(e).select().single();if(t)throw new Error(t.message);return await ce(e.organization_id),{id:a.id,organization_id:a.organization_id,document_name:"Document",document_type:"general",file_path:"",file_size:0,uploaded_at:a.created_at||new Date().toISOString(),uploaded_by:null}}catch(a){const t=a instanceof Error?a.message:"Failed to create document";return y("documents",t),null}},performBulkOperation:async e=>{var a,t;try{g.bulkOperations=!0,v("bulkOperations");let r=0,o=0;const c=[];for(const i of e.organizationIds)try{switch(e.type){case"update_status":(a=e.data)!=null&&a.status&&(await Q(i,{status:e.data.status}),r++);break;case"delete":await ie(i),r++;break;case"add_tags":(t=e.data)!=null&&t.tags&&d.value.find(n=>n.id===i)&&(await Q(i,{tags:e.data.tags}),r++);break;default:throw new Error(`Unsupported bulk operation: ${e.type}`)}}catch(_){o++,c.push({id:i,error:_ instanceof Error?_.message:"Unknown error"})}return{operation:e,success:o===0,total:e.organizationIds.length,successful:r,failed:o,errors:c}}catch(r){const o=r instanceof Error?r.message:"Failed to perform bulk operation";return y("bulkOperations",o),{operation:e,success:!1,total:e.organizationIds.length,successful:0,failed:e.organizationIds.length,errors:e.organizationIds.map(c=>({id:c,error:o}))}}finally{g.bulkOperations=!1}},getOrganizationById:e=>d.value.find(a=>a.id===e),organizationExists:e=>d.value.some(a=>a.id===e),refreshAllData:async()=>{q(),await Promise.all([D({resetList:!0}),oe(),se()]),K.value=new Date},resetStore:()=>{d.value=[],O.value=null,G.value=[],W.value=[],H.value=[],z.value=null,J.value=[],V.value=[],L.value="",m.value={},R.value={field:"name",order:"asc"},p.value={page:1,limit:20,total:0,totalPages:0,hasNext:!1,hasPrevious:!1},Object.keys(g).forEach(e=>{g[e]=!1}),ae(),q(),K.value=null},clearErrors:ae,clearError:v,clearCache:q,convertPriorityLetterToScore:Re,convertScoreToPriorityLetter:qe,getAutoStatus:ne,createContactRelationships:re}});export{et as o,gt as u};
//# sourceMappingURL=organizationStore-C4EDmZw3.js.map
