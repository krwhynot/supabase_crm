import{H as $,x as A,r as B,c as w}from"./index-CtjJHjR0.js";import{s as g}from"./supabaseClient-Dum322BS.js";class R{async getProducts(t={}){try{let e=g.from("products").select("*");t.search&&(e=e.or(`name.ilike.%${t.search}%,description.ilike.%${t.search}%,sku.ilike.%${t.search}%`)),t.category&&typeof t.category=="string"&&t.category.trim()!==""&&(e=e.eq("category",t.category)),t.is_active!==void 0&&(e=e.eq("is_active",t.is_active));const c=t.sortBy==="principal_count"?"name":t.sortBy||"name",o=t.sortOrder||"asc";e=e.order(c,{ascending:o==="asc"}),t.limit&&(e=e.limit(t.limit)),t.offset&&(e=e.range(t.offset,t.offset+(t.limit||50)-1));const{data:n,error:l}=await e;return l?(console.error("Error fetching products:",l),{data:null,error:`Failed to fetch products: ${l.message}`,success:!1}):{data:(n||[]).map(p=>({...p,is_active:p.is_active??!0,category:p.category,unit_price:p.suggested_retail_price,principal_ids:[],principal_names:[],principal_count:0})),error:null,success:!0}}catch(e){return console.error("Unexpected error fetching products:",e),{data:null,error:"An unexpected error occurred while fetching products",success:!1}}}async getProductsForPrincipals(t){try{const{data:e,error:c}=await g.from("products").select("id, name, category, description, suggested_retail_price, is_active").eq("is_active",!0);return c?(console.error("Error fetching products for principals:",c),{data:null,error:`Failed to fetch products for principals: ${c.message}`,success:!1}):{data:(e||[]).map(n=>({id:n.id,name:n.name,category:n.category,description:n.description,unit_price:n.suggested_retail_price,is_active:n.is_active??!0,available_principals:t})),error:null,success:!0}}catch(e){return console.error("Unexpected error fetching products for principals:",e),{data:null,error:"An unexpected error occurred while fetching products for principals",success:!1}}}async getProduct(t){try{const{data:e,error:c}=await g.from("products").select("*").eq("id",t).single();return c?(console.error("Error fetching product:",c),{data:null,error:`Failed to fetch product: ${c.message}`,success:!1}):{data:{...e,category:e.category,unit_price:e.suggested_retail_price,created_by:null},error:null,success:!0}}catch(e){return console.error("Unexpected error fetching product:",e),{data:null,error:"An unexpected error occurred while fetching the product",success:!1}}}async createProduct(t){try{const{data:e,error:c}=await g.from("products").insert(t).select().single();return c?(console.error("Error creating product:",c),{data:null,error:`Failed to create product: ${c.message}`,success:!1}):{data:{...e,category:e.category,unit_price:e.suggested_retail_price,created_by:null},error:null,success:!0}}catch(e){return console.error("Unexpected error creating product:",e),{data:null,error:"An unexpected error occurred while creating the product",success:!1}}}async updateProduct(t,e){try{const{data:c,error:o}=await g.from("products").update(e).eq("id",t).select().single();return o?(console.error("Error updating product:",o),{data:null,error:`Failed to update product: ${o.message}`,success:!1}):{data:{...c,category:c.category,unit_price:c.suggested_retail_price,created_by:null},error:null,success:!0}}catch(c){return console.error("Unexpected error updating product:",c),{data:null,error:"An unexpected error occurred while updating the product",success:!1}}}async deleteProduct(t){try{const{error:e}=await g.from("products").update({is_active:!1,deleted_at:new Date().toISOString()}).eq("id",t);return e?(console.error("Error deleting product:",e),{data:null,error:`Failed to delete product: ${e.message}`,success:!1}):{data:!0,error:null,success:!0}}catch(e){return console.error("Unexpected error deleting product:",e),{data:null,error:"An unexpected error occurred while deleting the product",success:!1}}}async assignProductToPrincipals(t,e){try{await g.from("product_principals").delete().eq("product_id",t);const c=e.map(i=>({product_id:t,principal_id:i})),{data:o,error:n}=await g.from("product_principals").insert(c).select(`
          *,
          products!inner(name, category),
          organizations!inner(name, type)
        `);return n?(console.error("Error assigning product to principals:",n),{data:null,error:`Failed to assign product to principals: ${n.message}`,success:!1}):{data:(o||[]).map(i=>{var p,m,P,h;return{id:i.id,product_id:i.product_id,principal_id:i.principal_id,created_at:i.created_at||new Date().toISOString(),product_name:((p=i.products)==null?void 0:p.name)||"",product_category:(m=i.products)==null?void 0:m.category,principal_name:((P=i.organizations)==null?void 0:P.name)||"",principal_type:((h=i.organizations)==null?void 0:h.type)||""}}),error:null,success:!0}}catch(c){return console.error("Unexpected error assigning product to principals:",c),{data:null,error:"An unexpected error occurred while assigning product to principals",success:!1}}}async getProductStats(){var t;try{const[e,c]=await Promise.all([g.from("products").select("*",{count:"exact",head:!0}),g.from("products").select("*",{count:"exact",head:!0}).eq("is_active",!0)]);if(e.error)throw e.error;if(c.error)throw c.error;const o=e.count||0,n=c.count||0,{data:l,error:i}=await g.from("products").select("category").eq("is_active",!0);if(i)throw i;const p=(l||[]).reduce((f,x)=>{const k=x.category;return k&&(f[k]=(f[k]||0)+1),f},{}),{data:m,error:P}=await g.from("products").select("suggested_retail_price").eq("is_active",!0).not("suggested_retail_price","is",null);if(P)throw P;const h=(m||[]).map(f=>f.suggested_retail_price).filter(f=>f!==null),b=h.length>0?h.reduce((f,x)=>f+x,0)/h.length:0,S=h.length>0?Math.min(...h):0,U=h.length>0?Math.max(...h):0,O=(t=Object.entries(p).sort(([,f],[,x])=>x-f)[0])==null?void 0:t[0],v=new Date;v.setDate(v.getDate()-30);const{count:C,error:F}=await g.from("products").select("*",{count:"exact",head:!0}).gte("created_at",v.toISOString());if(F)throw F;return{data:{total_products:o,active_products:n,inactive_products:o-n,products_by_category:p,average_price:b,price_range:{min:S,max:U},most_common_category:O,recently_added:C||0},error:null,success:!0}}catch(e){return console.error("Error fetching product stats:",e),{data:null,error:"Failed to fetch product statistics",success:!1}}}async searchProducts(t,e={}){try{let c=g.from("products").select("*");e.category&&e.category.length>0&&(c=c.in("category",e.category)),e.is_active!==void 0&&(c=c.eq("is_active",e.is_active)),e.price_min!==void 0&&(c=c.gte("suggested_retail_price",e.price_min)),e.price_max!==void 0&&(c=c.lte("suggested_retail_price",e.price_max)),t.trim()&&(c=c.or(`name.ilike.%${t}%,description.ilike.%${t}%,sku.ilike.%${t}%`));const{data:o,error:n}=await c;if(n)return console.error("Error searching products:",n),{data:null,error:`Failed to search products: ${n.message}`,success:!1};const l=(o||[]).map(i=>{const p=this.calculateMatchScore(i,t),m=this.getHighlightFields(i,t);return{id:String(i.id),name:i.name,category:i.category,description:i.description,unit_price:i.suggested_retail_price,match_score:p,available_for_principals:[],highlight_fields:m}});return l.sort((i,p)=>p.match_score-i.match_score),{data:l,error:null,success:!0}}catch(c){return console.error("Unexpected error searching products:",c),{data:null,error:"An unexpected error occurred while searching products",success:!1}}}async performBulkOperation(t){var e;try{const c={success:!0,processed_count:0,failed_count:0,errors:[],updated_products:[]};for(const o of t.product_ids)try{let n={};switch(t.operation){case"activate":n={is_active:!0};break;case"deactivate":n={is_active:!1};break;case"delete":n={is_active:!1,deleted_at:new Date().toISOString()};break;case"update_category":(e=t.parameters)!=null&&e.category&&(n={category:t.parameters.category});break;default:throw new Error(`Unsupported operation: ${t.operation}`)}const{data:l,error:i}=await g.from("products").update(n).eq("id",o).select().single();if(i)throw i;c.updated_products.push({...l,category:l.category,unit_price:l.suggested_retail_price,created_by:null}),c.processed_count++}catch(n){const{data:l}=await g.from("products").select("name").eq("id",o).single();c.errors.push({product_id:o,product_name:(l==null?void 0:l.name)||"Unknown Product",error_message:n.message||"Unknown error"}),c.failed_count++}return c.success=c.failed_count===0,{data:c,error:null,success:!0}}catch(c){return console.error("Unexpected error performing bulk operation:",c),{data:null,error:"An unexpected error occurred during bulk operation",success:!1}}}calculateMatchScore(t,e){if(!e.trim())return 1;const c=e.toLowerCase();let o=0;return t.name.toLowerCase()===c?o+=100:t.name.toLowerCase().includes(c)&&(o+=50),t.sku&&t.sku.toLowerCase().includes(c)&&(o+=30),t.description&&t.description.toLowerCase().includes(c)&&(o+=10),t.category.toLowerCase().includes(c)&&(o+=5),o}getHighlightFields(t,e){if(!e.trim())return[];const c=e.toLowerCase(),o=[];return t.name.toLowerCase().includes(c)&&o.push("name"),t.sku&&t.sku.toLowerCase().includes(c)&&o.push("sku"),t.description&&t.description.toLowerCase().includes(c)&&o.push("description"),t.category.toLowerCase().includes(c)&&o.push("category"),o}}const _=new R,H=$("product",()=>{const r=A({products:[],selectedProduct:null,productOptions:[],loading:!1,creating:!1,updating:!1,deleting:!1,error:null,searchResults:[],searchTerm:"",stats:null,bulkOperationResult:null}),t=B({}),e=w(()=>r.loading||r.creating||r.updating||r.deleting),c=w(()=>!!r.error),o=w(()=>r.products.length),n=w(()=>r.products.filter(a=>a.is_active).length),l=w(()=>a=>r.products.find(s=>s.id===a)),i=w(()=>a=>r.products.filter(s=>s.category===a)),p=w(()=>a=>r.productOptions.filter(s=>s.available_principals.some(u=>a.includes(u)))),m=w(()=>{const a=new Set;return r.products.forEach(s=>{s.category&&a.add(s.category)}),Array.from(a)}),P=async(a={})=>{r.loading=!0,r.error=null;try{const s=await _.getProducts(a);s.success&&s.data?r.products=s.data:r.error=s.error||"Failed to fetch products"}catch(s){r.error=s instanceof Error?s.message:"Unexpected error occurred"}finally{r.loading=!1}};return{...r,activeFilters:t,isLoading:e,hasError:c,productCount:o,activeProductCount:n,getProductById:l,getProductsByCategory:i,getProductsForPrincipals:p,categoriesInUse:m,fetchProducts:P,fetchProductsForPrincipals:async a=>{r.loading=!0,r.error=null;try{const s=await _.getProductsForPrincipals(a);s.success&&s.data?r.productOptions=s.data:r.error=s.error||"Failed to fetch products for principals"}catch(s){r.error=s instanceof Error?s.message:"Unexpected error occurred"}finally{r.loading=!1}},fetchProductById:async a=>{r.loading=!0,r.error=null;try{const s=await _.getProduct(a);s.success&&s.data?r.selectedProduct=s.data:r.error=s.error||"Failed to fetch product"}catch(s){r.error=s instanceof Error?s.message:"Unexpected error occurred"}finally{r.loading=!1}},createProduct:async a=>{r.creating=!0,r.error=null;try{const s=await _.createProduct(a);if(s.success&&s.data){const u={...s.data,principal_ids:[],principal_names:[],principal_count:0};return r.products.unshift(u),!0}else return r.error=s.error||"Failed to create product",!1}catch(s){return r.error=s instanceof Error?s.message:"Unexpected error occurred",!1}finally{r.creating=!1}},updateProduct:async(a,s)=>{var u;r.updating=!0,r.error=null;try{const d=await _.updateProduct(a,s);if(d.success&&d.data){const y=r.products.findIndex(E=>E.id===a);return y!==-1&&(r.products[y]={...r.products[y],...d.data}),((u=r.selectedProduct)==null?void 0:u.id)===a&&(r.selectedProduct=d.data),!0}else return r.error=d.error||"Failed to update product",!1}catch(d){return r.error=d instanceof Error?d.message:"Unexpected error occurred",!1}finally{r.updating=!1}},deleteProduct:async a=>{var s;r.deleting=!0,r.error=null;try{const u=await _.deleteProduct(a);if(u.success){const d=r.products.findIndex(y=>y.id===a);return d!==-1&&(r.products[d].is_active=!1),((s=r.selectedProduct)==null?void 0:s.id)===a&&(r.selectedProduct=null),!0}else return r.error=u.error||"Failed to delete product",!1}catch(u){return r.error=u instanceof Error?u.message:"Unexpected error occurred",!1}finally{r.deleting=!1}},assignProductToPrincipals:async(a,s)=>{r.updating=!0,r.error=null;try{const u=await _.assignProductToPrincipals(a,s);if(u.success&&u.data){const d=r.products.findIndex(y=>y.id===a);return d!==-1&&(r.products[d].principal_ids=s,r.products[d].principal_count=s.length),!0}else return r.error=u.error||"Failed to assign product to principals",!1}catch(u){return r.error=u instanceof Error?u.message:"Unexpected error occurred",!1}finally{r.updating=!1}},searchProducts:async(a,s={})=>{r.loading=!0,r.error=null,r.searchTerm=a;try{const u=await _.searchProducts(a,s);u.success&&u.data?r.searchResults=u.data:r.error=u.error||"Failed to search products"}catch(u){r.error=u instanceof Error?u.message:"Unexpected error occurred"}finally{r.loading=!1}},fetchStats:async()=>{r.loading=!0,r.error=null;try{const a=await _.getProductStats();a.success&&a.data?r.stats=a.data:r.error=a.error||"Failed to fetch product statistics"}catch(a){r.error=a instanceof Error?a.message:"Unexpected error occurred"}finally{r.loading=!1}},performBulkOperation:async a=>{r.updating=!0,r.error=null,r.bulkOperationResult=null;try{const s=await _.performBulkOperation(a);return s.success&&s.data?(r.bulkOperationResult=s.data,s.data.success&&a.product_ids.forEach(u=>{var y;const d=r.products.findIndex(E=>E.id===u);if(d!==-1)switch(a.operation){case"activate":r.products[d].is_active=!0;break;case"deactivate":case"delete":r.products[d].is_active=!1;break;case"update_category":(y=a.parameters)!=null&&y.category&&(r.products[d].category=a.parameters.category);break}}),s.data.success):(r.error=s.error||"Failed to perform bulk operation",!1)}catch(s){return r.error=s instanceof Error?s.message:"Unexpected error occurred",!1}finally{r.updating=!1}},clearError:()=>{r.error=null},clearSelectedProduct:()=>{r.selectedProduct=null},clearSearchResults:()=>{r.searchResults=[],r.searchTerm=""},clearBulkResults:()=>{r.bulkOperationResult=null},resetFilters:()=>{t.value={}},refresh:async()=>{await P()}}});export{H as u};
//# sourceMappingURL=productStore-9Dx38iZU.js.map
