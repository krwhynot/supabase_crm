import{d as t}from"./pinia-CUC4VGP7.js";import{s as e}from"./supabaseClient-Bh63a8tq.js";import{c as a,b as n,a as r,f as i,e as o,d as s,g as c}from"./yup-D1qa_jJc.js";import{r as l,b as u,c as d}from"./vue-runtime-Ds28nt_E.js";const p=a({name:n().required("Organization name is required").trim().min(1,"Organization name cannot be empty").max(255,"Organization name must be less than 255 characters"),legal_name:n().nullable().max(255,"Legal name must be less than 255 characters"),description:n().nullable(),industry:n().nullable().max(255,"Industry must be less than 255 characters"),type:c().oneOf(["B2B","B2C","B2B2C","Non-Profit","Government","Other"]).nullable(),size:c().oneOf(["Startup","Small","Medium","Large","Enterprise"]).nullable(),status:c().oneOf(["Active","Inactive","Prospect","Customer","Partner","Vendor"]).nullable(),website:n().nullable().matches(/^https?:\/\/[^\s]+$/,"Website must be a valid URL starting with http:// or https://"),email:n().nullable().email("Email must be a valid email address"),primary_phone:n().nullable().max(50,"Primary phone must be less than 50 characters"),secondary_phone:n().nullable().max(50,"Secondary phone must be less than 50 characters"),address_line_1:n().nullable().max(255,"Address line 1 must be less than 255 characters"),address_line_2:n().nullable().max(255,"Address line 2 must be less than 255 characters"),city:n().nullable().max(100,"City must be less than 100 characters"),state_province:n().nullable().max(100,"State/Province must be less than 100 characters"),postal_code:n().nullable().max(20,"Postal code must be less than 20 characters"),country:n().nullable().max(100,"Country must be less than 100 characters"),founded_year:s().nullable().integer("Founded year must be a whole number").min(1800,"Founded year must be 1800 or later").max((new Date).getFullYear()+1,"Founded year cannot be in the future"),employees_count:s().nullable().integer("Employee count must be a whole number").min(0,"Employee count cannot be negative"),annual_revenue:s().nullable().min(0,"Annual revenue cannot be negative"),currency_code:n().nullable().matches(/^[A-Z]{3}$/,"Currency code must be 3 uppercase letters (e.g., USD)"),lead_source:n().nullable().max(255,"Lead source must be less than 255 characters"),lead_score:s().nullable().integer("Lead score must be a whole number").min(0,"Lead score cannot be negative").max(100,"Lead score cannot exceed 100"),tags:o().of(n()).nullable(),custom_fields:a().nullable(),parent_org_id:n().nullable().uuid("Parent organization ID must be a valid UUID"),assigned_user_id:n().nullable().uuid("Assigned user ID must be a valid UUID"),last_contact_date:i().nullable(),next_follow_up_date:i().nullable(),is_principal:r().nullable(),is_distributor:r().nullable(),distributor_id:n().nullable().uuid("Distributor ID must be a valid UUID"),account_manager_id:n().nullable().uuid("Account Manager ID must be a valid UUID")}),_=p;p.partial(),a({organization_id:n().required("Organization ID is required").uuid("Organization ID must be a valid UUID"),contact_id:n().nullable().uuid("Contact ID must be a valid UUID"),type:c().oneOf(["Email","Phone","Meeting","Demo","Proposal","Contract","Note","Task","Event","Social","Website","Other"]).required("Interaction type is required"),direction:c().oneOf(["Inbound","Outbound"]).nullable(),subject:n().nullable().max(500,"Subject must be less than 500 characters").test("not-empty","Subject cannot be empty if provided",function(t){return null==t||t.trim().length>0}),description:n().nullable(),interaction_date:i().required("Interaction date is required"),duration_minutes:s().nullable().integer("Duration must be a whole number of minutes").min(0,"Duration cannot be negative"),tags:o().of(n()).nullable(),metadata:a().nullable(),created_by_user_id:n().nullable().uuid("Created by user ID must be a valid UUID")}).partial().shape({organization_id:n().uuid("Organization ID must be a valid UUID")}),a({organization_id:n().required("Organization ID is required").uuid("Organization ID must be a valid UUID"),name:n().required("Document name is required").trim().min(1,"Document name cannot be empty").max(500,"Document name must be less than 500 characters"),description:n().nullable(),file_type:n().nullable().max(50,"File type must be less than 50 characters"),file_size_bytes:s().nullable().integer("File size must be a whole number").min(0,"File size cannot be negative"),storage_path:n().nullable().max(1e3,"Storage path must be less than 1000 characters"),external_url:n().nullable().matches(/^https?:\/\/[^\s]+$/,"External URL must be a valid URL starting with http:// or https://").max(1e3,"External URL must be less than 1000 characters"),category:n().nullable().max(255,"Category must be less than 255 characters"),tags:o().of(n()).nullable(),is_public:r().nullable(),access_level:n().nullable().max(50,"Access level must be less than 50 characters"),version:n().nullable().max(50,"Version must be less than 50 characters"),parent_document_id:n().nullable().uuid("Parent document ID must be a valid UUID"),uploaded_by_user_id:n().nullable().uuid("Uploaded by user ID must be a valid UUID")}).test("has-location","Document must have either a storage path or external URL",function(t){return!(!t.storage_path&&!t.external_url)}).partial().shape({organization_id:n().uuid("Organization ID must be a valid UUID")}),a({organization_id:n().required("Organization ID is required").uuid("Organization ID must be a valid UUID"),period_start:i().required("Period start date is required"),period_end:i().required("Period end date is required").test("after-start","Period end must be after period start",function(t){const{period_start:e}=this.parent;return!e||!t||t>e}),period_type:n().required("Period type is required").oneOf(["daily","weekly","monthly","quarterly","yearly"],"Period type must be one of: daily, weekly, monthly, quarterly, yearly"),total_interactions:s().nullable().integer("Total interactions must be a whole number").min(0,"Total interactions cannot be negative"),email_interactions:s().nullable().integer("Email interactions must be a whole number").min(0,"Email interactions cannot be negative"),phone_interactions:s().nullable().integer("Phone interactions must be a whole number").min(0,"Phone interactions cannot be negative"),meeting_interactions:s().nullable().integer("Meeting interactions must be a whole number").min(0,"Meeting interactions cannot be negative"),revenue_generated:s().nullable().min(0,"Revenue generated cannot be negative"),deals_closed:s().nullable().integer("Deals closed must be a whole number").min(0,"Deals closed cannot be negative"),deals_in_progress:s().nullable().integer("Deals in progress must be a whole number").min(0,"Deals in progress cannot be negative"),lead_score_change:s().nullable().integer("Lead score change must be a whole number"),conversion_events:s().nullable().integer("Conversion events must be a whole number").min(0,"Conversion events cannot be negative"),documents_added:s().nullable().integer("Documents added must be a whole number").min(0,"Documents added cannot be negative"),documents_accessed:s().nullable().integer("Documents accessed must be a whole number").min(0,"Documents accessed cannot be negative"),new_contacts_added:s().nullable().integer("New contacts added must be a whole number").min(0,"New contacts added cannot be negative"),active_contacts:s().nullable().integer("Active contacts must be a whole number").min(0,"Active contacts cannot be negative"),custom_metrics:a().nullable()}).partial().shape({organization_id:n().uuid("Organization ID must be a valid UUID")});const m=_;m.shape({status:c().oneOf(["Prospect","Active Customer","Inactive Customer","Other","Principal","Distributor"]).required("Organization status is required"),custom_fields:a({is_principal:r().nullable(),is_distributor:r().nullable(),distributor_id:n().nullable().uuid("Distributor ID must be valid UUID"),account_manager_id:n().nullable().uuid("Account Manager ID must be valid UUID"),food_beverage_segment:n().nullable().max(255)}).test("principal-distributor-exclusive","Cannot be both Principal and Distributor",function(t){return!(t?.is_principal&&t?.is_distributor)}),priority_letter:c().oneOf(["A","B","C","D"]).required("Priority is required"),assigned_contacts:o().of(n().uuid()).nullable()}),a({search:n().nullable().optional(),industry:n().nullable().optional(),type:c().oneOf(["B2B","B2C","B2B2C","Non-Profit","Government","Other"]).nullable().optional(),size:c().oneOf(["Startup","Small","Medium","Large","Enterprise"]).nullable().optional(),status:c().oneOf(["Active","Inactive","Prospect","Customer","Partner","Vendor"]).nullable().optional(),country:n().nullable().optional(),min_employees:s().min(0).nullable().optional(),max_employees:s().min(0).nullable().optional(),min_revenue:s().min(0).nullable().optional(),max_revenue:s().min(0).nullable().optional(),min_lead_score:s().min(0).max(100).nullable().optional(),max_lead_score:s().min(0).max(100).nullable().optional(),tags:o().of(n()).nullable().optional(),limit:s().min(1).max(100).optional().default(20),offset:s().min(0).optional().default(0),sortBy:c().oneOf(["name","legal_name","industry","type","size","status","lead_score","employees_count","annual_revenue","founded_year","created_at","updated_at","last_contact_date","next_follow_up_date"]).optional().default("name"),sortOrder:c().oneOf(["asc","desc"]).optional().default("asc")});const g=[{value:90,label:"A",description:"Highest priority - Strategic accounts"},{value:70,label:"B",description:"High priority - Major opportunities"},{value:50,label:"C",description:"Medium priority - Qualified prospects"},{value:30,label:"D",description:"Lower priority - New prospects"}],y=t=>({A:90,B:70,C:50,D:30}[t]),h=t("organization",()=>{const t=l([]),a=l(null),n=l([]),r=l([]),i=l([]),o=l(null),s=l([]),c=l([]),p=u({organizations:!1,currentOrganization:!1,analytics:!1,performance:!1,leadScoring:!1,metrics:!1,interactions:!1,documents:!1,creating:!1,updating:!1,deleting:!1,bulkOperations:!1}),_=u({organizations:"",currentOrganization:"",analytics:"",performance:"",leadScoring:"",metrics:"",interactions:"",documents:"",creating:"",updating:"",deleting:"",bulkOperations:""}),m=l(""),h=l({}),f=l({field:"name",order:"asc"}),b=l({page:1,limit:20,total:0,totalPages:0,hasNext:!1,hasPrevious:!1}),w=l(null),v=u({}),z=d(()=>t.value.length>0),D=d(()=>b.value.total),O=d(()=>Object.values(p).some(t=>t)),E=d(()=>Object.values(_).some(t=>""!==t)),P=d(()=>{const t=Object.keys(_).find(t=>""!==_[t]);return t?_[t]:""}),I=d(()=>o.value?{total:o.value.totalOrganizations,active:o.value.activeOrganizations,prospects:o.value.prospects,customers:o.value.customers,partners:o.value.partners,totalRevenue:o.value.totalRevenue,averageLeadScore:o.value.averageLeadScore,thisMonth:o.value.monthlyGrowth>0?Math.round(o.value.totalOrganizations*o.value.monthlyGrowth/100):0,thisWeek:Math.round((o.value.monthlyGrowth>0?o.value.totalOrganizations*o.value.monthlyGrowth/100:0)/4)}:null),F=d(()=>t.value.filter(t=>null!==t.lead_score).sort((t,e)=>(e.lead_score||0)-(t.lead_score||0)).slice(0,10)),U=d(()=>t.value.reduce((t,e)=>{const a=e.status||"Unknown";return t[a]=(t[a]||0)+1,t},{})),S=d(()=>{const e=new Date;return e.setDate(e.getDate()-30),t.value.filter(t=>!!t.created_at&&new Date(t.created_at)>=e)}),C=d(()=>g),B=d(()=>[{value:"Food & Beverage - Restaurants",label:"Food & Beverage - Restaurants",priority:!0},{value:"Food & Beverage - Manufacturing",label:"Food & Beverage - Manufacturing",priority:!0},{value:"Food & Beverage - Distribution",label:"Food & Beverage - Distribution",priority:!0},{value:"Food & Beverage - Retail",label:"Food & Beverage - Retail",priority:!0},{value:"Food & Beverage - Service",label:"Food & Beverage - Service",priority:!0},{value:"Technology",label:"Technology",priority:!1},{value:"Healthcare",label:"Healthcare",priority:!1},{value:"Manufacturing",label:"Manufacturing",priority:!1},{value:"Retail",label:"Retail",priority:!1},{value:"Financial Services",label:"Financial Services",priority:!1},{value:"Real Estate",label:"Real Estate",priority:!1},{value:"Education",label:"Education",priority:!1},{value:"Government",label:"Government",priority:!1},{value:"Non-Profit",label:"Non-Profit",priority:!1},{value:"Other",label:"Other",priority:!1}]),L=d(()=>t.value.filter(t=>{const e=t;return e.custom_fields&&"object"==typeof e.custom_fields&&"is_distributor"in e.custom_fields&&!0===e.custom_fields.is_distributor})),x=d(()=>t.value.filter(t=>{const e=t;return e.custom_fields&&"object"==typeof e.custom_fields&&"is_principal"in e.custom_fields&&!0===e.custom_fields.is_principal})),A=d(()=>e=>t.value.filter(t=>e.includes(t.id)||t.assigned_principals?.some(t=>e.includes(t)))),$=d(()=>t.value.filter(t=>{const e=t;return!0===e.custom_fields?.is_principal||!0===e.custom_fields?.is_distributor||e.assigned_principals&&e.assigned_principals.length>0})),R=()=>{Object.keys(_).forEach(t=>{_[t]=""})},k=t=>{_[t]=""},M=(t,e)=>{_[t]=e},j=t=>(t=>{const e=v[t];return!!e&&Date.now()-e.timestamp<e.ttl})(t)?v[t].data:null,N=(t,e,a=3e5)=>{v[t]={data:e,timestamp:Date.now(),ttl:a}},q=t=>{t?delete v[t]:Object.keys(v).forEach(t=>delete v[t])},T=async(a={})=>{try{p.organizations=!0,k("organizations"),void 0!==a.page&&(b.value.page=a.page),void 0!==a.limit&&(b.value.limit=a.limit),a.filters&&(h.value={...h.value,...a.filters}),a.sort&&(f.value={...f.value,...a.sort}),void 0!==a.search&&(m.value=a.search);const n=`organizations_${JSON.stringify({page:b.value.page,limit:b.value.limit,filters:h.value,sort:f.value,search:m.value})}`;if(!1!==a.useCache){const e=j(n);if(e)return t.value=a.resetList?e.data:[...t.value,...e.data],b.value=e.pagination,e}let r=e.from("organizations").select("*",{count:"exact"});if(m.value.trim()){const t=m.value.trim();r=r.or(`name.ilike.%${t}%,legal_name.ilike.%${t}%,industry.ilike.%${t}%`)}h.value.industry&&h.value.industry.length>0&&(r=r.in("industry",h.value.industry)),h.value.status&&h.value.status.length>0&&(r=r.in("status",h.value.status)),h.value.type&&h.value.type.length>0&&(r=r.in("type",h.value.type)),h.value.size&&h.value.size.length>0&&(r=r.in("size",h.value.size)),h.value.country&&h.value.country.length>0&&(r=r.in("country",h.value.country)),h.value.leadScoreRange&&(void 0!==h.value.leadScoreRange.min&&(r=r.gte("lead_score",h.value.leadScoreRange.min)),void 0!==h.value.leadScoreRange.max&&(r=r.lte("lead_score",h.value.leadScoreRange.max))),h.value.employeeRange&&(void 0!==h.value.employeeRange.min&&(r=r.gte("employees_count",h.value.employeeRange.min)),void 0!==h.value.employeeRange.max&&(r=r.lte("employees_count",h.value.employeeRange.max))),h.value.revenueRange&&(void 0!==h.value.revenueRange.min&&(r=r.gte("annual_revenue",h.value.revenueRange.min)),void 0!==h.value.revenueRange.max&&(r=r.lte("annual_revenue",h.value.revenueRange.max))),h.value.lastContactDateRange&&(h.value.lastContactDateRange.start&&(r=r.gte("last_contact_date",h.value.lastContactDateRange.start.toISOString())),h.value.lastContactDateRange.end&&(r=r.lte("last_contact_date",h.value.lastContactDateRange.end.toISOString())));const i="asc"===f.value.order;r=r.order(f.value.field,{ascending:i});const o=(b.value.page-1)*b.value.limit;r=r.range(o,o+b.value.limit-1);const{data:s,error:c,count:l}=await r;if(c)throw new Error(c.message);const u=(s||[]).map(t=>({id:t.id||"",name:t.name||"",legal_name:t.legal_name,industry:t.industry,type:t.type,size:t.size,status:t.status,website:t.website,email:t.email,primary_phone:t.primary_phone,city:t.city,country:t.country,employees_count:t.employees_count,annual_revenue:t.annual_revenue,lead_score:t.lead_score,contact_count:void 0,last_interaction_date:t.last_contact_date,next_follow_up_date:t.next_follow_up_date,created_at:t.created_at,updated_at:t.updated_at}));b.value.total=l||0,b.value.totalPages=Math.ceil(b.value.total/b.value.limit),b.value.hasNext=b.value.page<b.value.totalPages,b.value.hasPrevious=b.value.page>1,!1!==a.resetList?t.value=u:t.value=[...t.value,...u];const d={data:u,pagination:{...b.value},filters:{...h.value},sort:{...f.value}};return N(n,d),w.value=new Date,d}catch(n){const t=n instanceof Error?n.message:"Failed to fetch organizations";return M("organizations",t),null}finally{p.organizations=!1}},W=async t=>{try{p.currentOrganization=!0,k("currentOrganization");const n=`organization_${t}`,r=j(n);if(r)return a.value=r,r;const{data:i,error:o}=await e.from("organizations").select("*").eq("id",t).single();if(o)throw new Error(o.message);const[s,c,l]=await Promise.all([e.from("contacts").select("id, first_name, last_name, email, position").eq("organization_id",t),e.from("organization_interactions").select("id, type, subject, interaction_date, contact_id, direction").eq("organization_id",t).order("interaction_date",{ascending:!1}).limit(10),e.from("organization_documents").select("id, name, category, size, created_at").eq("organization_id",t)]),u={...i,contact_count:s.data?.length||0,interaction_count:c.data?.length||0,document_count:l.data?.length||0,recent_interactions:(c.data||[]).map(t=>({id:t.id,type:t.type,subject:t.subject,interaction_date:t.interaction_date,contact_name:s.data?.find(e=>e.id===t.contact_id)?`${s.data.find(e=>e.id===t.contact_id)?.first_name} ${s.data.find(e=>e.id===t.contact_id)?.last_name}`:void 0}))};return a.value=u,N(n,u),u}catch(n){const t=n instanceof Error?n.message:"Failed to fetch organization";return M("currentOrganization",t),a.value=null,null}finally{p.currentOrganization=!1}},G=t=>t.custom_fields?.is_principal?"Principal":t.custom_fields?.is_distributor?"Distributor":t.status,H=async(t,a)=>{try{const{error:n}=await e.from("contacts").update({organization_id:t}).in("id",a);if(n)throw n}catch(n){throw n}},J=async(t,n)=>{try{p.updating=!0,k("updating");const{data:r,error:i}=await e.from("organizations").update(n).eq("id",t).select().single();if(i)throw new Error(i.message);return a.value?.id===t&&await W(t),q(),await T({resetList:!0}),r}catch(r){const t=r instanceof Error?r.message:"Failed to update organization";return M("updating",t),null}finally{p.updating=!1}},V=async n=>{try{p.deleting=!0,k("deleting");const{error:r}=await e.from("organizations").delete().eq("id",n);if(r)throw new Error(r.message);return t.value=t.value.filter(t=>t.id!==n),a.value?.id===n&&(a.value=null),q(),!0}catch(r){const t=r instanceof Error?r.message:"Failed to delete organization";return M("deleting",t),!1}finally{p.deleting=!1}},Q=async t=>{t>=1&&t<=b.value.totalPages&&(b.value.page=t,await T())},Z=async()=>{try{p.metrics=!0,k("metrics");const t="dashboard_metrics",a=j(t);if(a)return o.value=a,a;const[n,r,i,s,c,l,u,d]=await Promise.all([e.from("organizations").select("id",{count:"exact",head:!0}),e.from("organizations").select("id",{count:"exact",head:!0}).eq("status","Active"),e.from("organizations").select("id",{count:"exact",head:!0}).eq("status","Prospect"),e.from("organizations").select("id",{count:"exact",head:!0}).eq("status","Customer"),e.from("organizations").select("id",{count:"exact",head:!0}).eq("status","Partner"),e.from("organizations").select("annual_revenue, lead_score",{count:"exact"}).not("annual_revenue","is",null),e.from("organizations").select("id",{count:"exact",head:!0}).contains("custom_fields",{is_principal:!0}),e.from("organizations").select("id",{count:"exact",head:!0}).contains("custom_fields",{is_distributor:!0})]),_=new Date,m=new Date(_.getFullYear(),_.getMonth(),1),g=await e.from("organizations").select("id",{count:"exact",head:!0}).gte("created_at",m.toISOString()),y=l.data?.reduce((t,e)=>t+(e.annual_revenue||0),0)||0,h=l.data?.length?l.data.reduce((t,e)=>t+(e.lead_score||0),0)/l.data.length:0,f={totalOrganizations:n.count||0,activeOrganizations:r.count||0,prospects:i.count||0,customers:s.count||0,partners:c.count||0,totalRevenue:y,averageLeadScore:h,monthlyGrowth:g.count||0,industryDistribution:[],statusDistribution:[],recentActivity:[],principalCount:u.count||0,distributorCount:d.count||0};return o.value=f,N(t,f,6e5),f}catch(t){const e=t instanceof Error?t.message:"Failed to fetch dashboard metrics";return M("metrics",e),null}finally{p.metrics=!1}},K=async()=>{try{p.analytics=!0,k("analytics");const{data:t,error:a}=await e.from("organizations").select("id, name, lead_score, status, industry, type, annual_revenue").order("lead_score",{ascending:!1}).limit(50);if(a)throw new Error(a.message);const r=(t||[]).map(t=>({id:`analytics-${t.id}`,organization_id:t.id,total_opportunities:0,active_opportunities:0,won_opportunities:0,total_interactions:0,last_activity_date:null,lead_score:t.lead_score||0,conversion_rate:null,average_deal_size:t.annual_revenue}));return n.value=r,r}catch(t){const e=t instanceof Error?t.message:"Failed to fetch analytics";return M("analytics",e),null}finally{p.analytics=!1}},X=async t=>{try{p.interactions=!0,k("interactions");const n=t||a.value?.id;if(!n)throw new Error("No organization ID provided");const{data:r,error:i}=await e.from("organization_interactions").select("*").eq("organization_id",n).order("interaction_date",{ascending:!1});if(i)throw new Error(i.message);const o=(r||[]).map(t=>({id:t.id,organization_id:t.organization_id,interaction_type:"Other",subject:t.subject||"Interaction",description:t.description||"",interaction_date:t.interaction_date,duration_minutes:t.duration_minutes,outcome:"Scheduled",notes:t.description||"",contact_id:t.contact_id,direction:t.direction||"Outbound",follow_up_date:null,created_at:t.created_at||(new Date).toISOString(),updated_at:t.updated_at||(new Date).toISOString(),created_by_user_id:t.created_by_user_id}));return s.value=o,o}catch(n){const t=n instanceof Error?n.message:"Failed to fetch interactions";return M("interactions",t),null}finally{p.interactions=!1}},Y=async t=>{try{p.documents=!0,k("documents");const n=t||a.value?.id;if(!n)throw new Error("No organization ID provided");const{data:r,error:i}=await e.from("organization_documents").select("*").eq("organization_id",n).order("created_at",{ascending:!1});if(i)throw new Error(i.message);const o=(r||[]).map(t=>({id:t.id,organization_id:t.organization_id,document_name:t.title||"Unnamed Document",document_type:t.file_type||"Other",file_path:t.external_url||"",file_size:t.file_size_bytes||null,uploaded_at:t.created_at||(new Date).toISOString(),uploaded_by:t.created_by_user_id||null}));return c.value=o,o}catch(n){const t=n instanceof Error?n.message:"Failed to fetch documents";return M("documents",t),null}finally{p.documents=!1}};return{organizations:t,currentOrganization:a,analyticsData:n,performanceData:r,leadScoringData:i,dashboardMetrics:o,interactions:s,documents:c,searchQuery:m,appliedFilters:h,sortConfig:f,pagination:b,lastRefreshed:w,loading:p,isLoading:O,errors:_,hasErrors:E,currentError:P,hasOrganizations:z,totalOrganizations:D,organizationStats:I,topPerformingOrganizations:F,organizationsByStatus:U,recentOrganizations:S,priorityOptions:C,foodBeverageSegments:B,distributorOrganizations:L,principalOrganizations:x,getOrganizationsForPrincipals:A,principalRelatedOrganizations:$,fetchOrganizations:T,fetchOrganization:W,fetchOrganizationsByPrincipal:async(t,a={})=>{try{p.organizations=!0,k("organizations");const n=`organizations_by_principal_${t}_${JSON.stringify(a)}`;if(!1!==a.useCache){const t=j(n);if(t)return t}let r=[],i=[];if(!1!==a.includeDirectRelationships){const{data:a,error:n}=await e.from("organizations").select("*").eq("id",t);n||(r=a||[])}if(!1!==a.includeContactRelationships){const{data:a,error:n}=await e.from("contact_principals").select("\n            contact_id,\n            contacts!inner(\n              organization_id,\n              organizations!inner(*)\n            )\n          ").eq("principal_id",t);n||(i=(a||[]).map(t=>t.contacts?.organizations).filter(t=>t))}const o=[...r,...i].reduce((t,e)=>(t.find(t=>t.id===e.id)||t.push(e),t),[]).map(t=>({id:t.id||"",name:t.name||"",legal_name:t.legal_name,industry:t.industry,type:t.type,size:t.size,status:t.status,website:t.website,email:t.email,primary_phone:t.primary_phone,city:t.city,country:t.country,employees_count:t.employees_count,annual_revenue:t.annual_revenue,lead_score:t.lead_score,contact_count:void 0,last_interaction_date:t.last_contact_date,next_follow_up_date:t.next_follow_up_date,created_at:t.created_at,updated_at:t.updated_at}));return N(n,o),o}catch(n){const t=n instanceof Error?n.message:"Failed to fetch organizations by principal";return M("organizations",t),null}finally{p.organizations=!1}},createOrganization:async t=>{try{p.creating=!0,k("creating");const{data:a,error:n}=await e.from("organizations").insert(t).select().single();if(n)throw new Error(n.message);return q(),await T({resetList:!0}),a}catch(a){const t=a instanceof Error?a.message:"Failed to create organization";return M("creating",t),null}finally{p.creating=!1}},createOrganizationWithContacts:async(t,a)=>{try{p.creating=!0,k("creating");const{data:n,error:r}=await e.from("organizations").insert(t).select().single();if(r)throw new Error(r.message);if("create"===a.mode&&a.newContacts.length>0){const t=a.newContacts.map(t=>({organization_id:n.id,first_name:t.first_name,last_name:t.last_name,email:t.email,phone:t.phone||null,position:t.title||"Unknown"})),{error:r}=await e.from("contacts").insert(t)}else if("select"===a.mode&&a.selectedContactIds.length>0){const{error:t}=await e.from("contacts").update({organization_id:n.id}).in("id",a.selectedContactIds)}return q(),await T({resetList:!0}),n}catch(n){const t=n instanceof Error?n.message:"Failed to create organization with contacts";return M("creating",t),null}finally{p.creating=!1}},createOrganizationWithEnhancedForm:async t=>{try{p.creating=!0,k("creating");const{priority_letter:a,...n}=t,r={...n,lead_score:y(a),status:G(t),tags:n.tags?n.tags.filter(t=>void 0!==t):null,custom_fields:n.custom_fields,last_contact_date:n.last_contact_date instanceof Date?n.last_contact_date.toISOString():n.last_contact_date,next_follow_up_date:n.next_follow_up_date instanceof Date?n.next_follow_up_date.toISOString():n.next_follow_up_date,is_distributor:null===n.is_distributor?void 0:n.is_distributor,is_principal:null===n.is_principal?void 0:n.is_principal},{data:i,error:o}=await e.from("organizations").insert(r).select().single();if(o)throw o;return t.assigned_contacts?.length&&i&&await H(i.id,t.assigned_contacts),q(),await T({resetList:!0}),{success:!0,data:i}}catch(a){const t=a instanceof Error?a.message:"Failed to create organization";return M("creating",t),{success:!1,error:t}}finally{p.creating=!1}},updateOrganization:J,updateOrganizationWithContacts:async(t,n,r)=>{try{p.updating=!0,k("updating");const{data:i,error:o}=await e.from("organizations").update(n).eq("id",t).select().single();if(o)throw new Error(o.message);if("create"===r.mode&&r.newContacts.length>0){const a=r.newContacts.map(e=>({organization_id:t,first_name:e.first_name,last_name:e.last_name,email:e.email,phone:e.phone||null,position:e.title||"Unknown"})),{error:n}=await e.from("contacts").insert(a)}else if("select"===r.mode&&r.selectedContactIds.length>0){const{error:a}=await e.from("contacts").update({organization_id:t}).in("id",r.selectedContactIds)}return a.value?.id===t&&await W(t),q(),await T({resetList:!0}),i}catch(i){const t=i instanceof Error?i.message:"Failed to update organization with contacts";return M("updating",t),null}finally{p.updating=!1}},deleteOrganization:V,searchOrganizations:async t=>{m.value=t,b.value.page=1,await T({search:t,resetList:!0})},clearSearch:async()=>{m.value="",b.value.page=1,await T({resetList:!0})},applyFilters:async t=>{h.value={...h.value,...t},b.value.page=1,await T({resetList:!0})},clearFilters:async()=>{h.value={},b.value.page=1,await T({resetList:!0})},setSorting:async(t,e)=>{f.value={field:t,order:e},b.value.page=1,await T({resetList:!0})},setPage:Q,nextPage:async()=>{b.value.hasNext&&await Q(b.value.page+1)},previousPage:async()=>{b.value.hasPrevious&&await Q(b.value.page-1)},fetchDashboardMetrics:Z,fetchAnalytics:K,fetchPerformanceData:async()=>{try{p.performance=!0,k("performance");const{data:t,error:a}=await e.from("organizations").select("id, name, lead_score, created_at, updated_at").order("updated_at",{ascending:!1}).limit(12);if(a)throw new Error(a.message);const n=(t||[]).map((t,e)=>({id:`perf-${e}-${Date.now()}`,organization_id:t.id,month:new Date(t.updated_at||new Date).toISOString().substring(0,7),year:new Date(t.updated_at||new Date).getFullYear(),opportunities_created:0,opportunities_won:0,total_revenue:null,interaction_count:0,lead_score_change:null}));return r.value=n,n}catch(t){const e=t instanceof Error?t.message:"Failed to fetch performance data";return M("performance",e),null}finally{p.performance=!1}},fetchLeadScoringData:async()=>{try{p.leadScoring=!0,k("leadScoring");const{data:t,error:a}=await e.from("organizations").select("id, name, lead_score, updated_at").order("lead_score",{ascending:!1}).limit(100);if(a)throw new Error(a.message);const n=(t||[]).map((t,e)=>({id:`lead-${e}-${Date.now()}`,organization_id:t.id||`org-${e}`,lead_score:t.lead_score||0,scoring_factors:null,last_updated:(new Date).toISOString(),score_trend:null}));return i.value=n,n}catch(t){const e=t instanceof Error?t.message:"Failed to fetch lead scoring data";return M("leadScoring",e),null}finally{p.leadScoring=!1}},fetchPrincipalAnalytics:async()=>{try{p.analytics=!0,k("analytics");const t="principal_analytics",a=j(t);if(a)return a;const{data:n,error:r}=await e.from("organizations").select("id, name, type, custom_fields, annual_revenue, lead_score").or("custom_fields->>is_principal.eq.true,custom_fields->>is_distributor.eq.true");if(r)throw new Error(r.message);const{data:i,error:o}=await e.from("contact_principals").select("principal_id, contact_id");if(o)throw new Error(o.message);const s=new Map;i?.forEach(t=>{const e=s.get(t.principal_id)||0;s.set(t.principal_id,e+1)});const c={principalDistribution:n?.filter(t=>!0===t.custom_fields?.is_principal).length||0,distributorDistribution:n?.filter(t=>!0===t.custom_fields?.is_distributor).length||0,totalPrincipalRevenue:n?.filter(t=>!0===t.custom_fields?.is_principal).reduce((t,e)=>t+(e.annual_revenue||0),0)||0,averagePrincipalLeadScore:(()=>{const t=n?.filter(t=>!0===t.custom_fields?.is_principal&&t.lead_score)||[];return t.length>0?t.reduce((t,e)=>t+(e.lead_score||0),0)/t.length:0})(),totalContactRelationships:i?.length||0,averageRelationshipsPerPrincipal:s.size>0?Array.from(s.values()).reduce((t,e)=>t+e,0)/s.size:0,topPrincipalsByRelationships:Array.from(s.entries()).sort(([,t],[,e])=>e-t).slice(0,10).map(([t,e])=>{const a=n?.find(e=>e.id===t);return{id:t,name:a?.name||"Unknown",relationship_count:e}})};return N(t,c,3e5),c}catch(t){const e=t instanceof Error?t.message:"Failed to fetch principal analytics";return M("analytics",e),null}finally{p.analytics=!1}},fetchAvailablePrincipals:async(t={})=>{try{p.organizations=!0,k("organizations");const a=`available_principals_${JSON.stringify(t)}`;if(!1!==t.useCache){const t=j(a);if(t)return t}const{data:n,error:r}=await e.from("organizations").select("id, name, type, custom_fields").contains("custom_fields",{is_principal:!0}).order("name");if(r)throw new Error(r.message);const i=await Promise.all((n||[]).map(async a=>{let n=0,r=null;if(t.includeContactCount){const{data:t,error:i}=await e.from("contacts").select("id, first_name, last_name, email, phone, is_primary").eq("organization_id",a.id).order("is_primary",{ascending:!1}).limit(1);if(!i&&t?.length){n=t.length;const e=t[0];r={id:e.id,name:`${e.first_name} ${e.last_name}`,email:e.email,phone:e.phone}}}return{id:a.id,name:a.name,type:a.type,...t.includeContactCount&&{contact_count:n,primary_contact:r}}}));return N(a,i,3e5),i}catch(a){const t=a instanceof Error?a.message:"Failed to fetch available principals";return M("organizations",t),null}finally{p.organizations=!1}},fetchMultiPrincipalOrganizations:async(t={})=>{try{p.organizations=!0,k("organizations");const a=t.minimumPrincipalCount||2,n=`multi_principal_orgs_${a}`;if(!1!==t.useCache){const t=j(n);if(t)return t}const{data:r,error:i}=await e.from("contact_principals").select("\n          contacts!inner(\n            organization_id,\n            organizations!inner(id, name, type)\n          ),\n          organizations!principal_id!inner(id, name)\n        ");if(i)throw new Error(i.message);const o=new Map;r?.forEach(t=>{const e=t.contacts?.organizations,a=t.organizations;if(e&&a){const t=e.id;o.has(t)||o.set(t,{org:e,principals:new Set,principalNames:[]});const n=o.get(t);n.principals.has(a.id)||(n.principals.add(a.id),n.principalNames.push(a.name))}});const s=Array.from(o.values()).filter(t=>t.principals.size>=a).map(t=>({id:t.org.id,name:t.org.name,type:t.org.type,principal_count:t.principals.size,principal_names:t.principalNames})).sort((t,e)=>e.principal_count-t.principal_count);return N(n,s,3e5),s}catch(a){const t=a instanceof Error?a.message:"Failed to fetch multi-principal organizations";return M("organizations",t),null}finally{p.organizations=!1}},getPrincipalsForOpportunityCreation:async(t={})=>{try{p.organizations=!0,k("organizations");const a=`principals_for_opportunities_${JSON.stringify(t)}`;if(!1!==t.useCache){const t=j(a);if(t)return t}const{data:n,error:r}=await e.from("organizations").select("id, name, type, custom_fields").contains("custom_fields",{is_principal:!0});if(r)throw new Error(r.message);const{data:i,error:o}=await e.from("contact_principals").select("principal_id, contact_id, contacts!inner(organization_id)");if(o)throw new Error(o.message);let s=[];if(t.includeExistingOpportunities){const{data:t,error:a}=await e.from("opportunities").select("organization_id, created_at").order("created_at",{ascending:!1});a||(s=t||[])}const c=(n||[]).map(e=>{const a=i?.filter(t=>t.principal_id===e.id)||[],n=t.organizationId?a.filter(e=>e.contacts?.organization_id===t.organizationId):a;let r=0,o=null;if(t.includeExistingOpportunities){const t=a.map(t=>t.contacts?.organization_id).filter(Boolean),e=s.filter(e=>t.includes(e.organization_id));r=e.length,e.length>0&&(o=e[0].created_at)}const c=Boolean(n.length>0&&(0===r||o&&new Date(o)<new Date(Date.now()-2592e6)));return{id:e.id,name:e.name,organization_type:e.type,contact_relationships:n.length,...t.includeExistingOpportunities&&{existing_opportunities:r,last_opportunity_date:o},recommended_for_batch:c}}).filter(t=>t.contact_relationships>0).sort((t,e)=>t.recommended_for_batch!==e.recommended_for_batch?t.recommended_for_batch?-1:1:e.contact_relationships-t.contact_relationships);return N(a,c,3e5),c}catch(a){const t=a instanceof Error?a.message:"Failed to get principals for opportunity creation";return M("organizations",t),null}finally{p.organizations=!1}},fetchInteractions:X,createInteraction:async t=>{try{const{data:a,error:n}=await e.from("organization_interactions").insert({organization_id:t.organization_id,contact_id:t.contact_id||null,subject:t.subject||"Interaction",description:t.description||null,direction:t.direction||null,duration_minutes:t.duration_minutes||null,created_by_user_id:t.created_by_user_id||null}).select().single();if(n)throw new Error(n.message);return await X(t.organization_id),{id:a.id,organization_id:a.organization_id,interaction_type:"Other",subject:a.subject||"Interaction",interaction_date:a.created_at||(new Date).toISOString(),notes:"",outcome:null,created_at:a.created_at||(new Date).toISOString(),updated_at:a.updated_at||(new Date).toISOString()}}catch(a){const t=a instanceof Error?a.message:"Failed to create interaction";return M("interactions",t),null}},fetchDocuments:Y,createDocument:async t=>{try{const{data:a,error:n}=await e.from("organization_documents").insert(t).select().single();if(n)throw new Error(n.message);return await Y(t.organization_id),{id:a.id,organization_id:a.organization_id,document_name:"Document",document_type:"general",file_path:"",file_size:0,uploaded_at:a.created_at||(new Date).toISOString(),uploaded_by:null}}catch(a){const t=a instanceof Error?a.message:"Failed to create document";return M("documents",t),null}},performBulkOperation:async e=>{try{p.bulkOperations=!0,k("bulkOperations");let n=0,r=0;const i=[];for(const o of e.organizationIds)try{switch(e.type){case"update_status":e.data?.status&&(await J(o,{status:e.data.status}),n++);break;case"delete":await V(o),n++;break;case"add_tags":e.data?.tags&&t.value.find(t=>t.id===o)&&(await J(o,{tags:e.data.tags}),n++);break;default:throw new Error(`Unsupported bulk operation: ${e.type}`)}}catch(a){r++,i.push({id:o,error:a instanceof Error?a.message:"Unknown error"})}return{operation:e,success:0===r,total:e.organizationIds.length,successful:n,failed:r,errors:i}}catch(a){const t=a instanceof Error?a.message:"Failed to perform bulk operation";return M("bulkOperations",t),{operation:e,success:!1,total:e.organizationIds.length,successful:0,failed:e.organizationIds.length,errors:e.organizationIds.map(e=>({id:e,error:t}))}}finally{p.bulkOperations=!1}},getOrganizationById:e=>t.value.find(t=>t.id===e),organizationExists:e=>t.value.some(t=>t.id===e),refreshAllData:async()=>{q(),await Promise.all([T({resetList:!0}),Z(),K()]),w.value=new Date},resetStore:()=>{t.value=[],a.value=null,n.value=[],r.value=[],i.value=[],o.value=null,s.value=[],c.value=[],m.value="",h.value={},f.value={field:"name",order:"asc"},b.value={page:1,limit:20,total:0,totalPages:0,hasNext:!1,hasPrevious:!1},Object.keys(p).forEach(t=>{p[t]=!1}),R(),q(),w.value=null},clearErrors:R,clearError:k,clearCache:q,convertPriorityLetterToScore:t=>y(t),convertScoreToPriorityLetter:t=>(t=>t?t>=90?"A":t>=70?"B":t>=50?"C":"D":"D")(t),getAutoStatus:G,createContactRelationships:H}});export{m as o,h as u};
