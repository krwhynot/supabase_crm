import{d as t}from"./pinia-CUC4VGP7.js";import{o as n}from"./organizationsApi-CU0xJvEA.js";import{b as a,r as i,c as r}from"./vue-runtime-Ds28nt_E.js";const c=t("principal",()=>{const t=a({principals:[],selectedPrincipal:null,principalOptions:[],loading:!1,creating:!1,updating:!1,deleting:!1,error:null,searchTerm:"",stats:null,selectedOrganizationId:null}),c=i({}),o=r(()=>t.loading||t.creating||t.updating||t.deleting),e=r(()=>!!t.error),p=r(()=>t.principals.length),l=r(()=>t.principals.filter(t=>t.is_active).length),s=r(()=>n=>t.principals.find(t=>t.id===n)),u=r(()=>n=>t.principals.filter(t=>t.organization_id===n)),d=r(()=>t.principals.filter(t=>t.product_count>0)),_=r(()=>t.principals.filter(t=>t.opportunity_count>0)),y=r(()=>{const n=new Map;return t.principals.forEach(t=>{const a=n.get(t.organization_id);a?a.principal_count++:n.set(t.organization_id,{id:t.organization_id,name:t.organization_name,type:t.organization_type,principal_count:1})}),Array.from(n.values())}),g=r(()=>{const n=new Map;return t.principals.forEach(t=>{const a=t.organization_type||"Unknown";n.has(a)||n.set(a,[]),n.get(a).push(t)}),n}),f=async(a={})=>{t.loading=!0,t.error=null;try{const i=await n.getOrganizations();i.success&&i.data?(t.principals=i.data.map(t=>({id:t.id,name:t.name,organization_id:t.id,organization_name:t.name,organization_type:t.type,is_active:!0,contact_count:0,product_count:0,opportunity_count:0,created_at:t.created_at||(new Date).toISOString(),updated_at:t.updated_at||(new Date).toISOString()})),z(a)):t.error=i.error||"Failed to fetch principals"}catch(i){t.error=i instanceof Error?i.message:"Unexpected error occurred"}finally{t.loading=!1}},h=async a=>{t.loading=!0,t.error=null,t.selectedOrganizationId=a;try{const i=await n.getOrganizations();i.success&&i.data?t.principals=i.data.map(t=>({id:t.id,name:t.name,organization_id:a,organization_name:t.name,organization_type:t.type,is_active:!0,contact_count:0,product_count:0,opportunity_count:0,created_at:t.created_at||(new Date).toISOString(),updated_at:t.updated_at||(new Date).toISOString()})):t.error=i.error||"Failed to fetch principals for organization"}catch(i){t.error=i instanceof Error?i.message:"Unexpected error occurred"}finally{t.loading=!1}},z=n=>{let a=[...t.principals];if(n.organization_ids&&n.organization_ids.length>0&&(a=a.filter(t=>n.organization_ids.includes(t.organization_id))),n.organization_types&&n.organization_types.length>0&&(a=a.filter(t=>t.organization_type&&n.organization_types.includes(t.organization_type))),void 0!==n.has_products&&(a=a.filter(t=>n.has_products?t.product_count>0:0===t.product_count)),void 0!==n.is_active&&(a=a.filter(t=>t.is_active===n.is_active)),n.search){const t=n.search.toLowerCase();a=a.filter(n=>n.name.toLowerCase().includes(t)||n.organization_name.toLowerCase().includes(t))}c.value=n};return{...t,activeFilters:c,isLoading:o,hasError:e,principalCount:p,activePrincipalCount:l,getPrincipalById:s,getPrincipalsByOrganization:u,principalsWithProducts:d,principalsWithOpportunities:_,getOrganizationsWithPrincipals:y,principalsByOrganizationType:g,fetchPrincipals:f,fetchPrincipalOptions:async a=>{t.loading=!0,t.error=null;try{let a;a=await n.getOrganizations(),a.success&&a.data?t.principalOptions=a.data.map(t=>({id:t.id,name:t.name,organization_id:t.id,organization_name:t.name,organization_type:t.type,available_products:[]})):t.error=a.error||"Failed to fetch principal options"}catch(i){t.error=i instanceof Error?i.message:"Unexpected error occurred"}finally{t.loading=!1}},fetchPrincipalsByOrganization:h,fetchPrincipalById:async a=>{t.loading=!0,t.error=null;try{const i=await n.getOrganization(a);i.success&&i.data?t.selectedPrincipal={id:i.data.id,name:i.data.name,organization_id:i.data.id,organization_name:i.data.name,organization_type:i.data.type,is_active:!0,contact_count:0,product_count:0,opportunity_count:0,created_at:i.data.created_at||(new Date).toISOString(),updated_at:i.data.updated_at||(new Date).toISOString()}:t.error=i.error||"Failed to fetch principal"}catch(i){t.error=i instanceof Error?i.message:"Unexpected error occurred"}finally{t.loading=!1}},searchPrincipals:async(a,i={})=>{t.loading=!0,t.error=null,t.searchTerm=a;try{const a=await n.getOrganizations();if(a.success&&a.data){const n=a.data.filter(t=>{const n=t.custom_fields;return n&&!0===n.is_principal}).map(t=>({id:t.id,name:t.name,organization_id:t.id,organization_name:t.name,organization_type:t.type||null,is_active:!0,contact_count:0,product_count:0,opportunity_count:0,created_at:(new Date).toISOString(),updated_at:(new Date).toISOString()}));t.principals=n,z(i)}else t.error=a.error||"Failed to search principals"}catch(r){t.error=r instanceof Error?r.message:"Unexpected error occurred"}finally{t.loading=!1}},fetchStats:async()=>{t.loading=!0,t.error=null;try{const n=t.principals.length,a=t.principals.filter(t=>t.is_active).length,i=t.principals.filter(t=>t.product_count>0).length,r=t.principals.filter(t=>t.opportunity_count>0).length,c=n>0?t.principals.reduce((t,n)=>t+n.product_count,0)/n:0,o=new Map;t.principals.forEach(t=>{const n=o.get(t.organization_id);n?n.count++:o.set(t.organization_id,{name:t.organization_name,count:1})});const e=Array.from(o.entries()).map(([t,n])=>({organization_id:t,organization_name:n.name,principal_count:n.count})).sort((t,n)=>n.principal_count-t.principal_count).slice(0,10);t.stats={total_principals:n,active_principals:a,principals_with_products:i,principals_with_opportunities:r,average_products_per_principal:c,top_organizations_by_principals:e}}catch(n){t.error=n instanceof Error?n.message:"Unexpected error occurred"}finally{t.loading=!1}},getAvailableProductsForPrincipals:async n=>{try{const a=[];for(const i of n){const n=t.principalOptions.find(t=>t.id===i);n&&a.push(...n.available_products)}return[...new Set(a)]}catch(a){return t.error=a instanceof Error?a.message:"Failed to get available products",[]}},associateProductsWithPrincipals:async(n,a)=>{t.updating=!0,t.error=null;try{return a.forEach(a=>{const i=t.principals.find(t=>t.id===a);i&&(i.product_count+=n.length);const r=t.principalOptions.find(t=>t.id===a);r&&(r.available_products=[...new Set([...r.available_products,...n])])}),!0}catch(i){return t.error=i instanceof Error?i.message:"Failed to associate products with principals",!1}finally{t.updating=!1}},clearError:()=>{t.error=null},clearSelectedPrincipal:()=>{t.selectedPrincipal=null},clearSearch:()=>{t.searchTerm="",c.value={},t.selectedOrganizationId=null},refresh:async()=>{t.selectedOrganizationId?await h(t.selectedOrganizationId):await f(c.value)}}});export{c as u};
