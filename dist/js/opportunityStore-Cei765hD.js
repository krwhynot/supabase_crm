import{d as e}from"./pinia-CUC4VGP7.js";import{s as t}from"./supabaseClient-Bh63a8tq.js";import{c as a,b as n,a as r,d as o,e as i}from"./yup-D1qa_jJc.js";import{b as c,r as s,c as l}from"./vue-runtime-Ds28nt_E.js";var d=(e=>(e.NEW_LEAD="New Lead",e.INITIAL_OUTREACH="Initial Outreach",e.SAMPLE_VISIT_OFFERED="Sample/Visit Offered",e.AWAITING_RESPONSE="Awaiting Response",e.FEEDBACK_LOGGED="Feedback Logged",e.DEMO_SCHEDULED="Demo Scheduled",e.CLOSED_WON="Closed - Won",e))(d||{}),u=(e=>(e.SITE_VISIT="Site Visit",e.FOOD_SHOW="Food Show",e.NEW_PRODUCT_INTEREST="New Product Interest",e.FOLLOW_UP="Follow-up",e.DEMO_REQUEST="Demo Request",e.SAMPLING="Sampling",e.CUSTOM="Custom",e))(u||{});a({name:n().required("Opportunity name is required").min(3,"Name must be at least 3 characters").max(255,"Name must be less than 255 characters"),organization_id:n().required("Organization is required").uuid("Invalid organization ID"),stage:n().required("Stage is required").oneOf(Object.values(d),"Invalid stage selected"),principal_ids:i(n().uuid("Invalid principal ID")).min(1,"At least one principal must be selected").required("Principal selection is required"),product_id:n().uuid("Invalid product ID").required("Product selection is required"),context:n().oneOf([...Object.values(u),""],"Invalid context selected").nullable(),probability_percent:o().min(0,"Probability cannot be negative").max(100,"Probability cannot exceed 100%").nullable(),expected_close_date:n().nullable().test("future-date","Close date should be in the future",function(e){if(!e)return!0;const t=new Date(e),a=new Date;return a.setHours(0,0,0,0),t>=a}),deal_owner:n().max(100,"Deal owner name must be less than 100 characters").nullable(),notes:n().max(2e3,"Notes must be less than 2000 characters").nullable(),auto_generate_name:r().default(!0),name_template:n().max(500,"Name template must be less than 500 characters").nullable()});const p={"New Lead":10,"Initial Outreach":20,"Sample/Visit Offered":35,"Awaiting Response":40,"Feedback Logged":60,"Demo Scheduled":80,"Closed - Won":100},_={"New Lead":"gray","Initial Outreach":"blue","Sample/Visit Offered":"yellow","Awaiting Response":"orange","Feedback Logged":"purple","Demo Scheduled":"green","Closed - Won":"emerald"},g=new class{generateOpportunityName(e){const{organization_name:t,principal_name:a,context:n,date:r=new Date,custom_context:o}=e;return[this.cleanName(t),this.cleanName(a),this.getContextString(n,o),this.formatDate(r)].filter(Boolean).join(" - ")}generateBatchNamePreviews(e){const{organization_name:t,principal_data:a,context:n,custom_context:r,date:o=new Date}=e;return a.map(e=>{const a=this.generateOpportunityName({organization_name:t,principal_name:e.name,context:n,custom_context:r,date:o}),i=this.generateNameTemplate({organization_name:t,principal_name:e.name,context:n,custom_context:r,date:o});return{principal_id:e.id,principal_name:e.name,generated_name:a,name_template:i}})}generateNameTemplate(e){const{context:t,custom_context:a}=e,n={organization:"{{organization}}",principal:"{{principal}}",context:this.getContextString(t,a)||"{{context}}",month:"{{month}}",year:"{{year}}"};return[n.organization,n.principal,n.context,`${n.month} ${n.year}`].filter(e=>"{{context}}"!==e||t||a).join(" - ")}isAutoGeneratedName(e,t){if(!t)return!1;let a=t.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&");return a=a.replace(/\\\{\\\{organization\\\}\\\}/g,"([^-]+?)").replace(/\\\{\\\{principal\\\}\\\}/g,"([^-]+?)").replace(/\\\{\\\{context\\\}\\\}/g,"([^-]+?)").replace(/\\\{\\\{month\\\}\\\}/g,"([A-Za-z]+)").replace(/\\\{\\\{year\\\}\\\}/g,"(\\d{4})").replace(/\\\{\\\{date\\\}\\\}/g,"([A-Za-z]+ \\d{4})"),a=a.replace(/\\\s\*/g,"\\s*").replace(/\\-/g,"\\s*-\\s*"),new RegExp(`^${a}$`).test(e.trim())}parseAutoGeneratedName(e,t){try{if(!this.isAutoGeneratedName(e,t))return null;const a=e.split(" - ").map(e=>e.trim());if(a.length<3)return null;const n=t.includes("{{context}}");let r="",o="",i="",c="";if(n){if(a.length<4)return null;r=a[0]||"",o=a[1]||"",i=a[2]||"",c=a[3]||""}else if(4===t.split(" - ").length&&4===a.length)r=a[0]||"",o=a[1]||"",i=a[2]||"",c=a[3]||"";else{if(a.length<3)return null;r=a[0]||"",o=a[1]||"",i="",c=a[2]||""}const s=c.split(" ");return{organization:r,principal:o,context:i,month:s[0]||"",year:s[1]||"",date:c}}catch(a){return null}}updateAutoGeneratedName(e,t,a){const n=this.parseAutoGeneratedName(e,t);if(!n)return this.generateOpportunityName(a);const r={organization_name:a.organization_name||n.organization,principal_name:a.principal_name||n.principal,context:a.context,custom_context:a.custom_context||(a.context?void 0:n.context),date:a.date||new Date};return this.generateOpportunityName(r)}async isNameUnique(e,t){return{data:!0,error:null,success:!0}}async generateUniqueName(e){try{const t=this.generateOpportunityName(e);let a=t,n=1;for(;!(await this.isNameUnique(a)).data;)if(a=`${t} (${n})`,n++,n>100)throw new Error("Could not generate unique name after 100 attempts");return{data:a,error:null,success:!0}}catch(t){return{data:null,error:t instanceof Error?t.message:"Failed to generate unique opportunity name",success:!1}}}cleanName(e){return e.trim().replace(/\s+/g," ").replace(/[^\w\s&.\-\u00C0-\u017F]/g,"").trim()}getContextString(e,t){return t?.trim()?this.cleanName(t):e||""}formatDate(e){return`${["January","February","March","April","May","June","July","August","September","October","November","December"][e.getMonth()]} ${e.getFullYear()}`}},y=e=>g.generateBatchNamePreviews(e),m=new class{async getOpportunities(e={}){try{let a=t.from("opportunities").select("\n          *,\n          organizations:organization_id(name, type),\n          products:product_id(name, category)\n        ");e.search&&(a=a.ilike("name",`%${e.search}%`)),e.stage&&(a=a.eq("stage",e.stage)),e.organization_id&&(a=a.eq("organization_id",e.organization_id)),e.deal_owner&&(a=a.eq("deal_owner",e.deal_owner)),void 0!==e.is_won&&(a=a.eq("is_won",e.is_won));const n=e.sortBy||"created_at",r=e.sortOrder||"desc";a=a.order(n,{ascending:"asc"===r}),e.limit&&(a=a.limit(e.limit)),e.offset&&(a=a.range(e.offset,e.offset+(e.limit||10)-1));const{data:o,error:i}=await a;return i?{data:null,error:i.message,success:!1}:{data:(o||[]).map(e=>{const t=new Date(e.created_at||new Date),a=new Date,n=Math.floor((a.getTime()-t.getTime())/864e5);let r=null;if(e.expected_close_date){const t=new Date(e.expected_close_date);r=Math.floor((t.getTime()-a.getTime())/864e5)}return{id:e.id,name:e.name,stage:e.stage,probability_percent:e.probability_percent||0,expected_close_date:e.expected_close_date,deal_owner:e.deal_owner,is_won:e.is_won||!1,created_at:e.created_at||(new Date).toISOString(),updated_at:e.updated_at||(new Date).toISOString(),notes:e.notes||null,organization_name:e.organizations?.name||"",organization_type:e.organizations?.type||"",principal_name:null,principal_id:null,product_name:e.products?.name||null,product_category:e.products?.category||null,days_since_created:n,days_to_close:r,stage_duration_days:n}}),error:null,success:!0}}catch(a){return{data:null,error:a instanceof Error?a.message:"Unknown error occurred",success:!1}}}async getOpportunitiesWithFilters(e,a){try{let n=t.from("opportunities").select("\n          *,\n          organizations:organization_id(name, type),\n          products:product_id(name, category)\n        ",{count:"exact"});e.search&&(n=n.ilike("name",`%${e.search}%`)),e.stage&&e.stage.length>0&&(n=n.in("stage",e.stage)),e.organization_id&&(n=n.eq("organization_id",e.organization_id)),e.product_id&&(n=n.eq("product_id",e.product_id)),e.deal_owner&&(n=n.eq("deal_owner",e.deal_owner)),void 0!==e.probability_min&&(n=n.gte("probability_percent",e.probability_min)),void 0!==e.probability_max&&(n=n.lte("probability_percent",e.probability_max)),void 0!==e.is_won&&(n=n.eq("is_won",e.is_won)),n=n.order(a.sort_by,{ascending:"asc"===a.sort_order}).range((a.page-1)*a.limit,a.page*a.limit-1);const{data:r,error:o,count:i}=await n;if(o)return{data:null,error:o.message,success:!1};const c=(r||[]).map(e=>{const t=new Date(e.created_at||new Date),a=new Date,n=Math.floor((a.getTime()-t.getTime())/864e5);let r=null;if(e.expected_close_date){const t=new Date(e.expected_close_date);r=Math.floor((t.getTime()-a.getTime())/864e5)}return{id:e.id,name:e.name,stage:e.stage,probability_percent:e.probability_percent||0,expected_close_date:e.expected_close_date,deal_owner:e.deal_owner,is_won:e.is_won||!1,created_at:e.created_at||(new Date).toISOString(),updated_at:e.updated_at||(new Date).toISOString(),notes:e.notes||null,organization_name:e.organizations?.name||"",organization_type:e.organizations?.type||"",principal_name:null,principal_id:null,product_name:e.products?.name||null,product_category:e.products?.category||null,days_since_created:n,days_to_close:r,stage_duration_days:n}}),s=i||0;return{data:{opportunities:c,total_count:s,page:a.page,limit:a.limit,has_next:a.page*a.limit<s,has_previous:a.page>1},error:null,success:!0}}catch(n){return{data:null,error:n instanceof Error?n.message:"Unknown error occurred",success:!1}}}async getOpportunityById(e){try{const{data:a,error:n}=await t.from("opportunities").select("\n          *,\n          organizations:organization_id(name, type, address, phone, email),\n          products:product_id(name, description, category, suggested_retail_price)\n        ").eq("id",e).single();if(n)return{data:null,error:n.message,success:!1};if(!a)return{data:null,error:"Opportunity not found",success:!1};const r=new Date(a.created_at||new Date),o=new Date,i=Math.floor((o.getTime()-r.getTime())/864e5);let c=null;if(a.expected_close_date){const e=new Date(a.expected_close_date);c=Math.floor((e.getTime()-o.getTime())/864e5)}return{data:{id:a.id,name:a.name,organization_id:a.organization_id,stage:a.stage,product_id:a.product_id,context:a.context,probability_percent:a.probability_percent||0,expected_close_date:a.expected_close_date,deal_owner:a.deal_owner,notes:a.notes,is_won:a.is_won||!1,auto_generated_name:a.auto_generated_name||!1,name_template:a.name_template,created_at:a.created_at||(new Date).toISOString(),updated_at:a.updated_at||(new Date).toISOString(),created_by:a.created_by,deleted_at:a.deleted_at,organization_name:a.organizations?.name||"",organization_type:a.organizations?.type||"",organization_address:a.organizations?.address||null,organization_phone:a.organizations?.phone||null,organization_email:a.organizations?.email||null,principal_name:null,principal_id:null,principal_address:null,principal_phone:null,principal_email:null,product_name:a.products?.name||null,product_description:a.products?.description||null,product_category:a.products?.category||null,product_unit_price:a.products?.suggested_retail_price||null,days_since_created:i,days_to_close:c,stage_duration_days:i,has_recent_interactions:!1,last_interaction_date:null,total_interactions:0},error:null,success:!0}}catch(a){return{data:null,error:a instanceof Error?a.message:"Unknown error occurred",success:!1}}}async createOpportunity(e){try{const a={...e,probability_percent:e.probability_percent??void 0},{data:n,error:r}=await t.from("opportunities").insert(a).select().single();return r?{data:null,error:r.message,success:!1}:{data:n,error:null,success:!0}}catch(a){return{data:null,error:a instanceof Error?a.message:"Unknown error occurred",success:!1}}}async createBatchOpportunities(e){try{const{data:n}=await t.from("organizations").select("name").eq("id",e.organization_id).single(),r=n?.name||"Unknown Organization",{data:o}=await t.from("organizations").select("id, name").in("id",e.principal_ids),i=(o||[]).map(e=>({id:e.id,name:e.name})),c=await y({organization_name:r,principal_data:i,context:e.context,custom_context:e.name_template||void 0}),s=[],l=[];for(const t of c)try{const a={name:e.auto_generate_name?t.generated_name:e.name,organization_id:e.organization_id,stage:e.stage,product_id:e.product_id||null,context:e.context,probability_percent:e.probability_percent||null,expected_close_date:e.expected_close_date,deal_owner:e.deal_owner,notes:e.notes,auto_generated_name:e.auto_generate_name,name_template:e.auto_generate_name?t.name_template:null},n=await this.createOpportunity(a);n.success&&n.data?s.push(n.data):l.push({principal_id:t.principal_id,principal_name:t.principal_name,error:n.error||"Unknown error"})}catch(a){l.push({principal_id:t.principal_id,principal_name:t.principal_name,error:a instanceof Error?a.message:"Unknown error"})}return{data:{success:s.length>0,created_opportunities:s,failed_creations:l,total_created:s.length,total_failed:l.length},error:null,success:!0}}catch(a){return{data:null,error:a instanceof Error?a.message:"Unknown error occurred",success:!1}}}async generateNamePreviews(e){try{const{data:a}=await t.from("organizations").select("name").eq("id",e.organization_id).single(),n=a?.name||"Unknown Organization",{data:r}=await t.from("organizations").select("id, name").in("id",e.principal_ids),o=(r||[]).map(e=>({id:e.id,name:e.name}));return{data:await y({organization_name:n,principal_data:o,context:e.context,custom_context:e.name_template||void 0}),error:null,success:!0}}catch(a){return{data:null,error:a instanceof Error?a.message:"Unknown error occurred",success:!1}}}async updateOpportunity(e,a){try{const n={...a,probability_percent:a.probability_percent??void 0},{data:r,error:o}=await t.from("opportunities").update(n).eq("id",e).select().single();return o?{data:null,error:o.message,success:!1}:{data:r,error:null,success:!0}}catch(n){return{data:null,error:n instanceof Error?n.message:"Unknown error occurred",success:!1}}}async updateOpportunityStage(e,t){try{const a={stage:t,probability_percent:p[t]};return await this.updateOpportunity(e,a)}catch(a){return{data:null,error:a instanceof Error?a.message:"Unknown error occurred",success:!1}}}async deleteOpportunity(e){try{const{error:a}=await t.from("opportunities").update({deleted_at:(new Date).toISOString()}).eq("id",e);return a?{data:!1,error:a.message,success:!1}:{data:!0,error:null,success:!0}}catch(a){return{data:!1,error:a instanceof Error?a.message:"Unknown error occurred",success:!1}}}async getOpportunityKPIs(){try{const{data:e,error:a}=await t.from("opportunities").select("*").is("deleted_at",null);if(a)return{data:null,error:a.message,success:!1};const n=new Date,r=new Date(n.getFullYear(),n.getMonth(),1),o=new Date(n.getTime()-6048e5),i=e?.length||0,c=e?.filter(e=>!e.is_won&&"Closed - Won"!==e.stage).length||0,s=e?.filter(e=>e.is_won).length||0,l=e?.reduce((e,t)=>e+(t.probability_percent||0),0)||0,d=i>0?l/i:0,u=e?.filter(e=>e.is_won&&e.updated_at&&new Date(e.updated_at)>=r).length||0,p=i>0?s/i*100:0,_={"New Lead":0,"Initial Outreach":0,"Sample/Visit Offered":0,"Awaiting Response":0,"Feedback Logged":0,"Demo Scheduled":0,"Closed - Won":0};e?.forEach(e=>{_[e.stage]++});const g=e?.filter(e=>e.created_at&&new Date(e.created_at)>=o).length||0,y=e?.filter(e=>e.updated_at&&new Date(e.updated_at)>=o).length||0,m=e?.filter(e=>e.is_won&&e.updated_at&&new Date(e.updated_at)>=o).length||0;return{data:{total_opportunities:i,active_opportunities:c,won_opportunities:s,average_probability:Math.round(d),total_pipeline_value:0,won_this_month:u,conversion_rate:Math.round(p),average_days_to_close:0,win_rate:Math.round(p),stage_distribution:_,created_this_week:g,updated_this_week:y,closed_this_week:m},error:null,success:!0}}catch(e){return{data:null,error:e instanceof Error?e.message:"Unknown error occurred",success:!1}}}async getOpportunitiesByStage(){try{const e=await this.getOpportunities({limit:1e3});if(!e.success||!e.data)return{data:null,error:e.error,success:!1};const t={"New Lead":[],"Initial Outreach":[],"Sample/Visit Offered":[],"Awaiting Response":[],"Feedback Logged":[],"Demo Scheduled":[],"Closed - Won":[]};return e.data.forEach(e=>{t[e.stage].push(e)}),{data:t,error:null,success:!0}}catch(e){return{data:null,error:e instanceof Error?e.message:"Unknown error occurred",success:!1}}}},w=e("opportunity",()=>{const e=c({opportunities:[],selectedOpportunity:null,loading:!1,creating:!1,updating:!1,deleting:!1,error:null,currentPage:1,totalCount:0,hasNextPage:!1,hasPreviousPage:!1,kpis:null,stageDistribution:null,batchCreationResult:null,namePreviewsCache:[]}),t=s({}),a=s({page:1,limit:20,sort_by:"created_at",sort_order:"desc"}),n=l(()=>e.loading||e.creating||e.updating||e.deleting),r=l(()=>!!e.error),o=l(()=>e.opportunities.length),i=l(()=>t=>e.opportunities.find(e=>e.id===t)),u=l(()=>t=>e.opportunities.filter(e=>e.stage===t)),p=l(()=>e.opportunities.reduce(e=>e+0,0)),_=l(()=>{if(0===e.opportunities.length)return 0;const t=e.opportunities.reduce((e,t)=>e+(t.probability_percent||0),0);return Math.round(t/e.opportunities.length)}),g=async(n={},r=a.value)=>{e.loading=!0,e.error=null;try{const o=await m.getOpportunitiesWithFilters(n,r);o.success&&o.data?(e.opportunities=o.data.opportunities,e.totalCount=o.data.total_count,e.currentPage=o.data.page,e.hasNextPage=o.data.has_next,e.hasPreviousPage=o.data.has_previous,t.value=n,a.value=r):(e.opportunities=w(),e.totalCount=e.opportunities.length,e.currentPage=1,e.hasNextPage=!1,e.hasPreviousPage=!1,t.value=n,a.value=r)}catch(o){e.opportunities=w(),e.totalCount=e.opportunities.length,e.currentPage=1,e.hasNextPage=!1,e.hasPreviousPage=!1,t.value=n,a.value=r}finally{e.loading=!1}},y=async t=>{e.loading=!0,e.error=null;try{const a=await m.getOpportunityById(t);a.success&&a.data?e.selectedOpportunity=a.data:e.error=a.error||"Failed to fetch opportunity"}catch(a){e.error=a instanceof Error?a.message:"Unexpected error occurred"}finally{e.loading=!1}},w=()=>[{id:"demo-1",name:"Enterprise Integration - TechCorp",stage:d.DEMO_SCHEDULED,probability_percent:75,expected_close_date:"2024-09-15",deal_owner:"Sarah Johnson",is_won:!1,notes:"Technical demo scheduled for next week. Strong interest in enterprise features and scalability.",created_at:"2024-08-01T10:00:00Z",updated_at:"2024-08-01T15:30:00Z",organization_name:"TechCorp Solutions",organization_type:"Technology",principal_name:"Mike Chen",principal_id:"principal-1",product_name:"Enterprise Suite",product_category:"Software",days_since_created:15,days_to_close:45,stage_duration_days:5},{id:"demo-2",name:"Cloud Migration - StartupCo",stage:d.SAMPLE_VISIT_OFFERED,probability_percent:60,expected_close_date:"2024-10-30",deal_owner:"Alex Rodriguez",is_won:!1,notes:"Startup looking to migrate legacy systems to cloud infrastructure. Cost-conscious but very interested in scalability features.",created_at:"2024-07-20T14:00:00Z",updated_at:"2024-08-01T09:15:00Z",organization_name:"StartupCo Inc",organization_type:"Startup",principal_name:"Lisa Wang",principal_id:"principal-2",product_name:"Cloud Platform",product_category:"Infrastructure",days_since_created:27,days_to_close:90,stage_duration_days:12},{id:"demo-3",name:"Data Analytics - RetailGiant",stage:d.FEEDBACK_LOGGED,probability_percent:85,expected_close_date:"2024-08-30",deal_owner:"Emma Thompson",is_won:!1,notes:"Large retail client with extensive data needs. Positive feedback from initial analytics review. Strong alignment with their digital transformation goals.",created_at:"2024-07-10T08:30:00Z",updated_at:"2024-08-01T16:45:00Z",organization_name:"RetailGiant Corp",organization_type:"Retail",principal_name:"David Kim",principal_id:"principal-3",product_name:"Analytics Suite",product_category:"Analytics",days_since_created:37,days_to_close:29,stage_duration_days:8},{id:"demo-4",name:"Security Upgrade - FinanceSecure",stage:d.CLOSED_WON,probability_percent:100,expected_close_date:"2024-07-25",deal_owner:"James Wilson",is_won:!0,notes:"Successfully closed security platform implementation. Client was impressed with compliance features and rapid deployment capabilities.",created_at:"2024-06-15T11:00:00Z",updated_at:"2024-07-25T17:00:00Z",organization_name:"Finance Secure Ltd",organization_type:"Financial Services",principal_name:"Rachel Green",principal_id:"principal-4",product_name:"Security Platform",product_category:"Security",days_since_created:55,days_to_close:-7,stage_duration_days:2}];return{...e,activeFilters:t,activePagination:a,isLoading:n,hasError:r,opportunityCount:o,getOpportunityById:i,getOpportunitiesByStage:u,totalPipelineValue:p,averageProbability:_,fetchOpportunities:g,fetchOpportunityById:y,createOpportunity:async t=>{e.creating=!0,e.error=null;try{const a=await m.createOpportunity(t);if(a.success&&a.data){if(1===e.currentPage){const t={id:a.data.id,name:a.data.name,stage:a.data.stage,probability_percent:a.data.probability_percent,expected_close_date:a.data.expected_close_date,deal_owner:a.data.deal_owner,is_won:a.data.is_won,created_at:a.data.created_at,updated_at:a.data.updated_at,notes:a.data.notes||null,organization_name:"",organization_type:"",principal_name:null,principal_id:null,product_name:null,product_category:null,days_since_created:0,days_to_close:null,stage_duration_days:0};e.opportunities.unshift(t)}return!0}return e.error=a.error||"Failed to create opportunity",!1}catch(a){return e.error=a instanceof Error?a.message:"Unexpected error occurred",!1}finally{e.creating=!1}},createBatchOpportunities:async n=>{e.creating=!0,e.error=null,e.batchCreationResult=null;try{const r=await m.createBatchOpportunities(n);return r.success&&r.data?(e.batchCreationResult=r.data,r.data.success&&r.data.created_opportunities.length>0&&await g(t.value,a.value),r.data.success):(e.error=r.error||"Failed to create batch opportunities",!1)}catch(r){return e.error=r instanceof Error?r.message:"Unexpected error occurred",!1}finally{e.creating=!1}},generateNamePreviews:async t=>{e.loading=!0,e.error=null;try{const a=await m.generateNamePreviews(t);a.success&&a.data?e.namePreviewsCache=a.data:e.error=a.error||"Failed to generate name previews"}catch(a){e.error=a instanceof Error?a.message:"Unexpected error occurred"}finally{e.loading=!1}},updateOpportunity:async(t,a)=>{e.updating=!0,e.error=null;try{const n=await m.updateOpportunity(t,a);if(n.success&&n.data){const a=e.opportunities.findIndex(e=>e.id===t);return-1!==a&&(e.opportunities[a]={...e.opportunities[a],name:n.data.name,stage:n.data.stage,probability_percent:n.data.probability_percent,expected_close_date:n.data.expected_close_date,deal_owner:n.data.deal_owner,is_won:n.data.is_won,updated_at:n.data.updated_at}),e.selectedOpportunity?.id===t&&await y(t),!0}return e.error=n.error||"Failed to update opportunity",!1}catch(n){return e.error=n instanceof Error?n.message:"Unexpected error occurred",!1}finally{e.updating=!1}},updateOpportunityStage:async(t,a)=>{e.updating=!0,e.error=null;try{const n=await m.updateOpportunityStage(t,a);if(n.success&&n.data){const a=e.opportunities.findIndex(e=>e.id===t);return-1!==a&&(e.opportunities[a]={...e.opportunities[a],stage:n.data.stage,probability_percent:n.data.probability_percent,updated_at:n.data.updated_at}),!0}return e.error=n.error||"Failed to update opportunity stage",!1}catch(n){return e.error=n instanceof Error?n.message:"Unexpected error occurred",!1}finally{e.updating=!1}},deleteOpportunity:async t=>{e.deleting=!0,e.error=null;try{const a=await m.deleteOpportunity(t);if(a.success){const a=e.opportunities.findIndex(e=>e.id===t);return-1!==a&&e.opportunities.splice(a,1),e.selectedOpportunity?.id===t&&(e.selectedOpportunity=null),!0}return e.error=a.error||"Failed to delete opportunity",!1}catch(a){return e.error=a instanceof Error?a.message:"Unexpected error occurred",!1}finally{e.deleting=!1}},fetchKPIs:async()=>{e.loading=!0,e.error=null;try{const t=await m.getOpportunityKPIs();t.success&&t.data?e.kpis=t.data:e.kpis={total_opportunities:15,active_opportunities:11,won_opportunities:4,won_this_month:3,average_probability:68,total_pipeline_value:215e4,win_rate:72,time_to_close_avg:45,conversion_rate:26.7,average_days_to_close:45,stage_distribution:{"New Lead":3,"Initial Outreach":2,"Sample/Visit Offered":3,"Awaiting Response":2,"Feedback Logged":2,"Demo Scheduled":2,"Closed - Won":4},created_this_week:2,updated_this_week:8,closed_this_week:1}}catch(t){e.kpis={total_opportunities:15,active_opportunities:11,won_opportunities:4,won_this_month:3,average_probability:68,total_pipeline_value:215e4,win_rate:72,time_to_close_avg:45,conversion_rate:26.7,average_days_to_close:45,stage_distribution:{"New Lead":3,"Initial Outreach":2,"Sample/Visit Offered":3,"Awaiting Response":2,"Feedback Logged":2,"Demo Scheduled":2,"Closed - Won":4},created_this_week:2,updated_this_week:8,closed_this_week:1}}finally{e.loading=!1}},fetchStageDistribution:async()=>{e.loading=!0,e.error=null;try{const t=await m.getOpportunitiesByStage();t.success&&t.data?e.stageDistribution=t.data:e.error=t.error||"Failed to fetch stage distribution"}catch(t){e.error=t instanceof Error?t.message:"Unexpected error occurred"}finally{e.loading=!1}},clearError:()=>{e.error=null},clearSelectedOpportunity:()=>{e.selectedOpportunity=null},clearBatchResults:()=>{e.batchCreationResult=null,e.namePreviewsCache=[]},resetFilters:()=>{t.value={},a.value={page:1,limit:20,sort_by:"created_at",sort_order:"desc"}},refresh:async()=>{await g(t.value,a.value)}}});export{u as O,p as S,d as a,_ as b,g as o,w as u};
