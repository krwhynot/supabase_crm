import{d as r}from"./pinia-CUC4VGP7.js";import{s as t}from"./supabaseClient-Bh63a8tq.js";import{b as e,r as c,c as a}from"./vue-runtime-Ds28nt_E.js";const o=new class{async getProducts(r={}){try{let e=t.from("products").select("*");r.search&&(e=e.or(`name.ilike.%${r.search}%,description.ilike.%${r.search}%,sku.ilike.%${r.search}%`)),r.category&&"string"==typeof r.category&&""!==r.category.trim()&&(e=e.eq("category",r.category)),void 0!==r.is_active&&(e=e.eq("is_active",r.is_active));const c="principal_count"===r.sortBy?"name":r.sortBy||"name",a=r.sortOrder||"asc";e=e.order(c,{ascending:"asc"===a}),r.limit&&(e=e.limit(r.limit)),r.offset&&(e=e.range(r.offset,r.offset+(r.limit||50)-1));const{data:o,error:n}=await e;return n?{data:null,error:`Failed to fetch products: ${n.message}`,success:!1}:{data:(o||[]).map(r=>({...r,is_active:r.is_active??!0,category:r.category,unit_price:r.suggested_retail_price,principal_ids:[],principal_names:[],principal_count:0})),error:null,success:!0}}catch(e){return{data:null,error:"An unexpected error occurred while fetching products",success:!1}}}async getProductsForPrincipals(r){try{const{data:e,error:c}=await t.from("products").select("id, name, category, description, suggested_retail_price, is_active").eq("is_active",!0);return c?{data:null,error:`Failed to fetch products for principals: ${c.message}`,success:!1}:{data:(e||[]).map(t=>({id:t.id,name:t.name,category:t.category,description:t.description,unit_price:t.suggested_retail_price,is_active:t.is_active??!0,available_principals:r})),error:null,success:!0}}catch(e){return{data:null,error:"An unexpected error occurred while fetching products for principals",success:!1}}}async getProduct(r){try{const{data:e,error:c}=await t.from("products").select("*").eq("id",r).single();return c?{data:null,error:`Failed to fetch product: ${c.message}`,success:!1}:{data:{...e,category:e.category,unit_price:e.suggested_retail_price,created_by:null},error:null,success:!0}}catch(e){return{data:null,error:"An unexpected error occurred while fetching the product",success:!1}}}async createProduct(r){try{const{data:e,error:c}=await t.from("products").insert(r).select().single();return c?{data:null,error:`Failed to create product: ${c.message}`,success:!1}:{data:{...e,category:e.category,unit_price:e.suggested_retail_price,created_by:null},error:null,success:!0}}catch(e){return{data:null,error:"An unexpected error occurred while creating the product",success:!1}}}async updateProduct(r,e){try{const{data:c,error:a}=await t.from("products").update(e).eq("id",r).select().single();return a?{data:null,error:`Failed to update product: ${a.message}`,success:!1}:{data:{...c,category:c.category,unit_price:c.suggested_retail_price,created_by:null},error:null,success:!0}}catch(c){return{data:null,error:"An unexpected error occurred while updating the product",success:!1}}}async deleteProduct(r){try{const{error:e}=await t.from("products").update({is_active:!1,deleted_at:(new Date).toISOString()}).eq("id",r);return e?{data:null,error:`Failed to delete product: ${e.message}`,success:!1}:{data:!0,error:null,success:!0}}catch(e){return{data:null,error:"An unexpected error occurred while deleting the product",success:!1}}}async assignProductToPrincipals(r,e){try{await t.from("product_principals").delete().eq("product_id",r);const c=e.map(t=>({product_id:r,principal_id:t})),{data:a,error:o}=await t.from("product_principals").insert(c).select("\n          *,\n          products!inner(name, category),\n          organizations!inner(name, type)\n        ");return o?{data:null,error:`Failed to assign product to principals: ${o.message}`,success:!1}:{data:(a||[]).map(r=>({id:r.id,product_id:r.product_id,principal_id:r.principal_id,created_at:r.created_at||(new Date).toISOString(),product_name:r.products?.name||"",product_category:r.products?.category,principal_name:r.organizations?.name||"",principal_type:r.organizations?.type||""})),error:null,success:!0}}catch(c){return{data:null,error:"An unexpected error occurred while assigning product to principals",success:!1}}}async getProductStats(){try{const[r,e]=await Promise.all([t.from("products").select("*",{count:"exact",head:!0}),t.from("products").select("*",{count:"exact",head:!0}).eq("is_active",!0)]);if(r.error)throw r.error;if(e.error)throw e.error;const c=r.count||0,a=e.count||0,{data:o,error:n}=await t.from("products").select("category").eq("is_active",!0);if(n)throw n;const s=(o||[]).reduce((r,t)=>{const e=t.category;return e&&(r[e]=(r[e]||0)+1),r},{}),{data:i,error:u}=await t.from("products").select("suggested_retail_price").eq("is_active",!0).not("suggested_retail_price","is",null);if(u)throw u;const d=(i||[]).map(r=>r.suggested_retail_price).filter(r=>null!==r),l=d.length>0?d.reduce((r,t)=>r+t,0)/d.length:0,p=d.length>0?Math.min(...d):0,y=d.length>0?Math.max(...d):0,h=Object.entries(s).sort(([,r],[,t])=>t-r)[0]?.[0],_=new Date;_.setDate(_.getDate()-30);const{count:g,error:f}=await t.from("products").select("*",{count:"exact",head:!0}).gte("created_at",_.toISOString());if(f)throw f;return{data:{total_products:c,active_products:a,inactive_products:c-a,products_by_category:s,average_price:l,price_range:{min:p,max:y},most_common_category:h,recently_added:g||0},error:null,success:!0}}catch(r){return{data:null,error:"Failed to fetch product statistics",success:!1}}}async searchProducts(r,e={}){try{let c=t.from("products").select("*");e.category&&e.category.length>0&&(c=c.in("category",e.category)),void 0!==e.is_active&&(c=c.eq("is_active",e.is_active)),void 0!==e.price_min&&(c=c.gte("suggested_retail_price",e.price_min)),void 0!==e.price_max&&(c=c.lte("suggested_retail_price",e.price_max)),r.trim()&&(c=c.or(`name.ilike.%${r}%,description.ilike.%${r}%,sku.ilike.%${r}%`));const{data:a,error:o}=await c;if(o)return{data:null,error:`Failed to search products: ${o.message}`,success:!1};const n=(a||[]).map(t=>{const e=this.calculateMatchScore(t,r),c=this.getHighlightFields(t,r);return{id:String(t.id),name:t.name,category:t.category,description:t.description,unit_price:t.suggested_retail_price,match_score:e,available_for_principals:[],highlight_fields:c}});return n.sort((r,t)=>t.match_score-r.match_score),{data:n,error:null,success:!0}}catch(c){return{data:null,error:"An unexpected error occurred while searching products",success:!1}}}async performBulkOperation(r){try{const c={success:!0,processed_count:0,failed_count:0,errors:[],updated_products:[]};for(const a of r.product_ids)try{let e={};switch(r.operation){case"activate":e={is_active:!0};break;case"deactivate":e={is_active:!1};break;case"delete":e={is_active:!1,deleted_at:(new Date).toISOString()};break;case"update_category":r.parameters?.category&&(e={category:r.parameters.category});break;default:throw new Error(`Unsupported operation: ${r.operation}`)}const{data:o,error:n}=await t.from("products").update(e).eq("id",a).select().single();if(n)throw n;c.updated_products.push({...o,category:o.category,unit_price:o.suggested_retail_price,created_by:null}),c.processed_count++}catch(e){const{data:r}=await t.from("products").select("name").eq("id",a).single();c.errors.push({product_id:a,product_name:r?.name||"Unknown Product",error_message:e.message||"Unknown error"}),c.failed_count++}return c.success=0===c.failed_count,{data:c,error:null,success:!0}}catch(e){return{data:null,error:"An unexpected error occurred during bulk operation",success:!1}}}calculateMatchScore(r,t){if(!t.trim())return 1;const e=t.toLowerCase();let c=0;return r.name.toLowerCase()===e?c+=100:r.name.toLowerCase().includes(e)&&(c+=50),r.sku&&r.sku.toLowerCase().includes(e)&&(c+=30),r.description&&r.description.toLowerCase().includes(e)&&(c+=10),r.category.toLowerCase().includes(e)&&(c+=5),c}getHighlightFields(r,t){if(!t.trim())return[];const e=t.toLowerCase(),c=[];return r.name.toLowerCase().includes(e)&&c.push("name"),r.sku&&r.sku.toLowerCase().includes(e)&&c.push("sku"),r.description&&r.description.toLowerCase().includes(e)&&c.push("description"),r.category.toLowerCase().includes(e)&&c.push("category"),c}},n=r("product",()=>{const r=e({products:[],selectedProduct:null,productOptions:[],loading:!1,creating:!1,updating:!1,deleting:!1,error:null,searchResults:[],searchTerm:"",stats:null,bulkOperationResult:null}),t=c({}),n=a(()=>r.loading||r.creating||r.updating||r.deleting),s=a(()=>!!r.error),i=a(()=>r.products.length),u=a(()=>r.products.filter(r=>r.is_active).length),d=a(()=>t=>r.products.find(r=>r.id===t)),l=a(()=>t=>r.products.filter(r=>r.category===t)),p=a(()=>t=>r.productOptions.filter(r=>r.available_principals.some(r=>t.includes(r)))),y=a(()=>{const t=new Set;return r.products.forEach(r=>{r.category&&t.add(r.category)}),Array.from(t)}),h=async(t={})=>{r.loading=!0,r.error=null;try{const e=await o.getProducts(t);e.success&&e.data?r.products=e.data:r.error=e.error||"Failed to fetch products"}catch(e){r.error=e instanceof Error?e.message:"Unexpected error occurred"}finally{r.loading=!1}};return{...r,activeFilters:t,isLoading:n,hasError:s,productCount:i,activeProductCount:u,getProductById:d,getProductsByCategory:l,getProductsForPrincipals:p,categoriesInUse:y,fetchProducts:h,fetchProductsForPrincipals:async t=>{r.loading=!0,r.error=null;try{const e=await o.getProductsForPrincipals(t);e.success&&e.data?r.productOptions=e.data:r.error=e.error||"Failed to fetch products for principals"}catch(e){r.error=e instanceof Error?e.message:"Unexpected error occurred"}finally{r.loading=!1}},fetchProductById:async t=>{r.loading=!0,r.error=null;try{const e=await o.getProduct(t);e.success&&e.data?r.selectedProduct=e.data:r.error=e.error||"Failed to fetch product"}catch(e){r.error=e instanceof Error?e.message:"Unexpected error occurred"}finally{r.loading=!1}},createProduct:async t=>{r.creating=!0,r.error=null;try{const e=await o.createProduct(t);if(e.success&&e.data){const t={...e.data,principal_ids:[],principal_names:[],principal_count:0};return r.products.unshift(t),!0}return r.error=e.error||"Failed to create product",!1}catch(e){return r.error=e instanceof Error?e.message:"Unexpected error occurred",!1}finally{r.creating=!1}},updateProduct:async(t,e)=>{r.updating=!0,r.error=null;try{const c=await o.updateProduct(t,e);if(c.success&&c.data){const e=r.products.findIndex(r=>r.id===t);return-1!==e&&(r.products[e]={...r.products[e],...c.data}),r.selectedProduct?.id===t&&(r.selectedProduct=c.data),!0}return r.error=c.error||"Failed to update product",!1}catch(c){return r.error=c instanceof Error?c.message:"Unexpected error occurred",!1}finally{r.updating=!1}},deleteProduct:async t=>{r.deleting=!0,r.error=null;try{const e=await o.deleteProduct(t);if(e.success){const e=r.products.findIndex(r=>r.id===t);return-1!==e&&(r.products[e].is_active=!1),r.selectedProduct?.id===t&&(r.selectedProduct=null),!0}return r.error=e.error||"Failed to delete product",!1}catch(e){return r.error=e instanceof Error?e.message:"Unexpected error occurred",!1}finally{r.deleting=!1}},assignProductToPrincipals:async(t,e)=>{r.updating=!0,r.error=null;try{const c=await o.assignProductToPrincipals(t,e);if(c.success&&c.data){const c=r.products.findIndex(r=>r.id===t);return-1!==c&&(r.products[c].principal_ids=e,r.products[c].principal_count=e.length),!0}return r.error=c.error||"Failed to assign product to principals",!1}catch(c){return r.error=c instanceof Error?c.message:"Unexpected error occurred",!1}finally{r.updating=!1}},searchProducts:async(t,e={})=>{r.loading=!0,r.error=null,r.searchTerm=t;try{const c=await o.searchProducts(t,e);c.success&&c.data?r.searchResults=c.data:r.error=c.error||"Failed to search products"}catch(c){r.error=c instanceof Error?c.message:"Unexpected error occurred"}finally{r.loading=!1}},fetchStats:async()=>{r.loading=!0,r.error=null;try{const t=await o.getProductStats();t.success&&t.data?r.stats=t.data:r.error=t.error||"Failed to fetch product statistics"}catch(t){r.error=t instanceof Error?t.message:"Unexpected error occurred"}finally{r.loading=!1}},performBulkOperation:async t=>{r.updating=!0,r.error=null,r.bulkOperationResult=null;try{const e=await o.performBulkOperation(t);return e.success&&e.data?(r.bulkOperationResult=e.data,e.data.success&&t.product_ids.forEach(e=>{const c=r.products.findIndex(r=>r.id===e);if(-1!==c)switch(t.operation){case"activate":r.products[c].is_active=!0;break;case"deactivate":case"delete":r.products[c].is_active=!1;break;case"update_category":t.parameters?.category&&(r.products[c].category=t.parameters.category)}}),e.data.success):(r.error=e.error||"Failed to perform bulk operation",!1)}catch(e){return r.error=e instanceof Error?e.message:"Unexpected error occurred",!1}finally{r.updating=!1}},clearError:()=>{r.error=null},clearSelectedProduct:()=>{r.selectedProduct=null},clearSearchResults:()=>{r.searchResults=[],r.searchTerm=""},clearBulkResults:()=>{r.bulkOperationResult=null},resetFilters:()=>{t.value={}},refresh:async()=>{await h()}}});export{n as u};
