import{d as r}from"./pinia-CUC4VGP7.js";import{s as t}from"./supabaseClient-5bv4QPtU.js";import{b as e,r as c,c as a}from"./vue-runtime-Ds28nt_E.js";const n=new class{async getProducts(r={}){try{let e=t.from("products").select("*");r.search&&(e=e.or(`name.ilike.%${r.search}%,description.ilike.%${r.search}%,sku.ilike.%${r.search}%`)),r.category&&"string"==typeof r.category&&""!==r.category.trim()&&(e=e.eq("category",r.category)),void 0!==r.is_active&&(e=e.eq("is_active",r.is_active));const c="principal_count"===r.sortBy?"name":r.sortBy||"name",a=r.sortOrder||"asc";e=e.order(c,{ascending:"asc"===a}),r.limit&&(e=e.limit(r.limit)),r.offset&&(e=e.range(r.offset,r.offset+(r.limit||50)-1));const{data:n,error:o}=await e;return o?{data:null,error:`Failed to fetch products: ${o.message}`,success:!1}:{data:(n||[]).map(r=>{var t;return{...r,is_active:null==(t=r.is_active)||t,category:r.category,unit_price:r.suggested_retail_price,principal_ids:[],principal_names:[],principal_count:0}}),error:null,success:!0}}catch(e){return{data:null,error:"An unexpected error occurred while fetching products",success:!1}}}async getProductsForPrincipals(r){try{const{data:e,error:c}=await t.from("products").select("id, name, category, description, suggested_retail_price, is_active").eq("is_active",!0);return c?{data:null,error:`Failed to fetch products for principals: ${c.message}`,success:!1}:{data:(e||[]).map(t=>{var e;return{id:t.id,name:t.name,category:t.category,description:t.description,unit_price:t.suggested_retail_price,is_active:null==(e=t.is_active)||e,available_principals:r}}),error:null,success:!0}}catch(e){return{data:null,error:"An unexpected error occurred while fetching products for principals",success:!1}}}async getProduct(r){try{const{data:e,error:c}=await t.from("products").select("*").eq("id",r).single();return c?{data:null,error:`Failed to fetch product: ${c.message}`,success:!1}:{data:{...e,category:e.category,unit_price:e.suggested_retail_price,created_by:null},error:null,success:!0}}catch(e){return{data:null,error:"An unexpected error occurred while fetching the product",success:!1}}}async createProduct(r){try{const{data:e,error:c}=await t.from("products").insert(r).select().single();return c?{data:null,error:`Failed to create product: ${c.message}`,success:!1}:{data:{...e,category:e.category,unit_price:e.suggested_retail_price,created_by:null},error:null,success:!0}}catch(e){return{data:null,error:"An unexpected error occurred while creating the product",success:!1}}}async updateProduct(r,e){try{const{data:c,error:a}=await t.from("products").update(e).eq("id",r).select().single();return a?{data:null,error:`Failed to update product: ${a.message}`,success:!1}:{data:{...c,category:c.category,unit_price:c.suggested_retail_price,created_by:null},error:null,success:!0}}catch(c){return{data:null,error:"An unexpected error occurred while updating the product",success:!1}}}async deleteProduct(r){try{const{error:e}=await t.from("products").update({is_active:!1,deleted_at:(new Date).toISOString()}).eq("id",r);return e?{data:null,error:`Failed to delete product: ${e.message}`,success:!1}:{data:!0,error:null,success:!0}}catch(e){return{data:null,error:"An unexpected error occurred while deleting the product",success:!1}}}async assignProductToPrincipals(r,e){try{await t.from("product_principals").delete().eq("product_id",r);const c=e.map(t=>({product_id:r,principal_id:t})),{data:a,error:n}=await t.from("product_principals").insert(c).select("\n          *,\n          products!inner(name, category),\n          organizations!inner(name, type)\n        ");return n?{data:null,error:`Failed to assign product to principals: ${n.message}`,success:!1}:{data:(a||[]).map(r=>{var t,e,c,a;return{id:r.id,product_id:r.product_id,principal_id:r.principal_id,created_at:r.created_at||(new Date).toISOString(),product_name:(null==(t=r.products)?void 0:t.name)||"",product_category:null==(e=r.products)?void 0:e.category,principal_name:(null==(c=r.organizations)?void 0:c.name)||"",principal_type:(null==(a=r.organizations)?void 0:a.type)||""}}),error:null,success:!0}}catch(c){return{data:null,error:"An unexpected error occurred while assigning product to principals",success:!1}}}async getProductStats(){var r;try{const[e,c]=await Promise.all([t.from("products").select("*",{count:"exact",head:!0}),t.from("products").select("*",{count:"exact",head:!0}).eq("is_active",!0)]);if(e.error)throw e.error;if(c.error)throw c.error;const a=e.count||0,n=c.count||0,{data:o,error:s}=await t.from("products").select("category").eq("is_active",!0);if(s)throw s;const i=(o||[]).reduce((r,t)=>{const e=t.category;return e&&(r[e]=(r[e]||0)+1),r},{}),{data:u,error:d}=await t.from("products").select("suggested_retail_price").eq("is_active",!0).not("suggested_retail_price","is",null);if(d)throw d;const l=(u||[]).map(r=>r.suggested_retail_price).filter(r=>null!==r),p=l.length>0?l.reduce((r,t)=>r+t,0)/l.length:0,y=l.length>0?Math.min(...l):0,h=l.length>0?Math.max(...l):0,_=null==(r=Object.entries(i).sort(([,r],[,t])=>t-r)[0])?void 0:r[0],g=new Date;g.setDate(g.getDate()-30);const{count:f,error:w}=await t.from("products").select("*",{count:"exact",head:!0}).gte("created_at",g.toISOString());if(w)throw w;return{data:{total_products:a,active_products:n,inactive_products:a-n,products_by_category:i,average_price:p,price_range:{min:y,max:h},most_common_category:_,recently_added:f||0},error:null,success:!0}}catch(e){return{data:null,error:"Failed to fetch product statistics",success:!1}}}async searchProducts(r,e={}){try{let c=t.from("products").select("*");e.category&&e.category.length>0&&(c=c.in("category",e.category)),void 0!==e.is_active&&(c=c.eq("is_active",e.is_active)),void 0!==e.price_min&&(c=c.gte("suggested_retail_price",e.price_min)),void 0!==e.price_max&&(c=c.lte("suggested_retail_price",e.price_max)),r.trim()&&(c=c.or(`name.ilike.%${r}%,description.ilike.%${r}%,sku.ilike.%${r}%`));const{data:a,error:n}=await c;if(n)return{data:null,error:`Failed to search products: ${n.message}`,success:!1};const o=(a||[]).map(t=>{const e=this.calculateMatchScore(t,r),c=this.getHighlightFields(t,r);return{id:String(t.id),name:t.name,category:t.category,description:t.description,unit_price:t.suggested_retail_price,match_score:e,available_for_principals:[],highlight_fields:c}});return o.sort((r,t)=>t.match_score-r.match_score),{data:o,error:null,success:!0}}catch(c){return{data:null,error:"An unexpected error occurred while searching products",success:!1}}}async performBulkOperation(r){var e;try{const a={success:!0,processed_count:0,failed_count:0,errors:[],updated_products:[]};for(const n of r.product_ids)try{let c={};switch(r.operation){case"activate":c={is_active:!0};break;case"deactivate":c={is_active:!1};break;case"delete":c={is_active:!1,deleted_at:(new Date).toISOString()};break;case"update_category":(null==(e=r.parameters)?void 0:e.category)&&(c={category:r.parameters.category});break;default:throw new Error(`Unsupported operation: ${r.operation}`)}const{data:o,error:s}=await t.from("products").update(c).eq("id",n).select().single();if(s)throw s;a.updated_products.push({...o,category:o.category,unit_price:o.suggested_retail_price,created_by:null}),a.processed_count++}catch(c){const{data:r}=await t.from("products").select("name").eq("id",n).single();a.errors.push({product_id:n,product_name:(null==r?void 0:r.name)||"Unknown Product",error_message:c.message||"Unknown error"}),a.failed_count++}return a.success=0===a.failed_count,{data:a,error:null,success:!0}}catch(c){return{data:null,error:"An unexpected error occurred during bulk operation",success:!1}}}calculateMatchScore(r,t){if(!t.trim())return 1;const e=t.toLowerCase();let c=0;return r.name.toLowerCase()===e?c+=100:r.name.toLowerCase().includes(e)&&(c+=50),r.sku&&r.sku.toLowerCase().includes(e)&&(c+=30),r.description&&r.description.toLowerCase().includes(e)&&(c+=10),r.category.toLowerCase().includes(e)&&(c+=5),c}getHighlightFields(r,t){if(!t.trim())return[];const e=t.toLowerCase(),c=[];return r.name.toLowerCase().includes(e)&&c.push("name"),r.sku&&r.sku.toLowerCase().includes(e)&&c.push("sku"),r.description&&r.description.toLowerCase().includes(e)&&c.push("description"),r.category.toLowerCase().includes(e)&&c.push("category"),c}},o=r("product",()=>{const r=e({products:[],selectedProduct:null,productOptions:[],loading:!1,creating:!1,updating:!1,deleting:!1,error:null,searchResults:[],searchTerm:"",stats:null,bulkOperationResult:null}),t=c({}),o=a(()=>r.loading||r.creating||r.updating||r.deleting),s=a(()=>!!r.error),i=a(()=>r.products.length),u=a(()=>r.products.filter(r=>r.is_active).length),d=a(()=>t=>r.products.find(r=>r.id===t)),l=a(()=>t=>r.products.filter(r=>r.category===t)),p=a(()=>t=>r.productOptions.filter(r=>r.available_principals.some(r=>t.includes(r)))),y=a(()=>{const t=new Set;return r.products.forEach(r=>{r.category&&t.add(r.category)}),Array.from(t)}),h=async(t={})=>{r.loading=!0,r.error=null;try{const e=await n.getProducts(t);e.success&&e.data?r.products=e.data:r.error=e.error||"Failed to fetch products"}catch(e){r.error=e instanceof Error?e.message:"Unexpected error occurred"}finally{r.loading=!1}};return{...r,activeFilters:t,isLoading:o,hasError:s,productCount:i,activeProductCount:u,getProductById:d,getProductsByCategory:l,getProductsForPrincipals:p,categoriesInUse:y,fetchProducts:h,fetchProductsForPrincipals:async t=>{r.loading=!0,r.error=null;try{const e=await n.getProductsForPrincipals(t);e.success&&e.data?r.productOptions=e.data:r.error=e.error||"Failed to fetch products for principals"}catch(e){r.error=e instanceof Error?e.message:"Unexpected error occurred"}finally{r.loading=!1}},fetchProductById:async t=>{r.loading=!0,r.error=null;try{const e=await n.getProduct(t);e.success&&e.data?r.selectedProduct=e.data:r.error=e.error||"Failed to fetch product"}catch(e){r.error=e instanceof Error?e.message:"Unexpected error occurred"}finally{r.loading=!1}},createProduct:async t=>{r.creating=!0,r.error=null;try{const e=await n.createProduct(t);if(e.success&&e.data){const t={...e.data,principal_ids:[],principal_names:[],principal_count:0};return r.products.unshift(t),!0}return r.error=e.error||"Failed to create product",!1}catch(e){return r.error=e instanceof Error?e.message:"Unexpected error occurred",!1}finally{r.creating=!1}},updateProduct:async(t,e)=>{var c;r.updating=!0,r.error=null;try{const a=await n.updateProduct(t,e);if(a.success&&a.data){const e=r.products.findIndex(r=>r.id===t);return-1!==e&&(r.products[e]={...r.products[e],...a.data}),(null==(c=r.selectedProduct)?void 0:c.id)===t&&(r.selectedProduct=a.data),!0}return r.error=a.error||"Failed to update product",!1}catch(a){return r.error=a instanceof Error?a.message:"Unexpected error occurred",!1}finally{r.updating=!1}},deleteProduct:async t=>{var e;r.deleting=!0,r.error=null;try{const c=await n.deleteProduct(t);if(c.success){const c=r.products.findIndex(r=>r.id===t);return-1!==c&&(r.products[c].is_active=!1),(null==(e=r.selectedProduct)?void 0:e.id)===t&&(r.selectedProduct=null),!0}return r.error=c.error||"Failed to delete product",!1}catch(c){return r.error=c instanceof Error?c.message:"Unexpected error occurred",!1}finally{r.deleting=!1}},assignProductToPrincipals:async(t,e)=>{r.updating=!0,r.error=null;try{const c=await n.assignProductToPrincipals(t,e);if(c.success&&c.data){const c=r.products.findIndex(r=>r.id===t);return-1!==c&&(r.products[c].principal_ids=e,r.products[c].principal_count=e.length),!0}return r.error=c.error||"Failed to assign product to principals",!1}catch(c){return r.error=c instanceof Error?c.message:"Unexpected error occurred",!1}finally{r.updating=!1}},searchProducts:async(t,e={})=>{r.loading=!0,r.error=null,r.searchTerm=t;try{const c=await n.searchProducts(t,e);c.success&&c.data?r.searchResults=c.data:r.error=c.error||"Failed to search products"}catch(c){r.error=c instanceof Error?c.message:"Unexpected error occurred"}finally{r.loading=!1}},fetchStats:async()=>{r.loading=!0,r.error=null;try{const t=await n.getProductStats();t.success&&t.data?r.stats=t.data:r.error=t.error||"Failed to fetch product statistics"}catch(t){r.error=t instanceof Error?t.message:"Unexpected error occurred"}finally{r.loading=!1}},performBulkOperation:async t=>{r.updating=!0,r.error=null,r.bulkOperationResult=null;try{const e=await n.performBulkOperation(t);return e.success&&e.data?(r.bulkOperationResult=e.data,e.data.success&&t.product_ids.forEach(e=>{var c;const a=r.products.findIndex(r=>r.id===e);if(-1!==a)switch(t.operation){case"activate":r.products[a].is_active=!0;break;case"deactivate":case"delete":r.products[a].is_active=!1;break;case"update_category":(null==(c=t.parameters)?void 0:c.category)&&(r.products[a].category=t.parameters.category)}}),e.data.success):(r.error=e.error||"Failed to perform bulk operation",!1)}catch(e){return r.error=e instanceof Error?e.message:"Unexpected error occurred",!1}finally{r.updating=!1}},clearError:()=>{r.error=null},clearSelectedProduct:()=>{r.selectedProduct=null},clearSearchResults:()=>{r.searchResults=[],r.searchTerm=""},clearBulkResults:()=>{r.bulkOperationResult=null},resetFilters:()=>{t.value={}},refresh:async()=>{await h()}}});export{o as u};
