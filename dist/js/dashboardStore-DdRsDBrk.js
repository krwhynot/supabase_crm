import{d as e}from"./pinia-CUC4VGP7.js";import{u as t}from"./opportunityStore-CiHSyBF9.js";import{u as r}from"./productStore-g1VeSLDp.js";import{u as a}from"./organizationStore-BI5YngbF.js";import{u as i}from"./principalStore-CYUOJ8eV.js";import{b as n,r as o,c as s,w as l}from"./vue-runtime-Ds28nt_E.js";const p=e("dashboard",()=>{function e(e){const t=(new Date).getMonth();return e.recentActivity.filter(e=>new Date(e.date).getMonth()===t).reduce((e,t)=>e+t.organizationsAdded,0)}function p(e){const t={};return e.statusDistribution.forEach(e=>{t[e.status]=e.count}),t}function u(e){return e.total_pipeline_value*(e.average_probability/100)}function c(e){return.25*e.total_pipeline_value}const d=t(),h=r(),m=a(),f=i(),y=n({kpis:null,performance:null,recentActivity:[],loading:!1,refreshing:!1,error:null,lastUpdated:null,lastRefresh:null,filters:{timeFilter:{period:"month"},organizationTypes:[],opportunityStages:[],productCategories:[],showInactiveItems:!1,refreshInterval:5},preferences:{sidebarCollapsed:!1,weekFilterEnabled:!1,autoRefresh:!0,theme:"light"},autoRefresh:!0,cacheExpiryMinutes:10,isDataStale:!1}),g=o(null),v=s(()=>{const t=d.kpis,r=h.stats,a=m.dashboardMetrics,i=f.stats;return t&&r&&a&&i?{totalOpportunities:t.total_opportunities,totalProducts:r.total_products,totalOrganizations:a.totalOrganizations,totalPrincipals:i.total_principals,activePipeline:t.active_opportunities,pipelineValue:t.total_pipeline_value,wonThisMonth:t.won_this_month,conversionRate:t.conversion_rate,averageDealSize:t.total_pipeline_value/Math.max(t.total_opportunities,1),monthlyGrowthRate:a.monthlyGrowth,newOpportunitiesThisWeek:t.created_this_week,newOrganizationsThisMonth:e(a),recentActivityCount:t.created_this_week+t.updated_this_week,averageLeadScore:a.averageLeadScore,averageDaysToClose:t.average_days_to_close,topPerformingCategory:r.most_common_category,mostActiveOrganizationType:(n=a,n.statusDistribution.length?n.statusDistribution.reduce((e,t)=>t.count>e.count?t:e).status:null),opportunityStageDistribution:t.stage_distribution,productCategoryDistribution:r.products_by_category,organizationStatusDistribution:p(a),principalProductDistribution:(o=i,o.top_organizations_by_principals.map(e=>({principalName:e.organization_name,productCount:Math.floor(10*Math.random())+1,opportunityCount:Math.floor(5*Math.random())+1})))}:null;var n,o}),w=s(()=>{const e=d.kpis,t=m.dashboardMetrics,r=f.stats;return e&&t&&r?{averageTimeToClose:e.average_days_to_close,averageResponseTime:2.5,dealsClosedThisMonth:e.won_this_month,opportunityConversionRate:e.conversion_rate,principalEngagementRate:(i=r,i.principals_with_opportunities/Math.max(i.total_principals,1)*100),productAdoptionRate:65.5,monthOverMonthGrowth:t.monthlyGrowth,quarterOverQuarterGrowth:12.3,yearOverYearGrowth:28.7,forecastedRevenue:(a=e,a.total_pipeline_value*(a.conversion_rate/100)),probabilityWeightedPipeline:u(e),expectedCloseThisQuarter:c(e)}:null;var a,i}),D=s(()=>{const e=[];return d.opportunities.slice(0,5).forEach(t=>{e.push({id:`opp-${t.id}`,type:"opportunity",action:"created",title:`New Opportunity: ${t.name}`,description:`${t.stage} - ${t.organization_name}`,timestamp:new Date(t.created_at),entityId:t.id,entityName:t.name,userName:t.deal_owner||void 0})}),m.organizations.slice(0,3).forEach(t=>{e.push({id:`org-${t.id}`,type:"organization",action:"created",title:`New Organization: ${t.name}`,description:`${t.type||"Unknown"} - ${t.industry||"Unknown Industry"}`,timestamp:new Date(t.created_at||new Date),entityId:t.id,entityName:t.name})}),e.sort((e,t)=>t.timestamp.getTime()-e.timestamp.getTime()).slice(0,20)}),b=s(()=>!!y.lastUpdated&&((new Date).getTime()-y.lastUpdated.getTime())/6e4<y.cacheExpiryMinutes),R=s(()=>d.loading||h.loading||("boolean"==typeof m.loading?m.loading:Object.values(m.loading).some(Boolean))||f.loading),T=async()=>{if(!y.refreshing){y.refreshing=!0,y.error=null;try{await Promise.all([d.fetchKPIs(),h.fetchStats(),m.fetchDashboardMetrics(),f.fetchStats()]),y.kpis=v.value,y.performance=w.value,y.recentActivity=D.value,y.lastRefresh=new Date,y.lastUpdated=new Date,y.isDataStale=!1}catch(e){y.error=e instanceof Error?e.message:"Failed to refresh dashboard data"}finally{y.refreshing=!1}}},C=e=>{y.filters={...y.filters,...e},y.isDataStale=!0,T()},M=e=>{y.autoRefresh=e,e?O():S()},O=()=>{S(),y.autoRefresh&&y.filters.refreshInterval>0&&(g.value=setInterval(()=>{y.refreshing||y.loading||T()},60*y.filters.refreshInterval*1e3))},S=()=>{g.value&&(clearInterval(g.value),g.value=null)};return l([()=>d.kpis,()=>h.stats,()=>m.dashboardMetrics,()=>f.stats],()=>{v.value&&(y.kpis=v.value,y.performance=w.value,y.recentActivity=D.value,y.lastUpdated=new Date)},{deep:!0}),l(b,e=>{y.isDataStale=!e}),y.autoRefresh&&O(),{kpis:s(()=>y.kpis),performance:s(()=>y.performance),recentActivity:s(()=>y.recentActivity),loading:s(()=>y.loading),refreshing:s(()=>y.refreshing),error:s(()=>y.error),lastUpdated:s(()=>y.lastUpdated),lastRefresh:s(()=>y.lastRefresh),filters:s(()=>y.filters),preferences:s(()=>y.preferences),autoRefresh:s(()=>y.autoRefresh),isDataStale:s(()=>y.isDataStale),isDataFresh:b,isAnyStoreLoading:R,aggregatedKPIs:v,performanceMetrics:w,recentActivityFeed:D,initializeDashboard:async()=>{if(!y.loading){y.loading=!0,y.error=null;try{await Promise.all([d.fetchOpportunities(),h.fetchProducts(),m.fetchOrganizations(),f.fetchPrincipals()]),await T()}catch(e){y.error=e instanceof Error?e.message:"Failed to initialize dashboard"}finally{y.loading=!1}}},refreshDashboard:T,updateFilters:C,updateTimeFilter:e=>{C({timeFilter:e})},updatePreferences:e=>{y.preferences={...y.preferences,...e},void 0!==e.autoRefresh&&(y.autoRefresh=e.autoRefresh,M(e.autoRefresh))},toggleAutoRefresh:M,exportDashboard:async(e="json")=>{const t={timestamp:(new Date).toISOString(),kpis:y.kpis,performance:y.performance,recentActivity:y.recentActivity,filters:y.filters};return"json"===e?JSON.stringify(t,null,2):["Metric,Value",`Total Opportunities,${y.kpis?.totalOpportunities||0}`,`Total Products,${y.kpis?.totalProducts||0}`,`Total Organizations,${y.kpis?.totalOrganizations||0}`,`Pipeline Value,${y.kpis?.pipelineValue||0}`,`Conversion Rate,${y.kpis?.conversionRate||0}`,`Monthly Growth,${y.kpis?.monthlyGrowthRate||0}`].join("\n")},resetDashboard:()=>{y.kpis=null,y.performance=null,y.recentActivity=[],y.error=null,y.lastUpdated=null,y.lastRefresh=null,y.isDataStale=!1,y.filters={timeFilter:{period:"month"},organizationTypes:[],opportunityStages:[],productCategories:[],showInactiveItems:!1,refreshInterval:5},y.preferences={sidebarCollapsed:!1,weekFilterEnabled:!1,autoRefresh:!0,theme:"light"},S()},startAutoRefresh:O,stopAutoRefresh:S}});export{p as u};
